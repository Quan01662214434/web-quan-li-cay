<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C√¢y s·∫ßu ri√™ng - Thanh Huy·ªÅn Farm</title>
    <link rel="stylesheet" href="public.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header class="ph-header">
      <div class="ph-brand">
        <div class="ph-logo">TH</div>
        <div>
          <div class="ph-name">Thanh Huy·ªÅn Farm</div>
          <div class="ph-sub">V∆∞·ªùn s·∫ßu ri√™ng h·ªØu c∆°</div>
        </div>
      </div>
    </header>

    <main class="ph-main">
      <section class="ph-card" id="info-card">
        <h2>üå≥ Th√¥ng tin c√¢y</h2>
        <img
          id="tree-image"
          class="ph-image hidden"
          alt="H√¨nh c√¢y s·∫ßu ri√™ng"
        />

        <p id="row-name">
          <b>T√™n c√¢y:</b> <span id="tree-name"></span>
        </p>
        <p id="row-species">
          <b>Gi·ªëng:</b> <span id="tree-species"></span>
        </p>
        <p id="row-area">
          <b>Khu v·ª±c:</b> <span id="tree-area"></span>
        </p>
        <p id="row-location">
          <b>V·ªã tr√≠:</b> <span id="tree-location"></span>
        </p>
        <p id="row-plantDate">
          <b>Ng√†y tr·ªìng:</b> <span id="tree-plantDate"></span>
        </p>
        <p id="row-health">
          <b>T√¨nh tr·∫°ng:</b> <span id="tree-health"></span>
        </p>
        <p id="row-notes">
          <b>Ghi ch√∫:</b> <span id="tree-notes"></span>
        </p>
        <p id="row-diseases">
          <b>B·ªánh:</b> <span id="tree-diseases"></span>
        </p>
        <p id="row-owner">
          <b>Ch·ªß v∆∞·ªùn:</b> <span id="tree-owner"></span>
        </p>
      </section>

      <section class="ph-card" id="yield-card">
        <h2>üìä NƒÉng su·∫•t theo nƒÉm</h2>
        <canvas id="yield-chart"></canvas>
      </section>
    </main>

    <footer class="ph-footer">
      üåø Thanh Huy·ªÅn Farm ‚Äì ƒê·ª©c Tr·ªçng, L√¢m ƒê·ªìng
    </footer>

    <script>
      const API_BASE = "";

      const path = window.location.pathname; // /public/3
      const numericId = path.split("/").pop();

      function setRowVisible(rowId, visible) {
        const el = document.getElementById(rowId);
        if (!el) return;
        el.style.display = visible ? "block" : "none";
      }

      async function loadTree() {
        try {
          const res = await fetch(`${API_BASE}/public/tree/${numericId}`);
          const data = await res.json();
          if (!res.ok || !data || data.error) {
            document.getElementById("info-card").innerHTML =
              "<p>‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin c√¢y.</p>";
            return;
          }

          const tree = data.tree || data;
          const cfg = data.displayConfig || {};

          const showName = cfg.showName !== false;
          const showSpecies = cfg.showSpecies !== false;
          const showArea = cfg.showArea !== false;
          const showLocation = cfg.showLocation !== false;
          const showPlantDate = cfg.showPlantDate !== false;
          const showImage = cfg.showImage !== false;
          const showHealth = cfg.showCurrentHealth !== false;
          const showNotes = cfg.showNotes !== false;
          const showDiseases = cfg.showDiseases !== false;
          const showYield = cfg.showYield !== false;
          const showOwnerName = cfg.showOwnerName !== false;

          // SET TEXT
          document.getElementById("tree-name").textContent = tree.name || "-";
          document.getElementById("tree-species").textContent =
            tree.species || "-";
          document.getElementById("tree-area").textContent =
            tree.area || "-";
          document.getElementById("tree-location").textContent =
            tree.location || "-";
          document.getElementById("tree-plantDate").textContent =
            tree.plantDate || "-";
          document.getElementById("tree-health").textContent =
            tree.currentHealth || "-";
          document.getElementById("tree-notes").textContent =
            tree.notes || "-";
          document.getElementById("tree-diseases").textContent =
            (tree.diseases || []).join(", ") || "-";
          document.getElementById("tree-owner").textContent =
            tree.owner?.farmName ||
            tree.owner?.username ||
            "Thanh Huy·ªÅn Farm";

          // ·∫¢nh
          const imgEl = document.getElementById("tree-image");
          if (tree.imageURL && showImage) {
            imgEl.src = tree.imageURL;
            imgEl.classList.remove("hidden");
          } else {
            imgEl.classList.add("hidden");
          }

          // ·∫®N/HI·ªÜN T·ª™NG D√íNG THEO CONFIG
          setRowVisible("row-name", showName);
          setRowVisible("row-species", showSpecies);
          setRowVisible("row-area", showArea);
          setRowVisible("row-location", showLocation);
          setRowVisible("row-plantDate", showPlantDate);
          setRowVisible("row-health", showHealth);
          setRowVisible("row-notes", showNotes);
          setRowVisible("row-diseases", showDiseases);
          setRowVisible("row-owner", showOwnerName);

          // NƒÇNG SU·∫§T
          if (!showYield) {
            document.getElementById("yield-card").style.display = "none";
          } else {
            const ctx = document
              .getElementById("yield-chart")
              .getContext("2d");
            const labels = (tree.yieldHistory || []).map((y) => y.year);
            const quantities = (tree.yieldHistory || []).map(
              (y) => y.quantity
            );
            if (!labels.length) {
              document.getElementById("yield-card").innerHTML =
                "<p>Ch∆∞a c√≥ d·ªØ li·ªáu nƒÉng su·∫•t.</p>";
            } else {
              new Chart(ctx, {
                type: "bar",
                data: {
                  labels,
                  datasets: [
                    {
                      label: "NƒÉng su·∫•t (kg)",
                      data: quantities,
                      backgroundColor: "#3fa34d",
                    },
                  ],
                },
                options: {
                  responsive: true,
                  scales: { y: { beginAtZero: true } },
                },
              });
            }
          }
        } catch (err) {
          console.error(err);
          document.getElementById("info-card").innerHTML =
            "<p>‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu c√¢y.</p>";
        }
      }

      loadTree();
    </script>
  </body>
</html>
