<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Th√¥ng tin c√¢y ‚Äì Thanh Huy·ªÅn Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="style.css" />
    <style>
      :root { color-scheme: light; }
      body { background: #f4f7f4; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #1f2933; }
      .public-container { max-width: 520px; margin: 16px auto 40px; padding: 0 16px; }
      .public-card { background:#fff; border-radius:14px; padding:16px 16px 18px; box-shadow:0 10px 28px rgba(15,94,35,.10); border:1px solid #e0ece1; }
      .public-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
      .public-logo { width:44px; height:44px; border-radius:50%; background:#fff; border:2px solid #2e7d32; display:flex; align-items:center; justify-content:center; font-weight:700; color:#2e7d32; }
      .public-title { display:flex; flex-direction:column; }
      .public-title h1 { font-size:18px; margin:0; }
      .public-title p { font-size:13px; margin:.25rem 0 0; color:#4b5563; }
      .vg-banner { margin:10px 0 12px; background:linear-gradient(135deg,#e4f9e7,#c8f0cf); border-radius:10px; padding:8px 10px; border:1px solid #a5d8a9; font-size:13px; color:#1f4b22; }
      .tree-img { width:100%; max-height:230px; object-fit:cover; border-radius:10px; margin:8px 0 12px; border:1px solid #e6efe7; }
      .tree-info { display:grid; gap:6px; }
      .row { font-size:13px; display:flex; gap:6px; flex-wrap:wrap; }
      .row b { font-weight:600; }
      .area-badge { display:inline-block; padding:2px 8px; border:1px solid #a5d8a9; background:#e9f7ec; border-radius:999px; font-size:12px; color:#1e4620; line-height:1.6; }
      .muted { color:#6b7280; font-size:12px; }
      .loading { text-align:center; margin:40px 0; color:#6b7280; font-size:14px; }
      .error { text-align:center; margin:40px 0; color:#b91c1c; font-size:14px; }

      /* N√∫t n·ªïi li√™n h·ªá */
      .floating-contact { position: fixed; right: 16px; bottom: 16px; display:flex; flex-direction:column; gap:8px; z-index:999; }
      .contact-btn { display:inline-flex; align-items:center; justify-content:center; min-width:46px; height:46px; border-radius:999px; font-size:12px; font-weight:600; color:#fff; text-decoration:none; box-shadow:0 4px 10px rgba(0,0,0,.25); padding:0 14px; }
      .zalo-btn { background:#008fe5; }
      .fb-btn { background:#1877f2; }

      @media (max-width: 540px){
        .public-container{ padding: 0 12px; }
      }
    </style>
  </head>
  <body>
    <div class="public-container">
      <div id="public-card" class="public-card">
        <div class="loading" id="loading">ƒêang t·∫£i th√¥ng tin c√¢y...</div>
      </div>
    </div>

    <!-- N√∫t n·ªïi li√™n h·ªá -->
    <div class="floating-contact">
      <a href="https://zalo.me/0906325133" class="contact-btn zalo-btn" target="_blank" rel="noopener">Zalo</a>
      <a href="https://facebook.com/ThanhHuyenFarm" class="contact-btn fb-btn" target="_blank" rel="noopener">FB</a>
    </div>

    <script>
      // Ch·ªçn API_BASE t·ª± ƒë·ªông theo host
      let API_BASE = "";
      if (location.hostname === "thefram.site") {
        API_BASE = "https://web-quan-li-cay.onrender.com";
      } else if (location.hostname.includes("localhost")) {
        API_BASE = "http://localhost:4000";
      } else {
        API_BASE = "https://web-quan-li-cay.onrender.com";
      }

      // ===== Helpers =====
      const $ = (id) => document.getElementById(id);
      const el = (tag, className, text) => {
        const n = document.createElement(tag);
        if (className) n.className = className;
        if (text != null) n.textContent = String(text);
        return n;
      };
      const row = (label, value) => {
        const r = el("div", "row");
        const b = el("b", null, label);
        const s = el("span", null, value);
        r.append(b, s);
        return r;
      };
      const rowFragment = (label, node) => {
        const r = el("div", "row");
        const b = el("b", null, label);
        r.append(b, node);
        return r;
      };
      const formatDateVN = (s) => {
        if (!s) return "";
        const d = new Date(s);
        return isNaN(d) ? "" : d.toLocaleDateString("vi-VN");
      };

      function getTreeIdFromUrl() {
        const params = new URLSearchParams(location.search);
        return params.get("treeId");
      }

      async function loadPublicTree() {
        const treeId = getTreeIdFromUrl();
        const card = $("public-card");
        const loading = $("loading");

        if (!treeId) {
          card.innerHTML = "";
          card.append(el("div", "error", "Thi·∫øu tham s·ªë treeId."));
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/public/tree/${encodeURIComponent(treeId)}`);
          const payload = await res.json();
          if (!res.ok) throw new Error(payload?.error || "Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu");

          const { tree, displayConfig, farmName, farmVietGapCode } = payload;
          const cfg = displayConfig || {};
          card.innerHTML = "";

          // Header
          const header = el("div", "public-header");
          const logo = el("div", "public-logo", "TH");
          const title = el("div", "public-title");
          title.append(el("h1", null, farmName || "Thanh Huy·ªÅn Farm"));
          title.append(el("p", null, "V∆∞·ªùn s·∫ßu ri√™ng h·ªØu c∆° ‚Äì th√¥ng tin c√¢y"));
          header.append(logo, title);
          card.append(header);

          // VietGAP banner
          if (farmVietGapCode && cfg.showVietGap !== false) {
            const vg = el("div", "vg-banner");
            vg.append(el("span", null, "üåø V∆∞·ªùn ƒë·∫°t chu·∫©n VietGAP ‚Ä¢ M√£ s·ªë: "));
            const b = el("b", null, farmVietGapCode);
            vg.append(b);
            card.append(vg);
          }

          // ·∫¢nh
          if (cfg.showImage !== false && tree.imageURL) {
            const img = el("img", "tree-img");
            img.alt = "·∫¢nh c√¢y";
            img.src = tree.imageURL;
            img.referrerPolicy = "no-referrer";
            card.append(img);
          }

          // Th√¥ng tin
          const info = el("div", "tree-info");

          if (cfg.showName !== false && tree.name) {
            info.append(row("T√™n c√¢y:", tree.name));
          }
          if (cfg.showSpecies !== false && tree.species) {
            info.append(row("Gi·ªëng:", tree.species));
          }

          if ((cfg.showArea !== false && tree.area) || (cfg.showLocation !== false && tree.location)) {
            const r = el("div", "row");
            if (cfg.showArea !== false && tree.area) {
              r.append(el("b", null, "Khu v·ª±c:"));
              r.append(el("span", null, " " + tree.area + " "));
            }
            if (cfg.showLocation !== false && tree.location) {
              if (tree.area) r.append(el("span", "muted", "‚Ä¢"));
              const spacer = el("span", null, " ");
              r.append(spacer);
              r.append(el("b", null, "V·ªã tr√≠:"));
              r.append(el("span", null, " " + tree.location));
            }
            info.append(r);
          }

          // Di·ªán t√≠ch (chu·ªói 'acreage' theo schema server)
          if (cfg.showAcreage !== false && tree.acreage && String(tree.acreage).trim() !== "") {
            const badge = el("span", "area-badge", String(tree.acreage).trim());
            info.append(rowFragment("Di·ªán t√≠ch:", badge));
          }

          if (cfg.showPlantDate !== false && tree.plantDate) {
            info.append(row("Ng√†y tr·ªìng:", formatDateVN(tree.plantDate)));
          }

          if (cfg.showCurrentHealth !== false && tree.currentHealth) {
            info.append(row("T√¨nh tr·∫°ng:", tree.currentHealth));
          }

          if (cfg.showNotes !== false && tree.notes) {
            info.append(row("Ghi ch√∫:", tree.notes));
          }

          if (cfg.showDiseases !== false && Array.isArray(tree.diseases) && tree.diseases.length) {
            info.append(row("B·ªánh:", tree.diseases.join(", ")));
          }

          if (cfg.showYield !== false && Array.isArray(tree.yieldHistory) && tree.yieldHistory.length) {
            const sorted = [...tree.yieldHistory].sort((a, b) => Number(a.year) - Number(b.year));
            const text = sorted.map(y => `${y.year}: ${y.quantity}kg`).join(" ‚Ä¢ ");
            info.append(row("NƒÉng su·∫•t:", text));
          }

          if (cfg.showOwnerName !== false) {
            info.append(row("Thu·ªôc v∆∞·ªùn:", farmName || "Thanh Huy·ªÅn Farm"));
          }

          // ID & ghi ch√∫ ph·ª•
          const meta = el("div", "muted");
          const idText = `M√£ c√¢y: #${tree.numericId ?? "‚Äî"}`;
          meta.textContent = idText;
          info.append(meta);

          card.append(info);

        } catch (e) {
          console.error(e);
          card.innerHTML = "";
          card.append(el("div", "error", "Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin c√¢y. Vui l√≤ng th·ª≠ l·∫°i sau."));
        }
      }

      document.addEventListener("DOMContentLoaded", loadPublicTree);
    </script>
  </body>
</html>
