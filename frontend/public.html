<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Th√¥ng tin c√¢y ‚Äì Farm Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2e7d32" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="public-wrap">
    <div id="root" class="card">
      <div class="empty-state">
        <h3>ƒêang t·∫£i th√¥ng tin c√¢y‚Ä¶</h3>
        <p>Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
      </div>
    </div>
  </div>

  <!-- Floating contact -->
  <div class="floating-contact">
    <a href="https://zalo.me/0938213219" class="contact-btn zalo-btn" target="_blank">Zalo</a>
    <a href="https://facebook.com/ThanhHuyenFarm" class="contact-btn fb-btn" target="_blank">FB</a>
  </div>

<script>
/* ===============================
   CONFIG ‚Äì KH√îNG ƒê·ªîI QR
   =============================== */
const API_BASE = location.hostname.includes("localhost")
  ? "http://localhost:4000"
  : "https://api.thefram.site";

const $ = s => document.querySelector(s);
const esc = s => String(s ?? "")
  .replace(/&/g,"&amp;").replace(/</g,"&lt;")
  .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
  .replace(/'/g,"&#039;");

const getTreeId = () => new URLSearchParams(location.search).get("treeId");
const fmtDate = d => d ? new Date(d).toLocaleDateString("vi-VN") : "";
const fmtDateTime = d => d ? new Date(d).toLocaleString("vi-VN") : "";

/* ===============================
   STATUS COLOR
   =============================== */
function statusClass(s){
  const v = String(s || "").toLowerCase();
  if (v.includes("b·ªánh")) return "health-bad";
  if (v.includes("c·∫ßn")) return "health-warn";
  return "health-good";
}

/* ===============================
   MAIN
   =============================== */
async function main(){
  const treeId = getTreeId();
  if (!treeId) {
    $("#root").innerHTML = `
      <div class="empty-state">
        <h3>Thi·∫øu m√£ c√¢y</h3>
        <p>QR kh√¥ng h·ª£p l·ªá</p>
      </div>`;
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/public/tree/${treeId}`);
    const data = await res.json();

    if (!data.tree) throw new Error("No tree");

    const { tree, farmName, farmVietGapCode, farmAddress, displayConfig = {} } = data;

    let html = `
      <div class="page-head">
        <h1>${esc(farmName || "Farm Manager")}</h1>
        <p>C·∫≠p nh·∫≠t: ${fmtDateTime(tree.updatedAt || tree.createdAt)}</p>
      </div>

      <div class="card">
        ${
          tree.imageURL
            ? `<img src="${esc(tree.imageURL)}" style="width:100%;border-radius:12px;max-height:320px;object-fit:cover" />`
            : `<div class="empty-state"><p>Ch∆∞a c√≥ ·∫£nh c√¢y</p></div>`
        }
      </div>

      ${
        farmVietGapCode
          ? `<div class="card" style="background:#e8f5ea">
              üåø <b>VietGAP</b><br/>
              M√£ s·ªë: <b>${esc(farmVietGapCode)}</b>
            </div>`
          : ""
      }

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-info">
            <div class="stat-label">T√™n c√¢y</div>
            <div class="stat-value">${esc(tree.name || "-")}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-info">
            <div class="stat-label">Gi·ªëng</div>
            <div class="stat-value">${esc(tree.species || "-")}</div>
          </div>
        </div>

        <div class="stat-card ${statusClass(tree.currentHealth)}">
          <div class="stat-info">
            <div class="stat-label">T√¨nh tr·∫°ng</div>
            <div class="stat-value">${esc(tree.currentHealth || "Ch∆∞a c·∫≠p nh·∫≠t")}</div>
          </div>
        </div>
      </div>

      <div class="card">
        <b>üìç Khu v·ª±c</b><br/>
        ${esc(tree.area || "-")} ${esc(tree.location || "")}
      </div>

      ${
        tree.notes
          ? `<div class="card"><b>üìù Ghi ch√∫</b><br/>${esc(tree.notes)}</div>`
          : ""
      }

      ${
        Array.isArray(tree.diseases) && tree.diseases.length
          ? `<div class="card">
              <b>üß™ B·ªánh / v·∫•n ƒë·ªÅ</b><br/>
              ${tree.diseases.map(d => `<span class="tree-health-badge health-warn">${esc(d)}</span>`).join(" ")}
            </div>`
          : ""
      }

      <div class="card">
        <b>üè° ƒê·ªãa ch·ªâ v∆∞·ªùn</b><br/>
        ${esc(farmAddress || "-")}
      </div>
    `;

    if (Array.isArray(tree.yieldHistory) && tree.yieldHistory.length) {
      html += `
        <div class="card">
          <b>üìä NƒÉng su·∫•t (kg)</b>
          <canvas id="yieldChart" height="180"></canvas>
        </div>
      `;
    }

    $("#root").innerHTML = html;

    if (tree.yieldHistory?.length) {
      const sorted = [...tree.yieldHistory].sort((a,b)=>a.year-b.year);
      new Chart(document.getElementById("yieldChart"), {
        type: "bar",
        data: {
          labels: sorted.map(x=>x.year),
          datasets: [{ data: sorted.map(x=>x.quantity || 0) }]
        },
        options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

  } catch (e) {
    $("#root").innerHTML = `
      <div class="empty-state">
        <h3>L·ªói t·∫£i d·ªØ li·ªáu</h3>
        <p>Vui l√≤ng th·ª≠ l·∫°i sau</p>
      </div>`;
  }
}

document.addEventListener("DOMContentLoaded", main);
</script>

</body>
</html>
