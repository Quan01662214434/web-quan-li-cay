<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Th√¥ng tin c√¢y ‚Äì Thanh Huy·ªÅn Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        background: #f4f7f4;
      }
      .public-container {
        max-width: 480px;
        margin: 16px auto 32px;
        padding: 0 16px;
      }
      .public-card {
        background: #ffffff;
        border-radius: 14px;
        padding: 16px 16px 18px;
        box-shadow: 0 8px 24px rgba(15, 94, 35, 0.08);
        border: 1px solid #e0ece1;
      }
      .public-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }
      .public-header-logo {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #ffffff;
        border: 2px solid #2e7d32;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #2e7d32;
      }
      .public-header-text h1 {
        font-size: 18px;
        margin: 0;
      }
      .public-header-text p {
        font-size: 13px;
        margin: 2px 0 0;
        color: #4b5563;
      }
      .vg-banner {
        margin: 10px 0 12px;
        background: linear-gradient(135deg, #e4f9e7, #c8f0cf);
        border-radius: 10px;
        padding: 8px 10px;
        border: 1px solid #a5d8a9;
        font-size: 13px;
        color: #1f4b22;
      }
      .vg-banner b {
        font-weight: 700;
      }
      .tree-img {
        width: 100%;
        max-height: 220px;
        object-fit: cover;
        border-radius: 10px;
        margin: 8px 0 10px;
      }
      .tree-info p {
        margin: 4px 0;
        font-size: 13px;
      }
      .tree-info b {
        font-weight: 600;
      }

      .farm-contact {
        background: linear-gradient(180deg, #eaf9ef, #d3f0d8);
        border-top: 1px solid #b7e3be;
        padding: 12px 12px 10px;
        border-radius: 10px;
        margin-top: 16px;
        font-size: 13px;
        color: #1e4620;
      }
      .farm-contact h3 {
        font-size: 14px;
        margin: 0 0 6px;
        color: #14531e;
      }
      .farm-contact p {
        margin: 3px 0;
      }
      .farm-contact a {
        color: #207b2f;
        text-decoration: none;
      }
      .farm-contact a:hover {
        text-decoration: underline;
      }
      .loading {
        text-align: center;
        margin-top: 40px;
        color: #6b7280;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="public-container">
      <div id="public-content" class="public-card">
        <div class="loading">ƒêang t·∫£i th√¥ng tin c√¢y...</div>
      </div>
    </div>

    <!-- N√∫t n·ªïi li√™n h·ªá -->
    <div class="floating-contact">
      <a
        href="https://zalo.me/0906325133"
        class="contact-btn zalo-btn"
        target="_blank"
        rel="noopener"
      >
        Zalo
      </a>
      <a
        href="https://facebook.com/ThanhHuyenFarm"
        class="contact-btn fb-btn"
        target="_blank"
        rel="noopener"
      >
        FB
      </a>
    </div>

    <script>
      // ‚úÖ X√°c ƒë·ªãnh API_BASE t·ª± ƒë·ªông theo m√¥i tr∆∞·ªùng
      let API_BASE = "";

      if (window.location.hostname === "thefram.site") {
        // N·∫øu ch·∫°y th·∫≠t tr√™n domain ch√≠nh
        API_BASE = "https://web-quan-li-cay.onrender.com"; // üëâ ƒê·ªïi th√†nh URL backend th·∫≠t c·ªßa anh
      } else if (window.location.hostname.includes("localhost")) {
        // N·∫øu ƒëang test local
        API_BASE = "http://localhost:4000";
      } else {
        // N·∫øu ƒëang ch·∫°y ·ªü m√¥i tr∆∞·ªùng kh√°c (subdomain / staging)
        API_BASE = "https://web-quan-li-cay.onrender.com";
      }

      console.log("üîó API_BASE ƒëang d√πng:", API_BASE);

      function getTreeIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("treeId");
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleDateString("vi-VN");
      }

      async function loadPublicTree() {
        const treeId = getTreeIdFromUrl();
        const container = document.getElementById("public-content");

        if (!treeId) {
          container.innerHTML =
            "<p>Kh√¥ng t√¨m th·∫•y c√¢y (thi·∫øu tham s·ªë treeId).</p>";
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/public/tree/${treeId}`);
          const data = await res.json();

          if (!res.ok) {
            container.innerHTML =
              "<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin c√¢y. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
            return;
          }

          const { tree, displayConfig, farmName, farmVietGapCode } = data;
          const cfg = displayConfig || {};

          let html = `
            <div class="public-header">
              <div class="public-header-logo">TH</div>
              <div class="public-header-text">
                <h1>${farmName || "Thanh Huy·ªÅn Farm"}</h1>
                <p>V∆∞·ªùn s·∫ßu ri√™ng h·ªØu c∆° ‚Äì th√¥ng tin c√¢y</p>
              </div>
            </div>
          `;

          if (farmVietGapCode && cfg.showVietGap !== false) {
            html += `
              <div class="vg-banner">
                üåø <b>V∆∞·ªùn ƒë·∫°t chu·∫©n VietGAP</b><br/>
                M√£ s·ªë: <b>${farmVietGapCode}</b>
              </div>
            `;
          }

          html += `<div class="tree-info">`;

          if (cfg.showImage !== false && tree.imageURL) {
            html += `<img class="tree-img" src="${tree.imageURL}" alt="·∫¢nh c√¢y" />`;
          }

          if (cfg.showName !== false) {
            html += `<p><b>T√™n c√¢y:</b> ${tree.name}</p>`;
          }

          if (cfg.showSpecies !== false && tree.species) {
            html += `<p><b>Gi·ªëng:</b> ${tree.species}</p>`;
          }

          if (cfg.showArea !== false || cfg.showLocation !== false) {
            html += `<p>`;
            if (cfg.showArea !== false && tree.area) {
              html += `<b>Khu v·ª±c:</b> ${tree.area}`;
            }
            if (cfg.showLocation !== false && tree.location) {
              if (tree.area) html += " ‚Ä¢ ";
              html += `<b>V·ªã tr√≠:</b> ${tree.location}`;
            }
            html += `</p>`;
          }

          if (cfg.showPlantDate !== false && tree.plantDate) {
            html += `<p><b>Ng√†y tr·ªìng:</b> ${formatDate(tree.plantDate)}</p>`;
          }

          if (cfg.showCurrentHealth !== false && tree.currentHealth) {
            html += `<p><b>T√¨nh tr·∫°ng:</b> ${tree.currentHealth}</p>`;
          }

          if (cfg.showNotes !== false && tree.notes) {
            html += `<p><b>Ghi ch√∫:</b> ${tree.notes}</p>`;
          }

          if (cfg.showDiseases !== false && tree.diseases && tree.diseases.length) {
            html += `<p><b>B·ªánh:</b> ${tree.diseases.join(", ")}</p>`;
          }

          if (
            cfg.showYield !== false &&
            tree.yieldHistory &&
            tree.yieldHistory.length
          ) {
            const sorted = [...tree.yieldHistory].sort(
              (a, b) => a.year - b.year
            );
            const text = sorted
              .map((y) => `${y.year}: ${y.quantity}kg`)
              .join(" ‚Ä¢ ");
            html += `<p><b>NƒÉng su·∫•t:</b> ${text}</p>`;
          }

          if (cfg.showOwnerName !== false) {
            html += `<p><b>Thu·ªôc v∆∞·ªùn:</b> ${
              farmName || "Thanh Huy·ªÅn Farm"
            }</p>`;
          }

          html += `</div>`;

          html += `
            <div class="farm-contact">
              <h3>üìû Li√™n h·ªá ch·ªß v∆∞·ªùn ‚Äì Thanh Huy·ªÅn Farm</h3>
              <p><b>ƒêi·ªán tho·∫°i / Zalo:</b> <a href="tel:0906325133">0906 325 133</a></p>
              <p><b>Facebook:</b> <a href="https://facebook.com/ThanhHuyenFarm" target="_blank">Fanpage Thanh Huy·ªÅn Farm</a></p>
              <p><b>ƒê·ªãa ch·ªâ:</b> X√£ Ph√∫ Vinh, T·ªânh ƒê·ªìng Nai </p>
            </div>
          `;

          container.innerHTML = html;
        } catch (err) {
          console.error(err);
          container.innerHTML =
            "<p>ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
        }
      }

      document.addEventListener("DOMContentLoaded", loadPublicTree);
    </script>
  </body>
</html>
