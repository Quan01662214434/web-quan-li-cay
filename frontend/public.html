<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Th√¥ng tin c√¢y ‚Äì Thanh Huy·ªÅn Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="theme-color" content="#2e7d32" />
    <style>
      body { background: #f4f7f4; }
      .public-wrap { max-width: 720px; margin: 18px auto 28px; padding: 0 16px; }
      .card { background: #fff; border-radius: 16px; padding: 16px; border: 1px solid #e0ece1; box-shadow: 0 10px 28px rgba(15,94,35,.10); }
      .head { display: grid; grid-template-columns: 72px 1fr auto; gap: 12px; align-items: center; }
      .logo { width: 56px; height: 56px; border-radius: 50%; background: #fff; border: 2px solid #2e7d32; display: grid; place-items: center; color: #2e7d32; font-weight: 800; }
      .title h1 { margin: 0; font-size: 18px; }
      .title p { margin: 4px 0 0; font-size: 13px; color: #4b5563; }
      .updated-at { font-size: 12px; color: #6b7280; text-align: right; }
      .hero { margin: 12px 0 14px; border-radius: 14px; overflow: hidden; position: relative; background: #eaf4ec; min-height: 180px; display: grid; place-items: center; }
      .hero img { width: 100%; max-height: 320px; object-fit: cover; display: block; }
      .placeholder { width: 100%; height: 220px; display: grid; place-items: center; color: #2e7d32; background: repeating-linear-gradient(45deg,#e8f6eb,#e8f6eb 10px,#f5fbf6 10px,#f5fbf6 20px); font-weight: 600; }
      .vg { margin: 10px 0 12px; background: linear-gradient(135deg,#e4f9e7,#c8f0cf); border: 1px solid #a5d8a9; border-radius: 12px; padding: 10px 12px; color: #1f4b22; display: flex; align-items: center; gap: 10px; font-size: 13px; }
      .vg-icon { font-size: 18px; }
      .summary { display: grid; gap: 10px; margin: 10px 0 4px; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); }
      .kv { background: #f9fbf9; border: 1px solid #e2efe4; border-radius: 10px; padding: 10px 12px; font-size: 13px; }
      .kv b { display: block; color: #1f2933; margin-bottom: 4px; }
      .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; border: 1px solid transparent; }
      .st-normal { background: #e7f6ec; color: #1b5e20; border-color: #c9ebd2; }
      .st-care   { background: #fff4e5; color: #9a5b00; border-color: #ffe2b7; }
      .st-sick   { background: #fde8e8; color: #b42318; border-color: #fecaca; }
      .st-other  { background: #eef2ff; color: #3730a3; border-color: #c7d2fe; }
      .chips { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; background: #eef7ff; border: 1px solid #dbeafe; color: #1e3a8a; font-size: 12px; }
      .section-title { margin: 14px 0 8px; font-size: 15px; font-weight: 700; }
      .desc p { margin: 6px 0; font-size: 13px; }
      .yield-card { margin-top: 8px; }
      .yield-canvas-wrap { padding: 8px; background: #f9fbf9; border: 1px solid #e2efe4; border-radius: 12px; }
      .center-muted { text-align: center; color: #6b7280; font-size: 14px; padding: 18px 0; }
      /* Floating cho ƒë·ªôc l·∫≠p */
      .floating-contact { position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
      .contact-btn { display: inline-flex; align-items: center; justify-content: center; min-width: 46px; height: 46px; border-radius: 999px; font-size: 12px; font-weight: 600; color: #fff; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,.25); padding: 0 14px; }
      .zalo-btn { background: #008fe5; } .fb-btn { background: #1877f2; }
      .area-badge { display:inline-block; padding:2px 8px; border:1px solid #a5d8a9; background:#e9f7ec; border-radius:999px; font-size:12px; color:#1e4620; line-height:1.6; }
    </style>
  </head>
  <body>
    <div class="public-wrap">
      <div id="root" class="card">
        <div class="center-muted">ƒêang t·∫£i th√¥ng tin c√¢y...</div>
      </div>
    </div>

    <!-- Li√™n h·ªá n·ªïi -->
    <div class="floating-contact">
      <a href="https://zalo.me/0906325133" class="contact-btn zalo-btn" target="_blank" rel="noopener">Zalo</a>
      <a href="https://facebook.com/ThanhHuyenFarm" class="contact-btn fb-btn" target="_blank" rel="noopener">FB</a>
    </div>

    <script>
      // ===== C·∫•u h√¨nh =====
      const API_BASE = window.location.hostname.includes("localhost")
        ? "http://localhost:4000"
        : "https://api.thefram.site";
      const FARM_ADDRESS_FALLBACK = "·∫§p Su·ªëi Soong, X√£ Ph√∫ Vinh, T·ªânh ƒê·ªìng Nai";

      const $ = (sel) => document.querySelector(sel);
      const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
      const getTreeId = () => new URLSearchParams(location.search).get("treeId");
      const fmtDate = (d) => { if (!d) return ""; const x = new Date(d); return isNaN(x) ? "" : x.toLocaleDateString("vi-VN"); };
      const fmtDateTime = (d) => { if (!d) return ""; const x = new Date(d); return isNaN(x) ? "" : x.toLocaleString("vi-VN"); };

      function statusClass(s){
        const v = String(s || "").toLowerCase();
        if (v.includes("b·ªánh")) return "st-sick";
        if (v.includes("c·∫ßn"))  return "st-care";
        if (v.includes("b√¨nh")) return "st-normal";
        return "st-other";
      }

      function renderSkeleton(){
        $("#root").innerHTML = `
          <div class="head">
            <div class="logo">TH</div>
            <div class="title">
              <div style="height:18px;width:180px;background:#eaeff1;border-radius:8px;"></div>
              <div style="height:12px;width:220px;background:#eaeff1;border-radius:8px;margin-top:6px;"></div>
            </div>
            <div class="updated-at"><span style="height:12px;width:120px;display:inline-block;background:#eaeff1;border-radius:8px;"></span></div>
          </div>
          <div class="hero"><div style="height:220px;width:100%;background:#eaeff1;border-radius:12px;"></div></div>
          <div class="vg"><span style="height:14px;width:60%;display:inline-block;background:#eaeff1;border-radius:8px;"></span></div>
          <div class="summary">
            <div class="kv"><div style="height:12px;width:40%;background:#eaeff1;border-radius:8px;"></div><div style="height:14px;background:#eaeff1;border-radius:8px;margin-top:8px;"></div></div>
            <div class="kv"><div style="height:12px;width:40%;background:#eaeff1;border-radius:8px;"></div><div style="height:14px;background:#eaeff1;border-radius:8px;margin-top:8px;"></div></div>
            <div class="kv"><div style="height:12px;width:40%;background:#eaeff1;border-radius:8px;"></div><div style="height:14px;background:#eaeff1;border-radius:8px;margin-top:8px;"></div></div>
          </div>
        `;
      }

      async function main(){
        renderSkeleton();

        const treeId = getTreeId();
        if (!treeId){ $("#root").innerHTML = `<div class="center-muted">Thi·∫øu tham s·ªë <b>treeId</b>.</div>`; return; }

        try{
          const res = await fetch(`${API_BASE}/public/tree/${treeId}`);
          const payload = await res.json();
          if (!res.ok){ $("#root").innerHTML = `<div class="center-muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</div>`; return; }

          const { tree, displayConfig, farmName, farmVietGapCode, farmAddress } = payload;
          const cfg = displayConfig || {};
          const addr = (farmAddress && String(farmAddress).trim()) || FARM_ADDRESS_FALLBACK;

          // acreage: chu·ªói ∆∞u ti√™n; v·∫´n h·ªó tr·ª£ s·ªë c≈©
          let acreageText = "";
          const rawAcreage = tree.acreage ?? tree.areaHa ?? tree.areaHA ?? tree.area_ha;
          if (rawAcreage !== undefined && rawAcreage !== null && rawAcreage !== ""){
            if (typeof rawAcreage === "number"){
              const n = Number(rawAcreage).toFixed(2).replace(/\.?0+$/,"");
              acreageText = n ? `${n} ha` : "";
            } else {
              acreageText = String(rawAcreage);
            }
          }

          const updatedAt = tree.updatedAt || tree.createdAt;

          // Build UI
          let html = `
            <div class="head">
              <div class="logo">TH</div>
              <div class="title">
                <h1>${esc(farmName || "Thanh Huy·ªÅn Farm")}</h1>
                <p>V∆∞·ªùn s·∫ßu ri√™ng h·ªØu c∆° ‚Äì th√¥ng tin c√¢y</p>
              </div>
              <div class="updated-at">${updatedAt ? `C·∫≠p nh·∫≠t: ${esc(fmtDateTime(updatedAt))}` : ""}</div>
            </div>
          `;

          // ·∫¢nh
          html += `<div class="hero">`;
          if (cfg.showImage !== false && tree.imageURL){
            html += `<img src="${esc(tree.imageURL)}" alt="·∫¢nh c√¢y" />`;
          } else {
            html += `<div class="placeholder">Kh√¥ng c√≥ ·∫£nh c√¢y</div>`;
          }
          html += `</div>`;

          // VietGAP
          if (farmVietGapCode && cfg.showVietGap !== false){
            html += `
              <div class="vg">
                <div class="vg-icon">üåø</div>
                <div><b>V∆∞·ªùn ƒë·∫°t chu·∫©n VietGAP</b><br/>M√£ s·ªë: <b>${esc(farmVietGapCode)}</b></div>
              </div>
            `;
          }

          // Summary grid
          html += `<div class="summary">`;
          if (cfg.showName !== false && tree.name){ html += `<div class="kv"><b>T√™n c√¢y</b><div>${esc(tree.name)}</div></div>`; }
          if (cfg.showSpecies !== false && tree.species){ html += `<div class="kv"><b>Gi·ªëng</b><div>${esc(tree.species)}</div></div>`; }
          if (cfg.showArea !== false && tree.area){ html += `<div class="kv"><b>Khu v·ª±c</b><div>${esc(tree.area)}</div></div>`; }
          if (cfg.showLocation !== false && tree.location){ html += `<div class="kv"><b>V·ªã tr√≠</b><div>${esc(tree.location)}</div></div>`; }
          if (cfg.showAcreage !== false && acreageText){ html += `<div class="kv"><b>Di·ªán t√≠ch</b><div><span class="area-badge">${esc(acreageText)}</span></div></div>`; }
          if (cfg.showPlantDate !== false && tree.plantDate){ html += `<div class="kv"><b>Ng√†y tr·ªìng</b><div>${esc(fmtDate(tree.plantDate))}</div></div>`; }
          if (cfg.showOwnerName !== false){ html += `<div class="kv"><b>ƒê·ªãa ch·ªâ</b><div>${esc(addr)}</div></div>`; }
          html += `</div>`;

          if (cfg.showCurrentHealth !== false && tree.currentHealth){
            html += `<div class="section-title">T√¨nh tr·∫°ng</div>`;
            html += `<div class="status-pill ${statusClass(tree.currentHealth)}">ü©∫ ${esc(tree.currentHealth)}</div>`;
          }

          if (cfg.showNotes !== false && tree.notes){
            html += `<div class="section-title">Ghi ch√∫</div><div class="desc"><p>${esc(tree.notes)}</p></div>`;
          }

          if (cfg.showDiseases !== false && Array.isArray(tree.diseases) && tree.diseases.length){
            html += `<div class="section-title">B·ªánh &amp; v·∫•n ƒë·ªÅ</div><div class="chips">`;
            for (const d of tree.diseases){ html += `<span class="chip">üß™ ${esc(d)}</span>`; }
            html += `</div>`;
          }

          // Tr∆∞·ªùng tu·ª≥ bi·∫øn
          if (Array.isArray(tree.extraFields) && tree.extraFields.some(f => f && f.showPublic && (f.value ?? "") !== "")){
            html += `<div class="section-title">Th√¥ng tin th√™m</div><div class="summary">`;
            tree.extraFields
              .filter(f => f && f.showPublic && (f.value ?? "") !== "")
              .forEach(f => {
                const label = f.label || f.key || "Th√¥ng tin";
                html += `<div class="kv"><b>${esc(label)}</b><div>${esc(f.value)}</div></div>`;
              });
            html += `</div>`;
          }

          // NƒÉng su·∫•t
          const hasYield = (cfg.showYield !== false) && Array.isArray(tree.yieldHistory) && tree.yieldHistory.length;
          if (hasYield){
            html += `<div class="section-title">NƒÉng su·∫•t (kg)</div>
              <div class="yield-card"><div class="yield-canvas-wrap">
                <canvas id="yieldChart" height="160"></canvas>
              </div></div>`;
          }

          // Li√™n h·ªá
          html += `
            <div class="section-title" style="margin-top:16px;">Li√™n h·ªá</div>
            <div class="kv">
              <div><b>ƒêi·ªán tho·∫°i / Zalo</b></div>
              <div><a href="tel:0906325133">0906 325 133</a></div>
            </div>
            <div class="kv" style="margin-top:8px;">
              <div><b>Facebook</b></div>
              <div><a href="https://facebook.com/ThanhHuyenFarm" target="_blank" rel="noopener">Fanpage Thanh Huy·ªÅn Farm</a></div>
            </div>
            <div class="kv" style="margin-top:8px;">
              <div><b>ƒê·ªãa ch·ªâ</b></div>
              <div>${esc(addr)}</div>
            </div>
          `;

          $("#root").innerHTML = html;

          if (hasYield && window.Chart){
            const sorted = [...tree.yieldHistory].sort((a,b) => a.year - b.year);
            const labels = sorted.map(x => String(x.year));
            const data   = sorted.map(x => Number(x.quantity) || 0);
            const ctx = document.getElementById("yieldChart").getContext("2d");
            new Chart(ctx, {
              type: "bar",
              data: { labels, datasets: [{ label: "kg", data }] },
              options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
          }
        } catch (e){
          console.error(e);
          $("#root").innerHTML = `<div class="center-muted">C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</div>`;
        }
      }

      document.addEventListener("DOMContentLoaded", main);
    </script>
  </body>
</html>
