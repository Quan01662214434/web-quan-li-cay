<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh Huyá»n Farm ğŸŒ¿</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- HEADER -->
    <header class="topbar">
      <div class="logo-area">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 512 512"
          class="logo-icon"
        >
          <circle cx="256" cy="256" r="240" fill="#16a34a" />
          <path
            d="M256 128c-64 48-80 144 0 240 80-96 64-192 0-240z"
            fill="#bbf7d0"
          />
        </svg>
        <div class="logo-text">
          <div class="farm-name">THANH HUYá»€N FARM</div>
          <div class="farm-sub">
            VÆ°á»n sáº§u riÃªng há»¯u cÆ¡ â€“ Äá»©c Trá»ng, LÃ¢m Äá»“ng
          </div>
        </div>
      </div>
      <button id="logout-btn" class="btn-primary small hidden">ÄÄƒng xuáº¥t</button>
    </header>

    <main class="app-shell">
      <!-- LOGIN -->
      <section id="login-section" class="card center">
        <h2>ÄÄƒng nháº­p há»‡ thá»‘ng ğŸŒ¿</h2>
        <form id="login-form">
          <input
            type="text"
            id="username"
            placeholder="TÃ i khoáº£n"
            required
          /><br />
          <input
            type="password"
            id="password"
            placeholder="Máº­t kháº©u"
            required
          /><br />
          <button type="submit" class="btn-primary">ÄÄƒng nháº­p</button>
        </form>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard" class="hidden">
        <aside class="sidebar">
          <ul>
            <li class="active">ğŸ¡ Tá»•ng quan</li>
            <li>ğŸŒ³ Quáº£n lÃ½ cÃ¢y</li>
            <li>ğŸ‘¨â€ğŸŒ¾ NhÃ¢n viÃªn</li>
            <li>ğŸ“Š NÄƒng suáº¥t</li>
          </ul>
        </aside>

        <div class="dashboard-content">
          <h2 class="page-title">Báº£ng Ä‘iá»u khiá»ƒn vÆ°á»n Thanh Huyá»n</h2>
          <p id="user-role-text"></p>

          <!-- CREATE TREE -->
          <div id="create-tree-section" class="card">
            <h3>ThÃªm cÃ¢y má»›i</h3>
            <form id="create-tree-form">
              <input
                type="text"
                id="tree-name"
                placeholder="TÃªn cÃ¢y"
                required
              />
              <input
                type="text"
                id="tree-species"
                placeholder="Giá»‘ng cÃ¢y"
                required
              />
              <input
                type="text"
                id="tree-location"
                placeholder="Vá»‹ trÃ­ (VD: LÃ´ A3)"
                required
              />
              <input type="date" id="tree-date" required />
              <input
                type="text"
                id="tree-image"
                placeholder="URL áº£nh cÃ¢y (tÃ¹y chá»n)"
              />
              <button type="submit" class="btn-primary">Táº¡o cÃ¢y & QR</button>
            </form>
          </div>

          <!-- TREE LIST -->
          <div id="tree-list-section" class="card">
            <h3>Danh sÃ¡ch cÃ¢y ğŸŒ³</h3>
            <table id="tree-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>TÃªn cÃ¢y</th>
                  <th>Giá»‘ng</th>
                  <th>Vá»‹ trÃ­</th>
                  <th>TÃ¬nh tráº¡ng</th>
                  <th>Bá»‡nh</th>
                  <th>NÄƒng suáº¥t</th>
                  <th>QR</th>
                  <th>Lá»‹ch sá»­</th>
                </tr>
              </thead>
              <tbody id="tree-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MODALS -->
      <div id="qr-modal" class="modal hidden">
        <div class="modal-content">
          <h3>MÃ£ QR cá»§a cÃ¢y</h3>
          <img id="qr-image" alt="QR" />
          <button class="btn-secondary" onclick="closeModal('qr-modal')">
            ÄÃ³ng
          </button>
        </div>
      </div>

      <div id="yield-modal" class="modal hidden">
        <div class="modal-content">
          <h3>NÄƒng suáº¥t cÃ¢y ğŸŒ¾</h3>
          <canvas id="yield-chart"></canvas>
          <form id="yield-form">
            <input type="number" id="yield-year" placeholder="NÄƒm" required />
            <input
              type="number"
              id="yield-quantity"
              placeholder="Sáº£n lÆ°á»£ng (kg)"
              required
            />
            <button type="submit" class="btn-primary small">
              LÆ°u nÄƒng suáº¥t
            </button>
          </form>
          <button class="btn-secondary" onclick="closeModal('yield-modal')">
            ÄÃ³ng
          </button>
        </div>
      </div>

      <div id="logs-modal" class="modal hidden">
        <div class="modal-content">
          <h3>Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng ğŸŒ¿</h3>
          <div id="logs-container"></div>
          <button class="btn-secondary" onclick="closeModal('logs-modal')">
            ÄÃ³ng
          </button>
        </div>
      </div>
    </main>

    <footer>
      ğŸŒ¿ <b>Thanh Huyá»n Farm</b> | VÆ°á»n sáº§u riÃªng há»¯u cÆ¡ â€“ Äá»©c Trá»ng, LÃ¢m Äá»“ng
      <br />
      Hotline: 0909.123.456 | Facebook: /thanhhuyenfarm | Zalo: @thanhhuyenfarm
    </footer>

    <script>
      // DÃ¹ng relative path vÃ¬ index.html Ä‘Æ°á»£c serve cÃ¹ng domain vá»›i API
      const API_BASE = "";

      let currentUser = null;
      let token = null;

      // LOGIN
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;

          const res = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (data.token) {
            token = data.token;
            currentUser = data.user;
            document.getElementById("login-section").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
            document
              .getElementById("logout-btn")
              .classList.remove("hidden");
            document.getElementById(
              "user-role-text"
            ).innerText = `Xin chÃ o ${currentUser.username} â€“ Vai trÃ²: ${currentUser.role}`;
            loadTrees();
          } else alert("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u");
        });

      // LOGOUT
      document
        .getElementById("logout-btn")
        .addEventListener("click", () => location.reload());

      // CREATE TREE
      document
        .getElementById("create-tree-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("tree-name").value;
          const species = document.getElementById("tree-species").value;
          const location = document.getElementById("tree-location").value;
          const plantDate = document.getElementById("tree-date").value;
          const imageURL = document.getElementById("tree-image").value;

          const res = await fetch(`${API_BASE}/api/trees`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              name,
              species,
              location,
              plantDate,
              imageURL,
            }),
          });
          const data = await res.json();
          if (data.tree) {
            alert("âœ… ÄÃ£ thÃªm cÃ¢y má»›i");
            loadTrees();
          } else alert("Lá»—i táº¡o cÃ¢y!");
        });

      // LOAD TREES
      async function loadTrees() {
        const res = await fetch(`${API_BASE}/api/trees`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const trees = await res.json();
        const tbody = document.getElementById("tree-table-body");
        tbody.innerHTML = "";
        trees.forEach((t) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${t.numericId}</td>
            <td>${t.name}</td>
            <td>${t.species}</td>
            <td>${t.location}</td>
            <td>${t.currentHealth}</td>
            <td><button class="btn-secondary small" onclick="updateDiseases('${t._id}')">Bá»‡nh</button></td>
            <td><button class="btn-secondary small" onclick="openYieldModal('${t._id}')">Xem</button></td>
            <td><button class="btn-secondary small" onclick="openQrModal('${t.qrCode}')">QR</button></td>
            <td><button class="btn-secondary small" onclick="openLogs('${t._id}')">Xem</button></td>
          `;
          tbody.appendChild(row);
        });
      }

      // MODALS
      function openQrModal(qr) {
        document.getElementById("qr-image").src = qr;
        document.getElementById("qr-modal").classList.remove("hidden");
      }
      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      async function updateDiseases(id) {
        const diseases = prompt("Nháº­p cÃ¡c bá»‡nh (phÃ¢n tÃ¡ch dáº¥u pháº©y):");
        if (!diseases) return;
        await fetch(`${API_BASE}/api/trees/${id}/diseases`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            diseases: diseases.split(",").map((d) => d.trim()),
          }),
        });
        loadTrees();
      }

      let chartInstance = null;
      async function openYieldModal(treeId) {
        document.getElementById("yield-modal").classList.remove("hidden");
        const res = await fetch(`${API_BASE}/api/trees`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const trees = await res.json();
        const tree = trees.find((t) => t._id === treeId);
        const ctx = document.getElementById("yield-chart").getContext("2d");
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: tree.yieldHistory.map((y) => y.year),
            datasets: [
              {
                label: "NÄƒng suáº¥t (kg)",
                data: tree.yieldHistory.map((y) => y.quantity),
                backgroundColor: "#16a34a",
              },
            ],
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } },
        });
        document
          .getElementById("yield-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const year = document.getElementById("yield-year").value;
            const quantity = document.getElementById("yield-quantity").value;
            await fetch(`${API_BASE}/api/trees/${treeId}/yield`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ year, quantity }),
            });
            alert("ÄÃ£ lÆ°u nÄƒng suáº¥t");
            closeModal("yield-modal");
            loadTrees();
          });
      }

      async function openLogs(treeId) {
        document.getElementById("logs-modal").classList.remove("hidden");
        const res = await fetch(`${API_BASE}/api/trees/${treeId}/logs`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const logs = await res.json();
        document.getElementById("logs-container").innerHTML = logs
          .map(
            (l) =>
              `<div class='log-item'><b>${l.username}</b> â€“ ${l.action}<br>${l.details}<br><span>${new Date(
                l.createdAt
              ).toLocaleString()}</span></div>`
          )
          .join("");
      }
    </script>
  </body>
</html>
