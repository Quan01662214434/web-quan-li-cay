<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Thanh Huyá»n Farm â€“ Quáº£n lÃ½ vÆ°á»n sáº§u riÃªng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
  <div class="app-layout">
   <aside class="sidebar">
  <div class="sidebar-brand">
    <img src="images/logo-thanh-huyen.png" alt="Thanh Huyá»n Farm" class="sidebar-logo">
    <div>Thanh Huyá»n Farm</div>
  </div>

  <nav class="sidebar-nav">
    <a class="nav-item active" data-scroll-target="dashboard">ğŸŒ± CÃ¢y & QR</a>
    <a class="nav-item" data-scroll-target="staff-section">ğŸ‘¨â€ğŸŒ¾ NhÃ¢n viÃªn</a>
    <a class="nav-item" data-scroll-target="activity-section">ğŸ“œ Lá»‹ch sá»­</a>
  </nav>
</aside>

    <!-- HEADER -->
    <div class="main-area">
     <header class="app-header">
      <div class="header-left">
        <img src="images/logo-thanh-huyen.png" alt="Thanh Huyá»n Farm" class="logo"/>
        <div class="header-title">
          <div class="brand-name">Thanh Huyá»n Farm</div>
          <div class="brand-subtitle">Quáº£n lÃ½ vÆ°á»n sáº§u riÃªng há»¯u cÆ¡</div>
        </div>
      </div>

      <button id="hamburger-btn" class="hamburger" type="button">
        <span></span><span></span><span></span>
      </button>

      <nav id="main-nav" class="main-nav">
        <button class="nav-link active" type="button" data-scroll-target="dashboard">CÃ¢y & QR</button>
        <button class="nav-link" type="button" data-scroll-target="staff-section">NhÃ¢n viÃªn</button>
        <button class="nav-link" type="button" data-scroll-target="activity-section">Lá»‹ch sá»­</button>
      </nav>

      <div class="header-right">
        <span id="user-info" class="user-info"></span>
        <button id="logout-btn" class="btn-secondary hidden">ÄÄƒng xuáº¥t</button>
      </div>
    </header>

    <main>
      <!-- LANDING + LOGIN -->
      <section id="login-section" class="section section-landing">
        <div class="landing-grid">
          <div class="landing-text">
            <h1>Há»‡ thá»‘ng quáº£n lÃ½ vÆ°á»n sáº§u riÃªng ğŸŒ±</h1>
            <p>Theo dÃµi tá»«ng cÃ¢y, tÃ¬nh tráº¡ng, bá»‡nh, nÄƒng suáº¥t vÃ  lá»‹ch sá»­ lÃ m viá»‡c â€“ tá»‘i Æ°u cho Ä‘iá»‡n thoáº¡i.</p>
            <ul class="landing-bullets">
              <li>Má»—i cÃ¢y 1 mÃ£ QR â€“ quÃ©t lÃ  tháº¥y thÃ´ng tin</li>
              <li>Chá»§ vÆ°á»n & nhÃ¢n viÃªn lÃ m viá»‡c chung</li>
              <li>LÆ°u váº¿t má»i thao tÃ¡c â€“ ai lÃ m gÃ¬, lÃºc nÃ o</li>
            </ul>
          </div>

          <div class="card login-card">
            <h2>ÄÄƒng nháº­p há»‡ thá»‘ng ğŸŒ¿</h2>
            <form id="login-form" class="form-grid">
              <div class="form-row">
                <label for="username">TÃ i khoáº£n</label>
                <input id="username" type="text" placeholder="VD: thanhhuyen" required />
              </div>
              <div class="form-row">
                <label for="password">Máº­t kháº©u</label>
                <input id="password" type="password" placeholder="Nháº­p máº­t kháº©u" required />
              </div>
              <button type="submit" class="btn-primary full-width">ÄÄƒng nháº­p</button>
            </form>
          </div>
        </div>
        <p class="landing-footer">Thanh Huyá»n Farm | VÆ°á»n sáº§u riÃªng há»¯u cÆ¡ ğŸŒ¿</p>
      </section>

      <!-- DASHBOARD -->
      <!-- ================= DASHBOARD ================= -->
<section id="dashboard" class="section hidden">
  <h2 class="dashboard-title">ğŸ“Š Tá»•ng quan vÆ°á»n</h2>

  <div class="page-head">
    <h1>Quáº£n lÃ½ vÆ°á»n ğŸŒ±</h1>
    <p>Tá»•ng quan tÃ¬nh tráº¡ng vÆ°á»n vÃ  cÃ¢y trá»“ng</p>
  </div>

  <!-- STATS -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">ğŸŒ³</div>
      <div class="stat-info">
        <div class="stat-label">Tá»•ng sá»‘ cÃ¢y</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">âš ï¸</div>
      <div class="stat-info">
        <div class="stat-label">Cáº§n chÄƒm sÃ³c</div>
        <div class="stat-value" id="stat-care">0</div>
      </div>
    </div>

    <div class="stat-card danger">
      <div class="stat-icon">ğŸ¦ </div>
      <div class="stat-info">
        <div class="stat-label">Bá»‡nh náº·ng</div>
        <div class="stat-value" id="stat-sick">0</div>
      </div>
    </div>
  </div>

  <!-- VietGAP -->
  <div id="farm-vietgap-wrapper" class="farm-vietgap-card hidden">
    <div class="farm-vietgap-left">
      <div class="vietgap-logo-circle"><span class="vg-text">VG</span></div>
    </div>
    <div class="farm-vietgap-info">
      <div class="farm-vietgap-title">VÆ°á»n Ä‘áº¡t chuáº©n VietGAP</div>
      <div class="farm-vietgap-detail">
        MÃ£ sá»‘ VietGAP: <span id="farm-vietgap-code">â€”</span>
      </div>
    </div>
    <div class="farm-vietgap-status">âœ…</div>
  </div>

  <!-- GRID -->
  <div class="dashboard-grid">

    <!-- FORM Táº O CÃ‚Y -->
    <section class="card collapsible">
      <div class="card-header clickable"
           onclick="this.parentElement.classList.toggle('open')">
        <h2>â• ThÃªm cÃ¢y má»›i</h2>
      </div>

      <form id="create-tree-form" class="form-grid">
  <div class="form-row">
    <label>TÃªn cÃ¢y</label>
    <input id="tree-name" required />
  </div>

  <div class="form-row">
    <label>Giá»‘ng</label>
    <input id="tree-species" />
  </div>

  <div class="form-row">
    <label>Khu vá»±c</label>
    <select id="tree-area"></select>
    <button type="button" id="add-area-btn" class="btn-secondary small">+ Khu</button>
  </div>

  <div class="form-row">
    <label>Vá»‹ trÃ­</label>
    <input id="tree-location" />
  </div>

  <div class="form-row">
    <label>NgÃ y trá»“ng</label>
    <input id="tree-date" type="date" />
  </div>

  <div class="form-row">
    <label>MÃ£ VietGAP</label>
    <input id="tree-vietgap" />
  </div>

  <div class="form-row">
    <label>Diá»‡n tÃ­ch</label>
    <input id="tree-acreage" placeholder="VD: 0.15 ha hoáº·c 1500 mÂ²" />
  </div>

  <div class="form-row">
    <label>HÃ¬nh áº£nh (URL)</label>
    <input id="tree-image" type="url" />
  </div>

  <button type="submit" class="btn-primary full-width">
    â• Táº¡o cÃ¢y & QR
  </button>
</form>
    </section>

    <!-- DANH SÃCH CÃ‚Y -->
  
<!-- ============== END DASHBOARD ============== -->


<!-- ================= STAFF ================= -->
<!-- NHÃ‚N VIÃŠN -->
<section id="staff-section" class="section hidden">
  <div class="card">
    <h2>ğŸ‘¨â€ğŸŒ¾ NhÃ¢n viÃªn vÆ°á»n</h2>

    <form id="staff-form" class="form-grid form-inline">
      <div class="form-row">
        <label>TÃ i khoáº£n</label>
        <input id="staff-username" required />
      </div>
      <div class="form-row">
        <label>Máº­t kháº©u</label>
        <input id="staff-password" type="password" required />
      </div>
      <button class="btn-primary">Táº¡o nhÃ¢n viÃªn</button>
    </form>

    <div id="staff-list"></div>
  </div>
</section>
<!-- ================= ACTIVITY ================= -->
<section id="activity-section" class="section hidden">
  <div class="card">
    <h2>ğŸ“œ Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng</h2>
    <div id="activity-list"></div>
  </div>
</section>


          <!-- Lá»ŠCH Sá»¬ HOáº T Äá»˜NG -->
    </main>
    </div> <!-- end main-area -->

    <!-- MODALS -->
    <!-- QR -->
    <div id="qr-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('qr-modal')"></div>
      <div class="modal-content modal-qr">
        <h2>MÃ£ QR cá»§a cÃ¢y</h2>
        <img id="qr-image" alt="QR Code" />
        <button class="btn-secondary" onclick="closeModal('qr-modal')">ÄÃ³ng</button>
      </div>
    </div>

    <!-- NÄƒng suáº¥t -->
    <div id="yield-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('yield-modal')"></div>
      <div class="modal-content">
        <h2>NÄƒng suáº¥t theo nÄƒm</h2>
        <canvas id="yield-chart" height="200"></canvas>
        <form id="yield-form" class="form-grid">
          <div class="form-row two-col">
            <div>
              <label for="yield-year">NÄƒm</label>
              <input id="yield-year" type="number" min="2000" max="2100" value="2024" required />
            </div>
            <div>
              <label for="yield-quantity">Sáº£n lÆ°á»£ng (kg)</label>
              <input id="yield-quantity" type="number" min="0" step="1" placeholder="VD: 2000" required />
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeModal('yield-modal')">ÄÃ³ng</button>
            <button type="submit" class="btn-primary">LÆ°u nÄƒng suáº¥t</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bá»‡nh -->
    <div id="disease-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('disease-modal')"></div>
      <div class="modal-content">
        <h2>Bá»‡nh & váº¥n Ä‘á» cá»§a cÃ¢y</h2>
        <div id="disease-list" class="disease-list"></div>
        <div class="form-row inline">
          <input id="new-disease-name" type="text" placeholder="Nháº­p tÃªn bá»‡nh má»›i..." />
          <button id="add-disease-btn" class="btn-secondary small" type="button">+ ThÃªm bá»‡nh</button>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" type="button" onclick="closeModal('disease-modal')">ÄÃ³ng</button>
          <button id="save-disease-btn" class="btn-primary" type="button">LÆ°u</button>
        </div>
      </div>
    </div>

    <!-- TÃ¬nh tráº¡ng -->
    <div id="status-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('status-modal')"></div>
      <div class="modal-content">
        <h2>TÃ¬nh tráº¡ng & ghi chÃº</h2>
        <div class="form-row">
          <label for="status-select">TÃ¬nh tráº¡ng</label>
          <div class="status-row">
            <select id="status-select"></select>
            <button id="add-status-btn" type="button" class="btn-secondary small">+</button>
          </div>
        </div>
        <div class="form-row">
          <label for="status-notes">Ghi chÃº</label>
          <textarea id="status-notes" rows="3" placeholder="VD: Cáº§n bÃ³n bá»• sung kali, tá»‰a cÃ nh..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" type="button" onclick="closeModal('status-modal')">ÄÃ³ng</button>
          <button id="save-status-btn" class="btn-primary" type="button">LÆ°u</button>
        </div>
      </div>
    </div>

    <!-- Cáº¥u hÃ¬nh QR -->
    <div id="display-config-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('display-config-modal')"></div>
      <div class="modal-content">
        <h2>ThÃ´ng tin hiá»ƒn thá»‹ cho khÃ¡ch khi quÃ©t QR</h2>
        <p class="text-muted">TÃ­ch chá»n nhá»¯ng má»¥c muá»‘n khÃ¡ch hÃ ng nhÃ¬n tháº¥y trÃªn trang thÃ´ng tin cÃ¢y.</p>

        <div class="display-config-grid">
          <label><input id="cfg-name" type="checkbox" checked /> TÃªn cÃ¢y</label>
          <label><input id="cfg-species" type="checkbox" checked /> Giá»‘ng</label>
          <label><input id="cfg-area" type="checkbox" checked /> Khu vá»±c</label>
          <label><input id="cfg-location" type="checkbox" checked /> Vá»‹ trÃ­</label>
          <label><input id="cfg-plantDate" type="checkbox" checked /> NgÃ y trá»“ng</label>
          <label><input id="cfg-vietgap" type="checkbox" checked /> MÃ£ sá»‘ VietGAP</label>
          <label><input id="cfg-acreage" type="checkbox" checked /> Diá»‡n tÃ­ch</label>
          <label><input id="cfg-image" type="checkbox" checked /> HÃ¬nh áº£nh</label>
          <label><input id="cfg-health" type="checkbox" checked /> TÃ¬nh tráº¡ng hiá»‡n táº¡i</label>
          <label><input id="cfg-notes" type="checkbox" checked /> Ghi chÃº</label>
          <label><input id="cfg-diseases" type="checkbox" checked /> Danh sÃ¡ch bá»‡nh</label>
          <label><input id="cfg-yield" type="checkbox" checked /> NÄƒng suáº¥t theo nÄƒm</label>
          <label><input id="cfg-ownerName" type="checkbox" checked /> TÃªn vÆ°á»n/Äá»‹a chá»‰</label>
        </div>

        <div class="modal-actions">
          <button class="btn-secondary" type="button" onclick="closeModal('display-config-modal')">ÄÃ³ng</button>
          <button id="save-display-config-btn" class="btn-primary" type="button">LÆ°u cáº¥u hÃ¬nh</button>
        </div>
      </div>
    </div>

    <!-- Sá»­a thÃ´ng tin cÃ¢y -->
    <div id="edit-tree-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('edit-tree-modal')"></div>
      <div class="modal-content">
        <h2>Chá»‰nh thÃ´ng tin cÃ¢y</h2>
        <form id="edit-tree-form" class="form-grid">
          <div class="form-row">
            <label for="edit-tree-location">Vá»‹ trÃ­ trong vÆ°á»n</label>
            <input id="edit-tree-location" type="text" placeholder="VD: HÃ ng A2 - CÃ¢y 15" />
          </div>
          <div class="form-row">
            <label for="edit-tree-date">NgÃ y trá»“ng</label>
            <input id="edit-tree-date" type="date" />
          </div>
          <div class="form-row">
            <label for="edit-tree-vietgap">MÃ£ sá»‘ VietGAP</label>
            <input id="edit-tree-vietgap" type="text" placeholder="VD: VG-TH-001" />
          </div>
           <div class="form-row">
            <label for="edit-tree-image">HÃ¬nh áº£nh (URL)</label>
            <input id="edit-tree-image" type="url" placeholder="https://...">
          </div>
          <div class="form-row">
            <label for="edit-tree-acreage">Diá»‡n tÃ­ch</label>
            <input id="edit-tree-acreage" type="text" placeholder="VD: 0.15 ha hoáº·c 1500 mÂ²" />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeModal('edit-tree-modal')">Huá»·</button>
            <button type="submit" class="btn-primary">LÆ°u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- âœ… TRÆ¯á»œNG TUá»² BIáº¾N -->
    <div id="extras-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('extras-modal')"></div>
      <div class="modal-content">
        <h2>TrÆ°á»ng tuá»³ biáº¿n</h2>
        <p class="text-muted">Báº¡n cÃ³ thá»ƒ thÃªm cÃ¡c trÆ°á»ng nhÆ° â€œLoáº¡i phÃ¢nâ€, â€œLáº§n tá»‰a cÃ nh gáº§n nháº¥tâ€, â€œSá»‘ Ä‘á»£t tÆ°á»›iâ€â€¦</p>
        <div id="extras-list" class="extras-list"></div>
        <div class="modal-actions" style="justify-content: space-between;">
          <button id="add-extra-btn" class="btn-secondary" type="button">+ ThÃªm trÆ°á»ng</button>
          <div>
            <button class="btn-secondary" type="button" onclick="closeModal('extras-modal')">ÄÃ³ng</button>
            <button id="save-extras-btn" class="btn-primary" type="button">LÆ°u</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script>
      // ====== API BASE ======
      const API_BASE = window.location.hostname === "localhost" ? "http://localhost:4000" : "https://api.thefram.site";

      let token = localStorage.getItem("th_token") || null;
      let currentUser = null;
      try { currentUser = JSON.parse(localStorage.getItem("th_user") || "null"); } catch { currentUser = null; }

      let lastTrees = [];
      let currentYieldTreeId = null;
      let chartInstance = null;

      let diseaseMaster = [];
      let currentDiseaseTreeId = null;

      let statusMaster = [];
      let currentStatusTreeId = null;
      let currentStatusNotes = "";

      let displayConfig = null;
      let currentEditTreeId = null;

      let treeSearchTerm = "";
      let treeStatusFilter = "all";

      // extras
      let currentExtrasTreeId = null;
      let tempExtras = []; // [{key,label,value,showPublic}]

      // ====== Setup after login ======
      async function setupAfterLogin() {
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("logout-btn").classList.remove("hidden");
        document.getElementById("display-config-btn").classList.remove("hidden");

        document.getElementById("user-info").innerText =
          `Xin chÃ o ${currentUser.username} â€“ Vai trÃ²: ${currentUser.role} â€“ VÆ°á»n: ${currentUser.farmName || "Thanh Huyá»n Farm"}`;

        await loadDisplayConfig();
        await loadTrees();

        // Quyá»n owner â†’ hiá»ƒn thá»‹, staff â†’ áº©n ná»™i dung + disable tab
        const staffTab = document.querySelector('[data-scroll-target="staff-section"]');
        const actTab = document.querySelector('[data-scroll-target="activity-section"]');

        if (currentUser.role === "owner") {
          document.getElementById("staff-section").classList.remove("hidden");
          document.getElementById("activity-section").classList.remove("hidden");
          loadStaff();
          loadActivity();
          [staffTab, actTab].forEach(btn => btn && btn.classList.remove("disabled"));
        } else {
          document.getElementById("staff-section").classList.add("hidden");
          document.getElementById("activity-section").classList.add("hidden");
          [staffTab, actTab].forEach(btn => {
            if (!btn) return;
            btn.classList.add("disabled");
            btn.addEventListener("click", (e) => {
              e.preventDefault(); e.stopPropagation();
              alert("Chá»‰ chá»§ vÆ°á»n (owner) má»›i dÃ¹ng Ä‘Æ°á»£c má»¥c nÃ y.");
            }, { once: true });
          });
        }
        if (document.querySelector(".sidebar")) {
            showOnlySection("dashboard");

        }
      }

      // ====== Login ======
      document.getElementById("login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        try {
          const res = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "ÄÄƒng nháº­p tháº¥t báº¡i"); return; }

          token = data.token;
          currentUser = data.user || ({
            username, role: data.role || "owner", farmName: data.farmName || "Thanh Huyá»n Farm",
          });
          localStorage.setItem("th_token", token);
          localStorage.setItem("th_user", JSON.stringify(currentUser));
          setupAfterLogin();
        } catch (err) {
          console.error(err); alert("KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c server.");
        }
      });

      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("th_token");
        localStorage.removeItem("th_user");
        location.reload();
      });

      // ====== Areas ======
      function loadAreas() {
        const select = document.getElementById("tree-area");
        if (!select) return;
        let areas = [];
        try { areas = JSON.parse(localStorage.getItem("farmAreas") || "[]"); } catch { areas = []; }
        if (!areas.length) {
          areas = ["Khu A", "Khu B", "Khu C"];
          localStorage.setItem("farmAreas", JSON.stringify(areas));
        }
        select.innerHTML = "";
        areas.forEach((a) => {
          const opt = document.createElement("option");
          opt.value = a; opt.textContent = a; select.appendChild(opt);
        });
      }

      function addNewArea() {
        let areas = [];
        try { areas = JSON.parse(localStorage.getItem("farmAreas") || "[]"); } catch { areas = []; }
        const name = prompt("Nháº­p tÃªn khu vá»±c má»›i (VD: Khu Bá» Suá»‘i):");
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        if (!areas.includes(trimmed)) {
          areas.push(trimmed);
          localStorage.setItem("farmAreas", JSON.stringify(areas));
        }
        loadAreas();
        const select = document.getElementById("tree-area");
        if (select) select.value = trimmed;
      }

      // ====== Create tree ======
      document.getElementById("create-tree-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }

        const name = document.getElementById("tree-name").value.trim();
        const species = document.getElementById("tree-species").value.trim();
        const area = document.getElementById("tree-area").value;
        const location = document.getElementById("tree-location").value.trim();
        const plantDate = document.getElementById("tree-date").value;
        const imageURL = document.getElementById("tree-image").value.trim();
        const vietGapCode = document.getElementById("tree-vietgap").value.trim();
        const acreage = document.getElementById("tree-acreage").value.trim(); // âœ… chuá»—i

        try {
          const res = await fetch(`${API_BASE}/api/trees`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ name, species, area, location, plantDate, imageURL, vietGapCode, acreage }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ táº¡o cÃ¢y"); return; }
          alert("âœ… ÄÃ£ táº¡o cÃ¢y & QR");
          e.target.reset();
          loadTrees();
        } catch (err) {
          console.error(err); alert("Lá»—i khi táº¡o cÃ¢y");
        }
      });

      // ====== VietGAP badge ======
      function updateFarmVietGapBadge() {
        const wrapper = document.getElementById("farm-vietgap-wrapper");
        const codeSpan = document.getElementById("farm-vietgap-code");
        if (!wrapper || !codeSpan) return;
        const firstWithVg = lastTrees.find((t) => t.vietGapCode && t.vietGapCode.trim() !== "");
        if (firstWithVg) { codeSpan.textContent = firstWithVg.vietGapCode; wrapper.classList.remove("hidden"); }
        else { wrapper.classList.add("hidden"); }
      }

      // ====== Tree list ======
      function renderTreeList() {

  const container = document.getElementById("tree-list");
  if (!container) return;

  container.innerHTML = "";

  // ===== TrÆ°á»ng há»£p chÆ°a cÃ³ cÃ¢y =====
  if (!lastTrees.length) {
    container.innerHTML = "<p>ChÆ°a cÃ³ cÃ¢y nÃ o. HÃ£y thÃªm cÃ¢y má»›i.</p>";
    updateFarmVietGapBadge();
    updateStats();
    return;
  }

  const term = (treeSearchTerm || "").trim().toLowerCase();

  const filtered = lastTrees.filter((t) => {
    if (treeStatusFilter === "need-care") {
      return (t.currentHealth || "").trim() === "Cáº§n chÄƒm sÃ³c";
    }
    if (treeStatusFilter === "sick") {
      return (t.currentHealth || "").trim() === "Bá»‡nh náº·ng";
    }

    if (!term) return true;

    const combined = `
      ${t.numericId || ""} ${t.name || ""} ${t.species || ""}
      ${t.area || ""} ${t.location || ""} ${t.vietGapCode || ""}
    `.toLowerCase();

    return combined.includes(term);
  });

  // ===== KhÃ´ng cÃ³ cÃ¢y sau khi lá»c =====
  if (!filtered.length) {
    container.innerHTML = "<p>KhÃ´ng tÃ¬m tháº¥y cÃ¢y nÃ o khá»›p bá»™ lá»c.</p>";
    updateFarmVietGapBadge();
    updateStats();
    return;
  }

  // ===== Render tá»«ng cÃ¢y =====
  filtered.forEach((t) => {
    const card = document.createElement("div");
    card.className = "tree-card";

    const diseasesText = (t.diseases || []).join(", ");
    const vietgapHtml = t.vietGapCode
      ? `<div class="tree-vietgap">VietGAP: <b>${t.vietGapCode}</b></div>`
      : "";
    const acreageHtml = t.acreage
      ? `<div class="tree-areaha">Diá»‡n tÃ­ch: <b>${t.acreage}</b></div>`
      : "";

    card.innerHTML = `
      <div class="tree-card-header">
        <div class="tree-title">ğŸŒ³ #${t.numericId} â€“ ${t.name}</div>
        <div class="tree-health-badge">${t.currentHealth || "ChÆ°a cáº­p nháº­t"}</div>
      </div>

      <div class="tree-sub">
        ğŸŒ± ${t.species || "ChÆ°a rÃµ giá»‘ng"}
        â€¢ ğŸ“ ${t.area || "ChÆ°a rÃµ khu"}
        ${t.location ? `â€¢ ${t.location}` : ""}
      </div>

      ${vietgapHtml}
      ${acreageHtml}
      ${diseasesText ? `<div class="tree-disease">ğŸ¦  ${diseasesText}</div>` : ""}

      <div class="tree-actions compact">
        <button class="btn-qr" onclick="openQrModal('${t.qrCode}')">QR</button>
        <button onclick="openStatusModal(
          '${t._id}',
          '${(t.currentHealth || "").replace(/'/g,"\\'")}',
          '${(t.notes || "").replace(/'/g,"\\'")}'
        )">TÃ¬nh tráº¡ng</button>
        <button onclick="openEditTree('${t._id}')">Sá»­a</button>
      </div>
    `;

    container.appendChild(card);
  });

  updateFarmVietGapBadge();
  updateStats();
}
function updateStats() {
  const total = lastTrees.length;

  const needCare = lastTrees.filter(
    t => (t.currentHealth || "").trim() === "Cáº§n chÄƒm sÃ³c"
  ).length;

  const sick = lastTrees.filter(
    t => (t.currentHealth || "").trim() === "Bá»‡nh náº·ng"
  ).length;

  const totalEl = document.getElementById("stat-total");
  const careEl = document.getElementById("stat-care");
  const sickEl = document.getElementById("stat-sick");

  if (totalEl) totalEl.innerText = total;
  if (careEl) careEl.innerText = needCare;
  if (sickEl) sickEl.innerText = sick;
}
        // ====== Update dashboard stats ======
      async function loadTrees() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/trees`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const trees = await res.json();
          if (!res.ok) { alert(trees.error || "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch cÃ¢y"); return; }
          lastTrees = trees;
          renderTreeList();
        } catch (err) {
          console.error(err); alert("Lá»—i khi táº£i danh sÃ¡ch cÃ¢y");
        }
      }

      function openQrModal(dataUrl) {
        document.getElementById("qr-image").src = dataUrl;
        document.getElementById("qr-modal").classList.remove("hidden");
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      // ====== Disease ======
      function loadDiseaseMaster() {
        try { diseaseMaster = JSON.parse(localStorage.getItem("diseaseMaster") || "[]"); } catch { diseaseMaster = []; }
        if (!diseaseMaster.length) {
          diseaseMaster = ["Thá»‘i rá»…","SÃ¢u Ä‘á»¥c thÃ¢n","Náº¥m Phytophthora","ThÃ¡n thÆ°"];
          localStorage.setItem("diseaseMaster", JSON.stringify(diseaseMaster));
        }
      }

      function renderDiseaseListForTree(tree) {
        const container = document.getElementById("disease-list");
        container.innerHTML = "";
        const current = tree.diseases || [];
        diseaseMaster.forEach((name) => {
          const wrap = document.createElement("div");
          wrap.className = "disease-item";
          const id = `dis-${name.replace(/\s+/g, "-")}`;
          wrap.innerHTML = `
            <input type="checkbox" id="${id}" value="${name}" ${current.includes(name) ? "checked" : ""}/>
            <label for="${id}">${name}</label>
          `;
          container.appendChild(wrap);
        });
      }

      function openDiseaseModal(treeId) {
        currentDiseaseTreeId = treeId;
        loadDiseaseMaster();
        const tree = lastTrees.find((t) => t._id === treeId);
        if (!tree) { alert("KhÃ´ng tÃ¬m tháº¥y cÃ¢y Ä‘á»ƒ chá»‰nh bá»‡nh"); return; }
        renderDiseaseListForTree(tree);
        document.getElementById("disease-modal").classList.remove("hidden");
      }

      function addNewDisease() {
        loadDiseaseMaster();
        const input = document.getElementById("new-disease-name");
        const name = (input.value || "").trim();
        if (!name) return;
        if (!diseaseMaster.includes(name)) {
          diseaseMaster.push(name);
          localStorage.setItem("diseaseMaster", JSON.stringify(diseaseMaster));
        }
        input.value = "";
        if (currentDiseaseTreeId) {
          const tree = lastTrees.find((t) => t._id === currentDiseaseTreeId);
          if (tree) renderDiseaseListForTree(tree);
        }
      }

      async function saveDiseaseForTree() {
        if (!currentDiseaseTreeId) return;
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        const checkboxes = document.querySelectorAll("#disease-list input[type='checkbox']:checked");
        const diseases = Array.from(checkboxes).map((c) => c.value);
        try {
          const res = await fetch(`${API_BASE}/api/trees/${currentDiseaseTreeId}/diseases`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ diseases }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ cáº­p nháº­t bá»‡nh"); return; }
          alert("âœ… ÄÃ£ lÆ°u danh sÃ¡ch bá»‡nh cho cÃ¢y");
          closeModal("disease-modal");
          loadTrees();
        } catch (err) { console.error(err); alert("Lá»—i khi lÆ°u bá»‡nh"); }
      }

      // ====== Status ======
      function loadStatusMaster() {
        try { statusMaster = JSON.parse(localStorage.getItem("statusMaster") || "[]"); } catch { statusMaster = []; }
        if (!statusMaster.length) {
          statusMaster = ["BÃ¬nh thÆ°á»ng","Cáº§n chÄƒm sÃ³c","Bá»‡nh náº·ng"];
          localStorage.setItem("statusMaster", JSON.stringify(statusMaster));
        }
      }

      function renderStatusOptions(selected) {
        const sel = document.getElementById("status-select");
        if (!sel) return;
        sel.innerHTML = "";
        statusMaster.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s; opt.textContent = s; if (s === selected) opt.selected = true;
          sel.appendChild(opt);
        });
      }

      function openStatusModal(treeId, currentHealth, notes) {
        currentStatusTreeId = treeId;
        currentStatusNotes = notes || "";
        loadStatusMaster();
        renderStatusOptions(currentHealth || "BÃ¬nh thÆ°á»ng");
        document.getElementById("status-notes").value = currentStatusNotes || "";
        document.getElementById("status-modal").classList.remove("hidden");
      }

      function addNewStatus() {
        loadStatusMaster();
        const name = prompt("Nháº­p tÃªn tÃ¬nh tráº¡ng má»›i (VD: Sáº¯p thu hoáº¡ch, CÃ¢y cháº¿t...):");
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        if (!statusMaster.includes(trimmed)) {
          statusMaster.push(trimmed);
          localStorage.setItem("statusMaster", JSON.stringify(statusMaster));
        }
        renderStatusOptions(trimmed);
      }

      async function saveStatusForTree() {
        if (!currentStatusTreeId) return;
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        const status = document.getElementById("status-select").value;
        const notes = document.getElementById("status-notes").value;
        try {
          const res = await fetch(`${API_BASE}/api/trees/${currentStatusTreeId}/health`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ currentHealth: status, notes }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ cáº­p nháº­t tÃ¬nh tráº¡ng"); return; }
          alert("âœ… ÄÃ£ lÆ°u tÃ¬nh tráº¡ng cÃ¢y");
          closeModal("status-modal");
          loadTrees();
        } catch (err) { console.error(err); alert("Lá»—i khi lÆ°u tÃ¬nh tráº¡ng"); }
      }

      // ====== Yield ======
      async function openYield(id) {
        currentYieldTreeId = id;
        document.getElementById("yield-modal").classList.remove("hidden");
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        try {
          const res = await fetch(`${API_BASE}/api/trees`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const trees = await res.json();
          const tree = trees.find((t) => t._id === id);
          const ctx = document.getElementById("yield-chart").getContext("2d");
          if (chartInstance) chartInstance.destroy();
          const labels = (tree.yieldHistory || []).map((y) => y.year);
          const data = (tree.yieldHistory || []).map((y) => y.quantity);
          chartInstance = new Chart(ctx, {
            type: "bar",
            data: { labels, datasets: [{ label: "NÄƒng suáº¥t (kg)", data, backgroundColor: "#3fa34d" }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } },
          });
        } catch (err) { console.error(err); alert("Lá»—i khi táº£i nÄƒng suáº¥t"); }
      }

      document.getElementById("yield-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentYieldTreeId) return;
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        const year = document.getElementById("yield-year").value;
        const quantity = document.getElementById("yield-quantity").value;
        try {
          const res = await fetch(`${API_BASE}/api/trees/${currentYieldTreeId}/yield`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ year, quantity }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ lÆ°u nÄƒng suáº¥t"); return; }
          alert("âœ… ÄÃ£ lÆ°u nÄƒng suáº¥t");
          closeModal("yield-modal");
          e.target.reset();
          loadTrees();
        } catch (err) { console.error(err); alert("Lá»—i khi lÆ°u nÄƒng suáº¥t"); }
      });

      // ====== Display config ======
      const DISPLAY_FIELDS = [
        { key: "showName", checkboxId: "cfg-name" },
        { key: "showSpecies", checkboxId: "cfg-species" },
        { key: "showArea", checkboxId: "cfg-area" },
        { key: "showLocation", checkboxId: "cfg-location" },
        { key: "showPlantDate", checkboxId: "cfg-plantDate" },
        { key: "showVietGap", checkboxId: "cfg-vietgap" },
        { key: "showAcreage", checkboxId: "cfg-acreage" },
        { key: "showImage", checkboxId: "cfg-image" },
        { key: "showCurrentHealth", checkboxId: "cfg-health" },
        { key: "showNotes", checkboxId: "cfg-notes" },
        { key: "showDiseases", checkboxId: "cfg-diseases" },
        { key: "showYield", checkboxId: "cfg-yield" },
        { key: "showOwnerName", checkboxId: "cfg-ownerName" },
      ];

      async function loadDisplayConfig() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/display-config`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const cfg = await res.json();
          if (!res.ok) { console.error(cfg); return; }
          displayConfig = cfg;
        } catch (err) { console.error("Lá»—i load display config:", err); }
      }

      function applyDisplayConfigToModal() {
        if (!displayConfig) return;
        DISPLAY_FIELDS.forEach(({ key, checkboxId }) => {
          const cb = document.getElementById(checkboxId);
          if (!cb) return;
          cb.checked = displayConfig[key] !== false;
        });
      }

      function openDisplayConfigModal() {
        if (!displayConfig) displayConfig = {};
        applyDisplayConfigToModal();
        document.getElementById("display-config-modal").classList.remove("hidden");
      }

      async function saveDisplayConfig() {
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        const payload = {};
        DISPLAY_FIELDS.forEach(({ key, checkboxId }) => {
          const cb = document.getElementById(checkboxId);
          if (!cb) return; payload[key] = cb.checked;
        });
        try {
          const res = await fetch(`${API_BASE}/api/display-config`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ lÆ°u cáº¥u hÃ¬nh"); return; }
          displayConfig = data;
          alert("âœ… ÄÃ£ lÆ°u cáº¥u hÃ¬nh hiá»ƒn thá»‹ QR");
          closeModal("display-config-modal");
        } catch (err) { console.error(err); alert("Lá»—i khi lÆ°u cáº¥u hÃ¬nh"); }
      }

      // ====== Staff ======
      async function loadStaff() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/staff`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          const list = document.getElementById("staff-list");
          if (!res.ok) { list.innerHTML = "<p>KhÃ´ng táº£i Ä‘Æ°á»£c danh sÃ¡ch nhÃ¢n viÃªn.</p>"; return; }
          if (!data.length) { list.innerHTML = "<p>ChÆ°a cÃ³ nhÃ¢n viÃªn. HÃ£y táº¡o má»›i bÃªn trÃªn.</p>"; return; }
          list.innerHTML = "";
          data.forEach((u) => {
            const row = document.createElement("div");
            row.className = "staff-row";
            row.innerHTML = `
              <span>${u.username}</span>
              <button class="btn-secondary small" onclick="deleteStaff('${u._id}')">XoÃ¡</button>
            `;
            list.appendChild(row);
          });
        } catch (err) {
          console.error(err);
          document.getElementById("staff-list").innerHTML = "<p>Lá»—i khi táº£i nhÃ¢n viÃªn.</p>";
        }
      }

      async function createStaff(e) {
        e.preventDefault();
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        const username = document.getElementById("staff-username").value.trim();
        const password = document.getElementById("staff-password").value.trim();
        if (!username || !password) return;
        try {
          const res = await fetch(`${API_BASE}/api/staff`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ táº¡o nhÃ¢n viÃªn"); return; }
          alert("âœ… ÄÃ£ táº¡o nhÃ¢n viÃªn");
          document.getElementById("staff-form").reset();
          loadStaff();
        } catch (err) { console.error(err); alert("Lá»—i khi táº¡o nhÃ¢n viÃªn"); }
      }

      async function deleteStaff(id) {
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        if (!confirm("Báº¡n cháº¯c cháº¯n muá»‘n xoÃ¡ nhÃ¢n viÃªn nÃ y?")) return;
        try {
          const res = await fetch(`${API_BASE}/api/staff/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ xoÃ¡ nhÃ¢n viÃªn"); return; }
          alert("âœ… ÄÃ£ xoÃ¡ nhÃ¢n viÃªn");
          loadStaff();
        } catch (err) { console.error(err); alert("Lá»—i khi xoÃ¡ nhÃ¢n viÃªn"); }
      }

      // ====== Activity ======
      async function loadActivity() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/activity`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          const list = document.getElementById("activity-list");
          if (!res.ok) { list.innerHTML = "<p>KhÃ´ng táº£i Ä‘Æ°á»£c lá»‹ch sá»­ hoáº¡t Ä‘á»™ng.</p>"; return; }
          if (!data.length) { list.innerHTML = "<p>ChÆ°a cÃ³ hoáº¡t Ä‘á»™ng nÃ o.</p>"; return; }
          list.innerHTML = "";
          data.forEach((log) => {
            const div = document.createElement("div");
            div.className = "activity-item";
            const time = new Date(log.at);
            const timeText = time.toLocaleString("vi-VN");
            div.innerHTML = `
              <div><b>${log.user}</b> (${log.role}) â€“ ${log.action}</div>
              ${log.tree ? `<div class="activity-meta">CÃ¢y: ${log.tree}</div>` : ""}
              <div class="activity-meta">${timeText}</div>
            `;
            list.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          document.getElementById("activity-list").innerHTML = "<p>Lá»—i khi táº£i lá»‹ch sá»­.</p>";
        }
      }

      // ====== Edit tree ======
      function openEditTree(treeId) {
        const tree = lastTrees.find((t) => t._id === treeId);
        if (!tree) { alert("KhÃ´ng tÃ¬m tháº¥y cÃ¢y."); return; }
        currentEditTreeId = treeId;
        document.getElementById("edit-tree-location").value = tree.location || "";
        document.getElementById("edit-tree-date").value = tree.plantDate ? tree.plantDate.substring(0, 10) : "";
        document.getElementById("edit-tree-vietgap").value = tree.vietGapCode || "";
        document.getElementById("edit-tree-image").value = tree.imageURL || "";
        document.getElementById("edit-tree-acreage").value = typeof tree.acreage === "string" ? tree.acreage : (tree.acreage ?? "");
        document.getElementById("edit-tree-modal").classList.remove("hidden");
      }

      document.getElementById("edit-tree-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentEditTreeId) return;
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        const location = document.getElementById("edit-tree-location").value.trim();
        const plantDate = document.getElementById("edit-tree-date").value;
        const vietGapCode = document.getElementById("edit-tree-vietgap").value.trim();
        const acreage = document.getElementById("edit-tree-acreage").value.trim();
        const imageURL = document.getElementById("edit-tree-image").value.trim();

        try {
          const res = await fetch(`${API_BASE}/api/trees/${currentEditTreeId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ location, plantDate, vietGapCode, acreage,imageURL }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ cáº­p nháº­t cÃ¢y"); return; }
          alert("âœ… ÄÃ£ lÆ°u thÃ´ng tin cÃ¢y");
          closeModal("edit-tree-modal");
          loadTrees();
        } catch (err) { console.error(err); alert("Lá»—i khi lÆ°u thÃ´ng tin cÃ¢y"); }
      });

      // ====== Delete tree ======
      async function deleteTree(treeId) {
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        if (!confirm("XoÃ¡ cÃ¢y nÃ y? Thao tÃ¡c khÃ´ng thá»ƒ hoÃ n tÃ¡c.")) return;
        try {
          const res = await fetch(`${API_BASE}/api/trees/${treeId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ xoÃ¡ cÃ¢y"); return; }
          alert("âœ… ÄÃ£ xoÃ¡ cÃ¢y");
          loadTrees();
        } catch (err) { console.error(err); alert("Lá»—i khi xoÃ¡ cÃ¢y"); }
      }

      // ====== Extras (TrÆ°á»ng tuá»³ biáº¿n) ======
      function renderExtrasList() {
        const list = document.getElementById("extras-list");
        if (!list) return;
        if (!tempExtras.length) {
          list.innerHTML = `<div class="empty-row">ChÆ°a cÃ³ trÆ°á»ng nÃ o. Báº¥m â€œ+ ThÃªm trÆ°á»ngâ€.</div>`;
          return;
        }
        list.innerHTML = "";
        tempExtras.forEach((f, idx) => {
          const row = document.createElement("div");
          row.className = "extras-row";
          row.innerHTML = `
            <input class="ex-label" type="text" placeholder="NhÃ£n (VD: Loáº¡i phÃ¢n)" value="${(f.label || "").replace(/"/g,"&quot;")}"/>
            <input class="ex-value" type="text" placeholder="GiÃ¡ trá»‹" value="${(f.value || "").replace(/"/g,"&quot;")}"/>
            <label class="ex-toggle">
              <input class="ex-public" type="checkbox" ${f.showPublic ? "checked" : ""}/>
              <span>Hiá»‡n QR</span>
            </label>
            <button class="btn-danger small ex-del" type="button">XoÃ¡</button>
          `;
          // listeners
          row.querySelector(".ex-label").addEventListener("input", (e) => { tempExtras[idx].label = e.target.value; });
          row.querySelector(".ex-value").addEventListener("input", (e) => { tempExtras[idx].value = e.target.value; });
          row.querySelector(".ex-public").addEventListener("change", (e) => { tempExtras[idx].showPublic = e.target.checked; });
          row.querySelector(".ex-del").addEventListener("click", () => {
            tempExtras.splice(idx,1); renderExtrasList();
          });
          list.appendChild(row);
        });
      }

      function openExtrasModal(treeId) {
        currentExtrasTreeId = treeId;
        const tree = lastTrees.find((t) => t._id === treeId);
        if (!tree) { alert("KhÃ´ng tÃ¬m tháº¥y cÃ¢y."); return; }
        tempExtras = Array.isArray(tree.extraFields) ? JSON.parse(JSON.stringify(tree.extraFields)) : [];
        document.getElementById("extras-modal").classList.remove("hidden");
        renderExtrasList();
      }

      async function saveExtrasForTree() {
        if (!currentExtrasTreeId) return;
        if (!token) { alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t, hÃ£y Ä‘Äƒng nháº­p láº¡i."); return; }
        // map â†’ key auto theo label (náº¿u thiáº¿u)
        const payload = tempExtras.map((f) => ({
          key: (f.key || (f.label || "").toLowerCase().replace(/\s+/g,"_")).slice(0,64),
          label: f.label || "",
          value: f.value || "",
          showPublic: !!f.showPublic,
        }));
        try {
          const res = await fetch(`${API_BASE}/api/trees/${currentExtrasTreeId}/extras`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ extraFields: payload }),
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error || "KhÃ´ng thá»ƒ lÆ°u trÆ°á»ng tuá»³ biáº¿n"); return; }
          alert("âœ… ÄÃ£ lÆ°u trÆ°á»ng tuá»³ biáº¿n");
          closeModal("extras-modal");
          loadTrees();
        } catch (err) { console.error(err); alert("Lá»—i khi lÆ°u trÆ°á»ng tuá»³ biáº¿n"); }
      }

      // ====== DOM READY ======
      document.addEventListener("DOMContentLoaded", () => {
        loadAreas(); loadDiseaseMaster(); loadStatusMaster();

        // Menu 3 gáº¡ch
        // ====== Sidebar & Hamburger (Mobile) ======
        // ====== Sidebar navigation: show / hide section ======
            const hamburger = document.getElementById("hamburger-btn");
            const sidebar = document.querySelector(".sidebar");
            const sidebarLinks = document.querySelectorAll(".sidebar .nav-item");

            // danh sÃ¡ch section Ä‘Æ°á»£c phÃ©p hiá»ƒn thá»‹
            const sections = ["dashboard", "staff-section", "activity-section"];

            function showOnlySection(id) {
              sections.forEach(secId => {
                const el = document.getElementById(secId);
                if (!el) return;
                el.classList.toggle("hidden", secId !== id);
              });
            }

            if (hamburger && sidebar) {
              hamburger.addEventListener("click", () => {
                hamburger.classList.toggle("open");
                sidebar.classList.toggle("open");
              });
            }

            sidebarLinks.forEach(btn => {
              btn.addEventListener("click", () => {
                const targetId = btn.getAttribute("data-scroll-target");
                if (!targetId) return;

                // chá»‰ hiá»‡n Ä‘Ãºng mÃ n hÃ¬nh
                showOnlySection(targetId);

                // active state
                sidebarLinks.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // Ä‘Ã³ng sidebar mobile
                sidebar.classList.remove("open");
                hamburger.classList.remove("open");
              });
            });
;
        // Area
        const addAreaBtn = document.getElementById("add-area-btn");
        if (addAreaBtn) addAreaBtn.addEventListener("click", addNewArea);

        // Disease
        const addDisBtn = document.getElementById("add-disease-btn");
        const saveDisBtn = document.getElementById("save-disease-btn");
        if (addDisBtn) addDisBtn.addEventListener("click", addNewDisease);
        if (saveDisBtn) saveDisBtn.addEventListener("click", saveDiseaseForTree);

        // Status
        const addStatusBtn = document.getElementById("add-status-btn");
        const saveStatusBtn = document.getElementById("save-status-btn");
        if (addStatusBtn) addStatusBtn.addEventListener("click", addNewStatus);
        if (saveStatusBtn) saveStatusBtn.addEventListener("click", saveStatusForTree);

        // Display config
        const displayBtn = document.getElementById("display-config-btn");
        const saveDisplayBtn = document.getElementById("save-display-config-btn");
        if (displayBtn) displayBtn.addEventListener("click", openDisplayConfigModal);
        if (saveDisplayBtn) saveDisplayBtn.addEventListener("click", saveDisplayConfig);

        // Staff
        const staffForm = document.getElementById("staff-form");
        if (staffForm) staffForm.addEventListener("submit", createStaff);

        // Search & filter
        const searchInput = document.getElementById("tree-search-input");
        if (searchInput) {
          searchInput.addEventListener("input", () => {
            treeSearchTerm = searchInput.value || "";
            renderTreeList();
          });
        }
        const filterButtons = document.querySelectorAll("[data-tree-filter]");
        filterButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const value = btn.getAttribute("data-tree-filter") || "all";
            treeStatusFilter = value;
            filterButtons.forEach((b) => b.classList.toggle("active", b === btn));
            renderTreeList();
          });
        });

        // Extras modal buttons
        const addExtraBtn = document.getElementById("add-extra-btn");
        const saveExtrasBtn = document.getElementById("save-extras-btn");
        if (addExtraBtn) addExtraBtn.addEventListener("click", () => { tempExtras.push({ label:"", value:"", showPublic:false }); renderExtrasList(); });
        if (saveExtrasBtn) saveExtrasBtn.addEventListener("click", saveExtrasForTree);

        // Auto login
        if (token && currentUser) setupAfterLogin();
      });

      // Expose
      window.openQrModal = openQrModal;
      window.closeModal = closeModal;
      window.openYield = openYield;
      window.openDiseaseModal = openDiseaseModal;
      window.openStatusModal = openStatusModal;
      window.deleteStaff = deleteStaff;
      window.deleteTree = deleteTree;
      window.openEditTree = openEditTree;
      window.openExtrasModal = openExtrasModal;
    </script>
  </div> <!-- end app-layout -->

  </body>
</html>