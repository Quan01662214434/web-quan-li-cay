<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Thanh Huy·ªÅn Smart Farm</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="app-shell">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-logo">
          <div class="logo-circle">üåø</div>
          <div class="sidebar-logo-text">
            <div class="sidebar-title">THANH HUY·ªÄN</div>
            <div class="sidebar-subtitle">Smart Farm System</div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-label">H·ªá th·ªëng</div>
            <button
              class="nav-item nav-item-active"
              id="nav-public"
              type="button"
            >
              <span>Trang gi·ªõi thi·ªáu</span>
            </button>
            <button class="nav-item" id="nav-farm" type="button">
              <span>V∆∞·ªùn c·ªßa t√¥i</span>
            </button>
            <button class="nav-item" id="nav-admin" type="button">
              <span>Qu·∫£n tr·ªã h·ªá th·ªëng</span>
            </button>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="sidebar-footer-text">
            <div class="sf-title">Thanh Huy·ªÅn Smart Farm</div>
            <div class="sf-sub">Qu·∫£n l√Ω c√¢y & nh√¢n s·ª± theo QR</div>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <div class="main-area">
        <!-- TOPBAR -->
        <header class="topbar">
          <div>
            <div class="topbar-title">Thanh Huy·ªÅn Smart Farm</div>
            <div class="topbar-subtitle" id="topbar-subtitle">
              Gi·∫£i ph√°p qu·∫£n l√Ω v∆∞·ªùn, c√¢y v√† nh√¢n s·ª± theo m√£ QR
            </div>
          </div>
          <div class="topbar-right">
            <button class="btn-ghost small" id="logout-btn" style="display: none">
              ƒêƒÉng xu·∫•t
            </button>
            <div class="user-chip" id="user-chip" style="display: none">
              ƒêang ƒëƒÉng nh·∫≠p: <span id="user-chip-name"></span>
            </div>
          </div>
        </header>

        <!-- CONTENT -->
        <main class="main-content">
          <!-- VIEW: CH∆ØA ƒêƒÇNG NH·∫¨P -->
          <section id="public-view" class="view">
            <div class="card hero-public">
              <div class="hero-public-main">
                <div>
                  <div class="hero-kicker">THANH HUY·ªÄN SMART FARM</div>
                  <h1 class="hero-heading">
                    N·ªÅn t·∫£ng qu·∫£n l√Ω v∆∞·ªùn & m√£ QR cho n√¥ng nghi·ªáp hi·ªán ƒë·∫°i
                  </h1>
                  <p class="hero-text">
                    Theo d√µi t√¨nh tr·∫°ng t·ª´ng c√¢y, ph√¢n quy·ªÅn ch·ªß v∆∞·ªùn & nh√¢n
                    vi√™n, l∆∞u l·ªãch s·ª≠ chƒÉm s√≥c ‚Äì t·∫•t c·∫£ tr√™n m·ªôt h·ªá th·ªëng.
                  </p>
                  <ul class="hero-bullets">
                    <li>Qu·∫£n l√Ω c√¢y theo gi·ªëng, l√¥ v√† v·ªã tr√≠ c·ª• th·ªÉ</li>
                    <li>M√£ QR cho t·ª´ng c√¢y ‚Äì qu√©t l√† xem ƒë∆∞·ª£c t√¨nh tr·∫°ng</li>
                    <li>Ph√¢n quy·ªÅn Admin ¬∑ Ch·ªß v∆∞·ªùn ¬∑ Nh√¢n vi√™n r√µ r√†ng</li>
                  </ul>
                </div>
              </div>
              <div class="hero-public-side">
                <div class="card login-card">
                  <div class="card-header">
                    <div>
                      <div class="card-title">ƒêƒÉng nh·∫≠p h·ªá th·ªëng</div>
                      <div class="card-desc">
                        D√†nh cho Admin, Ch·ªß v∆∞·ªùn v√† Nh√¢n vi√™n.
                      </div>
                    </div>
                  </div>
                  <form id="login-form">
                    <label for="login-username">T√†i kho·∫£n</label>
                    <input
                      id="login-username"
                      placeholder="V√≠ d·ª•: admin"
                      autocomplete="username"
                    />
                    <label for="login-password">M·∫≠t kh·∫©u</label>
                    <input
                      id="login-password"
                      type="password"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      autocomplete="current-password"
                    />
                    <div class="form-footer">
                      <button type="submit" class="btn">ƒêƒÉng nh·∫≠p</button>
                      <div class="muted small">
                        N·∫øu ch∆∞a c√≥ t√†i kho·∫£n, li√™n h·ªá qu·∫£n tr·ªã.
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- C√ÇY T·ª™ QR (KHI V√ÄO ?tree=xxx) -->
            <div id="qr-tree-preview" class="card" style="display: none">
              <div class="card-header">
                <div>
                  <div class="card-title">Th√¥ng tin c√¢y t·ª´ m√£ QR</div>
                  <div class="card-desc">
                    ƒê√¢y l√† th√¥ng tin ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ h·ªá th·ªëng Thanh Huy·ªÅn
                    Smart Farm.
                  </div>
                </div>
              </div>
              <div class="qr-tree-details">
                <div class="qr-tree-main">
                  <div class="qr-tree-id" id="qr-tree-preview-id">#‚Äî</div>
                  <div>
                    <div class="qr-tree-name" id="qr-tree-preview-name">
                      T√™n c√¢y
                    </div>
                    <div class="qr-tree-meta" id="qr-tree-preview-meta">
                      Gi·ªëng ¬∑ V·ªã tr√≠ ¬∑ Ch·ªß v∆∞·ªùn
                    </div>
                  </div>
                </div>
                <div class="qr-tree-health" id="qr-tree-preview-health">
                  T√¨nh tr·∫°ng
                </div>
                <div class="qr-tree-notes" id="qr-tree-preview-notes"></div>
              </div>
            </div>

            <!-- Tin t·ª©c n√¥ng nghi·ªáp -->
            <div class="card public-news-card">
              <div class="card-header">
                <div>
                  <div class="card-title">B·∫£n tin n√¥ng nghi·ªáp</div>
                  <div class="card-desc">
                    C√¢u chuy·ªán xoay quanh s·∫ßu ri√™ng, b∆∞·ªüi, m√≠t v√† canh t√°c
                    b·ªÅn v·ªØng.
                  </div>
                </div>
              </div>
              <div class="public-news-grid">
                <article class="news-item">
                  <div class="news-label">K·ª∏ THU·∫¨T</div>
                  <h3 class="news-title">
                    Qu·∫£n l√Ω s√¢u b·ªánh tr√™n s·∫ßu ri√™ng m√πa m∆∞a
                  </h3>
                  <p class="news-text">
                    Ghi ch√©p t·ª´ng l·∫ßn phun thu·ªëc, b√≥n ph√¢n theo t·ª´ng c√¢y gi√∫p
                    ki·ªÉm so√°t l∆∞·ª£ng s·ª≠ d·ª•ng v√† t·ªëi ∆∞u chi ph√≠.
                  </p>
                </article>

                <article class="news-item">
                  <div class="news-label">CHUY·ªÜN V∆Ø·ªúN</div>
                  <h3 class="news-title">
                    M·ªôt v∆∞·ªùn ‚Äì nhi·ªÅu nh√¢n vi√™n, qu·∫£n l√Ω sao cho g·ªçn?
                  </h3>
                  <p class="news-text">
                    Ph√¢n quy·ªÅn nh√¢n vi√™n theo v∆∞·ªùn, giao nhi·ªám v·ª• chƒÉm s√≥c
                    theo l√¥ c√¢y v√† ki·ªÉm tra ti·∫øn ƒë·ªô ngay tr√™n h·ªá th·ªëng.
                  </p>
                </article>

                <article class="news-item">
                  <div class="news-label">C√îNG NGH·ªÜ</div>
                  <h3 class="news-title">
                    M√£ QR cho t·ª´ng c√¢y ‚Äì nh√¨n l√† bi·∫øt t√¨nh tr·∫°ng
                  </h3>
                  <p class="news-text">
                    M·ªói c√¢y c√≥ m√£ QR ri√™ng, qu√©t b·∫±ng ƒëi·ªán tho·∫°i ƒë·ªÉ xem l·ªãch
                    s·ª≠ chƒÉm s√≥c, ghi ch√∫ v√† t√¨nh tr·∫°ng s·ª©c kh·ªèe.
                  </p>
                </article>
              </div>
            </div>

            <!-- C√°c v∆∞·ªùn ƒëang d√πng h·ªá th·ªëng -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">
                    C√°c v∆∞·ªùn ƒëang s·ª≠ d·ª•ng Thanh Huy·ªÅn Smart Farm
                  </div>
                  <div class="card-desc">
                    Danh s√°ch n√†y ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ d·ªØ li·ªáu tr√™n h·ªá th·ªëng.
                  </div>
                </div>
                <button
                  id="refresh-public-farms"
                  type="button"
                  class="btn-ghost small"
                >
                  T·∫£i l·∫°i danh s√°ch
                </button>
              </div>
              <div id="public-farm-list" class="public-farm-grid">
                <!-- JS render -->
              </div>
            </div>
          </section>

          <!-- VIEW: V∆Ø·ªúN (owner / staff) -->
          <section id="farm-view" class="view" style="display: none">
            <!-- Hero v∆∞·ªùn -->
            <div class="card">
              <div class="hero-card">
                <div class="hero-main">
                  <div class="hero-logo">üåø</div>
                  <div>
                    <div class="hero-title" id="farm-hero-name">
                      V∆∞·ªùn c·ªßa t√¥i
                    </div>
                    <div class="hero-desc" id="farm-hero-desc">
                      Th√¥ng tin t·ªïng quan c√¢y v√† t√¨nh tr·∫°ng chƒÉm s√≥c.
                    </div>
                  </div>
                </div>
                <div class="hero-stats">
                  <div class="hero-stat">
                    <div class="hero-stat-label">T·ªïng s·ªë c√¢y</div>
                    <div class="hero-stat-value" id="stat-total-trees">0</div>
                  </div>
                  <div class="hero-stat">
                    <div class="hero-stat-label">C√¢y c·∫ßn ch√∫ √Ω</div>
                    <div
                      class="hero-stat-value danger"
                      id="stat-bad-trees"
                    >
                      0
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form t·∫°o c√¢y (ch·ªß v∆∞·ªùn) -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">T·∫°o c√¢y m·ªõi</div>
                  <div class="card-desc">
                    Nh·∫≠p t√™n, gi·ªëng, v·ªã tr√≠ v√† ng√†y tr·ªìng. H·ªá th·ªëng s·∫Ω t·ª± t·∫°o
                    m√£ QR li√™n k·∫øt t·ªõi c√¢y.
                  </div>
                </div>
              </div>
              <form id="create-tree-form">
                <div class="field-row">
                  <div>
                    <label for="tree-name">T√™n c√¢y *</label>
                    <input
                      id="tree-name"
                      placeholder="VD: S·∫ßu ri√™ng 01, M√≠t Th√°i 03"
                    />
                  </div>
                  <div>
                    <label for="tree-species">Gi·ªëng</label>
                    <input
                      id="tree-species"
                      placeholder="VD: Ri6, Dona, B∆∞·ªüi da xanh..."
                    />
                  </div>
                </div>
                <div class="field-row">
                  <div>
                    <label for="tree-location">V·ªã tr√≠</label>
                    <input
                      id="tree-location"
                      placeholder="VD: H√†ng B, √¥ s·ªë 12"
                    />
                  </div>
                  <div>
                    <label for="tree-plant-date">Ng√†y tr·ªìng</label>
                    <input
                      id="tree-plant-date"
                      type="date"
                      placeholder="YYYY-MM-DD"
                    />
                  </div>
                </div>
                <div class="form-footer">
                  <button type="submit" id="create-tree-btn" class="btn">
                    T·∫°o c√¢y & QR
                  </button>
                  <div class="muted small">
                    Nh√¢n vi√™n ch·ªâ xem v√† c·∫≠p nh·∫≠t t√¨nh tr·∫°ng, kh√¥ng t·∫°o c√¢y.
                  </div>
                </div>
              </form>
            </div>

            <!-- Danh s√°ch c√¢y -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Danh s√°ch c√¢y trong v∆∞·ªùn</div>
                  <div class="card-desc">
                    C·∫≠p nh·∫≠t t√¨nh tr·∫°ng s·ª©c kh·ªèe, ghi ch√∫ v√† xem m√£ QR.
                  </div>
                </div>
              </div>
              <div class="filter-row">
                <button
                  type="button"
                  class="pill-filter active"
                  data-health="all"
                >
                  T·∫•t c·∫£
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="T·ªët"
                >
                  T·ªët
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="B√¨nh th∆∞·ªùng"
                >
                  B√¨nh th∆∞·ªùng
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="Y·∫øu"
                >
                  Y·∫øu
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="Nguy hi·ªÉm"
                >
                  Nguy hi·ªÉm
                </button>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>C√¢y</th>
                      <th>Gi·ªëng</th>
                      <th>V·ªã tr√≠</th>
                      <th>T√¨nh tr·∫°ng</th>
                      <th>Ghi ch√∫</th>
                      <th>QR</th>
                      <th>C·∫≠p nh·∫≠t</th>
                      <th>Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody id="tree-table-body">
                    <tr>
                      <td colspan="9" class="empty-text">
                        Ch∆∞a c√≥ d·ªØ li·ªáu.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- VIEW: ADMIN -->
          <section id="admin-view" class="view" style="display: none">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</div>
                  <div class="card-desc">
                    T·∫°o ch·ªß v∆∞·ªùn, nh√¢n vi√™n, theo d√µi to√†n b·ªô c√¢y trong h·ªá
                    th·ªëng.
                  </div>
                </div>
              </div>
              <div class="stats-row">
                <div class="stat-card">
                  <div class="stat-label">T·ªïng s·ªë ch·ªß v∆∞·ªùn</div>
                  <div class="stat-value" id="admin-stat-owners">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">T·ªïng s·ªë nh√¢n vi√™n</div>
                  <div class="stat-value" id="admin-stat-staff">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">T·ªïng s·ªë c√¢y</div>
                  <div class="stat-value" id="admin-stat-trees">0</div>
                </div>
              </div>
            </div>

            <div class="admin-grid">
              <!-- Qu·∫£n l√Ω user -->
              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title">Qu·∫£n l√Ω t√†i kho·∫£n</div>
                    <div class="card-desc">
                      T·∫°o ch·ªß v∆∞·ªùn, nh√¢n vi√™n v√† ch·ªânh s·ª≠a th√¥ng tin c∆° b·∫£n.
                    </div>
                  </div>
                </div>
                <form id="admin-create-user-form">
                  <div class="field-row">
                    <div>
                      <label for="admin-username">T√†i kho·∫£n *</label>
                      <input
                        id="admin-username"
                        placeholder="VD: vuon_thanh_huyen"
                      />
                    </div>
                    <div>
                      <label for="admin-password">M·∫≠t kh·∫©u *</label>
                      <input
                        id="admin-password"
                        type="password"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      />
                    </div>
                  </div>
                  <div class="field-row">
                    <div>
                      <label for="admin-role">Vai tr√≤</label>
                      <select id="admin-role">
                        <option value="owner">Ch·ªß v∆∞·ªùn</option>
                        <option value="staff">Nh√¢n vi√™n</option>
                      </select>
                    </div>
                    <div>
                      <label for="admin-farm-name">T√™n v∆∞·ªùn (cho ch·ªß v∆∞·ªùn)</label>
                      <input
                        id="admin-farm-name"
                        placeholder="VD: V∆∞·ªùn s·∫ßu ri√™ng Thanh Huy·ªÅn"
                      />
                    </div>
                  </div>
                  <div class="form-footer">
                    <button type="submit" class="btn">
                      T·∫°o t√†i kho·∫£n
                    </button>
                    <div class="muted small">
                      Nh√¢n vi√™n c√≥ th·ªÉ ƒë∆∞·ª£c g√°n v√†o ch·ªß v∆∞·ªùn sau.
                    </div>
                  </div>
                </form>

                <div class="table-wrapper" style="margin-top: 10px">
                  <table>
                    <thead>
                      <tr>
                        <th>T√†i kho·∫£n</th>
                        <th>Vai tr√≤</th>
                        <th>V∆∞·ªùn</th>
                        <th>Ch·ªß v∆∞·ªùn</th>
                      </tr>
                    </thead>
                    <tbody id="admin-user-table-body">
                      <tr>
                        <td colspan="4" class="empty-text">
                          ƒêang t·∫£i t√†i kho·∫£n...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- To√†n b·ªô c√¢y -->
              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title">To√†n b·ªô c√¢y trong h·ªá th·ªëng</div>
                    <div class="card-desc">
                      D√πng ƒë·ªÉ gi√°m s√°t nhanh t√¨nh tr·∫°ng c√°c v∆∞·ªùn.
                    </div>
                  </div>
                </div>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>C√¢y</th>
                        <th>T√¨nh tr·∫°ng</th>
                        <th>Ch·ªß v∆∞·ªùn</th>
                      </tr>
                    </thead>
                    <tbody id="admin-tree-table-body">
                      <tr>
                        <td colspan="4" class="empty-text">
                          ƒêang t·∫£i d·ªØ li·ªáu...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- QR MODAL -->
    <div id="qr-modal-backdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">M√£ QR c√¢y</div>
            <div class="modal-subtitle">
              Qu√©t b·∫±ng ƒëi·ªán tho·∫°i ƒë·ªÉ truy c·∫≠p nhanh v√†o th√¥ng tin c√¢y.
            </div>
          </div>
          <button id="qr-modal-close" class="btn-ghost small" type="button">
            ƒê√≥ng
          </button>
        </div>
        <div class="modal-body">
          <img id="qr-modal-img" class="qr-modal-img" src="" alt="QR Code" />

          <div class="qr-info">
            <div class="qr-info-line">
              <span class="qr-label">T√™n c√¢y:</span>
              <span id="qr-tree-name" class="qr-value"></span>
            </div>
            <div class="qr-info-line">
              <span class="qr-label">V·ªã tr√≠:</span>
              <span id="qr-tree-location" class="qr-value"></span>
            </div>
            <div class="qr-info-line">
              <span class="qr-label">Ch·ªß v∆∞·ªùn:</span>
              <span id="qr-tree-owner" class="qr-value"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <script>
      // ==== CONFIG API ====
      const API_BASE = "https://api.thefram.site";
      // Khi test tr√™n m√°y:
      // const API_BASE = "http://localhost:4000";

      let currentUser = null;
      let authToken = null;
      let treesCache = [];
      let publicFarmsCache = [];

      // === THEME ===
      function hexToRgba(hex, alpha) {
        try {
          let c = hex.replace("#", "");
          if (c.length === 3) {
            c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2];
          }
          const r = parseInt(c.slice(0, 2), 16);
          const g = parseInt(c.slice(2, 4), 16);
          const b = parseInt(c.slice(4, 6), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        } catch (e) {
          return "rgba(22, 163, 74, 0.18)";
        }
      }

      function applyThemeForUser(user) {
        const root = document.documentElement;
        const color =
          (user && user.farmPrimaryColor && user.farmPrimaryColor.trim()) ||
          "#16a34a";
        root.style.setProperty("--accent", color);
        root.style.setProperty("--accent-soft", hexToRgba(color, 0.18));
      }

      // === TOAST ===
      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.toggle("error", isError);
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 2500);
      }

      // === VIEW SWITCH ===
      function showView(viewId) {
        const views = ["public-view", "farm-view", "admin-view"];
        views.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = id === viewId ? "block" : "none";
        });

        document.querySelectorAll(".nav-item").forEach((btn) => {
          btn.classList.remove("nav-item-active");
        });
        if (viewId === "public-view") {
          document.getElementById("nav-public").classList.add("nav-item-active");
        } else if (viewId === "farm-view") {
          document.getElementById("nav-farm").classList.add("nav-item-active");
        } else if (viewId === "admin-view") {
          document.getElementById("nav-admin").classList.add("nav-item-active");
        }
      }

      function updateTopbarInfo() {
        const chip = document.getElementById("user-chip");
        const chipName = document.getElementById("user-chip-name");
        const logoutBtn = document.getElementById("logout-btn");
        const subtitle = document.getElementById("topbar-subtitle");

        if (!currentUser) {
          chip.style.display = "none";
          logoutBtn.style.display = "none";
          subtitle.textContent =
            "Gi·∫£i ph√°p qu·∫£n l√Ω v∆∞·ªùn, c√¢y v√† nh√¢n s·ª± theo m√£ QR";
          return;
        }

        chip.style.display = "inline-flex";
        logoutBtn.style.display = "inline-flex";
        chipName.textContent = `${currentUser.username} (${currentUser.role})`;

        if (currentUser.role === "admin") {
          subtitle.textContent = "B·∫£ng ƒëi·ªÅu khi·ªÉn c·ªßa qu·∫£n tr·ªã h·ªá th·ªëng";
        } else if (currentUser.role === "owner") {
          subtitle.textContent =
            currentUser.farmName || "Trang qu·∫£n l√Ω v∆∞·ªùn c·ªßa b·∫°n";
        } else {
          subtitle.textContent = "Trang l√†m vi·ªác cho nh√¢n vi√™n v∆∞·ªùn";
        }
      }

      function updateUIForLoggedOut() {
        currentUser = null;
        authToken = null;
        applyThemeForUser(null);
        updateTopbarInfo();
        showView("public-view");
        loadPublicFarms();
      }

      function updateUIAfterLogin() {
        if (!currentUser) return;
        applyThemeForUser(currentUser);
        updateTopbarInfo();

        if (currentUser.role === "admin") {
          showView("admin-view");
          loadAdminUsers();
          loadAdminTrees();
        } else {
          showView("farm-view");
          loadTrees();
        }
      }

      // === API WRAPPER ===
      async function apiFetch(url, options = {}) {
        const headers = options.headers || {};
        if (authToken) {
          headers["Authorization"] = `Bearer ${authToken}`;
        }
        if (!headers["Content-Type"] && options.body) {
          headers["Content-Type"] = "application/json";
        }
        const res = await fetch(url, { ...options, headers });
        let data = null;
        try {
          data = await res.json();
        } catch (e) {}
        if (!res.ok) {
          const msg = (data && data.error) || "L·ªói k·∫øt n·ªëi server";
          throw new Error(msg);
        }
        return data;
      }

      // === LOGIN / LOGOUT ===
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("login-username").value.trim();
          const password = document.getElementById("login-password").value.trim();
          if (!username || !password) {
            showToast("Vui l√≤ng nh·∫≠p t√†i kho·∫£n v√† m·∫≠t kh·∫©u", true);
            return;
          }
          try {
            const data = await apiFetch(`${API_BASE}/auth/login`, {
              method: "POST",
              body: JSON.stringify({ username, password }),
            });
            authToken = data.token;
            currentUser = data.user;
            localStorage.setItem("authToken", authToken);
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
            updateUIAfterLogin();
          } catch (err) {
            showToast(err.message, true);
          }
        });

      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("authToken");
        localStorage.removeItem("currentUser");
        showToast("ƒê√£ ƒëƒÉng xu·∫•t");
        updateUIForLoggedOut();
      });

      // === NAV BUTTONS ===
      document.getElementById("nav-public").addEventListener("click", () => {
        if (!currentUser) {
          showView("public-view");
        } else if (currentUser.role === "admin") {
          showView("admin-view");
        } else {
          showView("farm-view");
        }
      });
      document.getElementById("nav-farm").addEventListener("click", () => {
        if (!currentUser) {
          showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ v√†o v∆∞·ªùn", true);
          return;
        }
        if (currentUser.role === "admin") {
          showToast("ƒê√¢y l√† giao di·ªán d√†nh cho ch·ªß v∆∞·ªùn / nh√¢n vi√™n", false);
        }
        showView("farm-view");
        loadTrees();
      });
      document.getElementById("nav-admin").addEventListener("click", () => {
        if (!currentUser || currentUser.role !== "admin") {
          showToast("Ch·ªâ admin m·ªõi truy c·∫≠p ƒë∆∞·ª£c ph·∫ßn n√†y", true);
          return;
        }
        showView("admin-view");
        loadAdminUsers();
        loadAdminTrees();
      });

      // === PUBLIC FARMS ===
      async function loadPublicFarms() {
        try {
          const farms = await apiFetch(`${API_BASE}/public/farms`, {
            method: "GET",
          }).catch(() => []);
          publicFarmsCache = farms || [];
        } catch (e) {
          publicFarmsCache = [];
        }
        renderPublicFarms();
      }

      function renderPublicFarms() {
        const container = document.getElementById("public-farm-list");
        if (!publicFarmsCache || publicFarmsCache.length === 0) {
          container.innerHTML =
            '<div class="empty-text">Hi·ªán ch∆∞a c√≥ v∆∞·ªùn c√¥ng khai tr√™n h·ªá th·ªëng.</div>';
          return;
        }
        container.innerHTML = publicFarmsCache
          .map((farm) => {
            const name = farm.farmName || "Ch∆∞a ƒë·∫∑t t√™n v∆∞·ªùn";
            const owner = farm.username || "";
            const initials = name
              .split(" ")
              .filter(Boolean)
              .map((w) => w[0])
              .join("")
              .slice(0, 2)
              .toUpperCase();
            const color = farm.farmPrimaryColor || "#16a34a";
            const created =
              farm.createdAt && farm.createdAt.slice(0, 10).replace("T", " ");
            return `
          <div class="public-farm-card">
            <div class="public-farm-logo" style="background: linear-gradient(135deg, ${color}, #16a34a);">
              <span>${initials}</span>
            </div>
            <div class="public-farm-main">
              <div class="public-farm-name">${name}</div>
              <div class="public-farm-meta">
                Ch·ªß v∆∞·ªùn: <strong>${owner}</strong>${
              created ? " ¬∑ Tham gia: " + created : ""
            }
              </div>
            </div>
          </div>
        `;
          })
          .join("");
      }

      document
        .getElementById("refresh-public-farms")
        .addEventListener("click", () => {
          loadPublicFarms();
        });

      // === TREES (owner / staff) ===
      async function loadTrees() {
        try {
          const trees = await apiFetch(`${API_BASE}/api/trees`, { method: "GET" });
          treesCache = trees || [];
          renderTrees();
        } catch (err) {
          showToast("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¢y: " + err.message, true);
        }
      }

      function renderTrees(filterHealth = "all") {
        const body = document.getElementById("tree-table-body");
        if (!treesCache || treesCache.length === 0) {
          body.innerHTML =
            '<tr><td colspan="9" class="empty-text">Ch∆∞a c√≥ c√¢y n√†o trong v∆∞·ªùn.</td></tr>';
          document.getElementById("stat-total-trees").textContent = "0";
          document.getElementById("stat-bad-trees").textContent = "0";
          return;
        }

        let filtered = treesCache;
        if (filterHealth !== "all") {
          filtered = treesCache.filter((t) => t.currentHealth === filterHealth);
        }

        if (!filtered.length) {
          body.innerHTML =
            '<tr><td colspan="9" class="empty-text">Kh√¥ng c√≥ c√¢y n√†o kh·ªõp b·ªô l·ªçc.</td></tr>';
        } else {
          body.innerHTML = filtered
            .map((tree) => {
              const id = tree.numericId || "";
              const name = tree.name || "";
              const species = tree.species || "";
              const location = tree.location || "";
              const health = tree.currentHealth || "";
              const notes = tree.notes || "";
              const updated =
                (tree.updatedAt && tree.updatedAt.slice(0, 10)) || "";
              const canDelete =
                currentUser &&
                (currentUser.role === "admin" ||
                  (currentUser.role === "owner" &&
                    tree.owner &&
                    tree.owner._id === currentUser.id));
              return `
          <tr>
            <td>${id}</td>
            <td>${name}</td>
            <td>${species}</td>
            <td>${location}</td>
            <td>${health}</td>
            <td>${notes}</td>
            <td>
              ${
                tree.qrCode
                  ? `<button class="btn-table" type="button" onclick="openQrModal('${tree._id}')">Xem QR</button>`
                  : '<span class="qr-thumb-empty">Ch∆∞a c√≥</span>'
              }
            </td>
            <td>${updated}</td>
            <td>
              <button class="btn-table" type="button" onclick="updateTreePrompt('${tree._id}')">
                C·∫≠p nh·∫≠t
              </button>
              ${
                canDelete
                  ? `<button class="btn-table danger-btn" type="button" onclick="deleteTree('${tree._id}')">Xo√°</button>`
                  : ""
              }
            </td>
          </tr>
        `;
            })
            .join("");
        }

        document.getElementById("stat-total-trees").textContent =
          treesCache.length.toString();
        const badCount = treesCache.filter((t) =>
          ["Y·∫øu", "Nguy hi·ªÉm"].includes(t.currentHealth)
        ).length;
        document.getElementById("stat-bad-trees").textContent =
          badCount.toString();

        const heroNameEl = document.getElementById("farm-hero-name");
        const heroDescEl = document.getElementById("farm-hero-desc");
        if (currentUser && currentUser.role === "owner") {
          heroNameEl.textContent = currentUser.farmName || "V∆∞·ªùn c·ªßa b·∫°n";
          heroDescEl.textContent = `Ch·ªß v∆∞·ªùn: ${currentUser.username}`;
        } else if (currentUser && currentUser.role === "staff") {
          heroNameEl.textContent = currentUser.farmName || "V∆∞·ªùn ƒëang ƒë∆∞·ª£c ph√¢n c√¥ng";
          heroDescEl.textContent = `Nh√¢n vi√™n: ${currentUser.username}`;
        }
      }

      document.querySelectorAll(".pill-filter").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".pill-filter")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const h = btn.getAttribute("data-health");
          renderTrees(h || "all");
        });
      });

      // t·∫°o c√¢y
      document
        .getElementById("create-tree-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentUser || currentUser.role !== "owner") {
            showToast("Ch·ªâ ch·ªß v∆∞·ªùn m·ªõi ƒë∆∞·ª£c t·∫°o c√¢y m·ªõi", true);
            return;
          }
          const name = document.getElementById("tree-name").value.trim();
          const species = document.getElementById("tree-species").value.trim();
          const location = document.getElementById("tree-location").value.trim();
          const plantDate = document
            .getElementById("tree-plant-date")
            .value.trim();

          if (!name) {
            showToast("Vui l√≤ng nh·∫≠p t√™n c√¢y", true);
            return;
          }

          try {
            const newTree = await apiFetch(`${API_BASE}/api/trees`, {
              method: "POST",
              body: JSON.stringify({
                name,
                species,
                location,
                plantDate,
              }),
            });
            showToast("T·∫°o c√¢y th√†nh c√¥ng");
            treesCache.unshift(newTree);
            renderTrees(
              document.querySelector(".pill-filter.active").dataset.health ||
                "all"
            );
            e.target.reset();
          } catch (err) {
            showToast("Kh√¥ng th·ªÉ t·∫°o c√¢y: " + err.message, true);
          }
        });

      // update tree (prompt)
      window.updateTreePrompt = async function (id) {
        const tree = treesCache.find((t) => t._id === id);
        if (!tree) return;
        const health = prompt(
          "Nh·∫≠p t√¨nh tr·∫°ng (T·ªët / B√¨nh th∆∞·ªùng / Y·∫øu / Nguy hi·ªÉm):",
          tree.currentHealth || "B√¨nh th∆∞·ªùng"
        );
        if (!health) return;
        const notes = prompt("Ghi ch√∫ chƒÉm s√≥c:", tree.notes || "");
        try {
          const updated = await apiFetch(
            `${API_BASE}/api/trees/${id}/health`,
            {
              method: "PATCH",
              body: JSON.stringify({ currentHealth: health, notes }),
            }
          );
          showToast("ƒê√£ c·∫≠p nh·∫≠t c√¢y");
          const idx = treesCache.findIndex((t) => t._id === id);
          if (idx >= 0) treesCache[idx] = updated.tree;
          renderTrees(
            document.querySelector(".pill-filter.active").dataset.health ||
              "all"
          );
        } catch (err) {
          showToast("L·ªói c·∫≠p nh·∫≠t c√¢y: " + err.message, true);
        }
      };

      // delete tree
      window.deleteTree = async function (id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° c√¢y n√†y?")) return;
        try {
          await apiFetch(`${API_BASE}/api/trees/${id}`, { method: "DELETE" });
          treesCache = treesCache.filter((t) => t._id !== id);
          renderTrees(
            document.querySelector(".pill-filter.active").dataset.health ||
              "all"
          );
          showToast("ƒê√£ xo√° c√¢y");
        } catch (err) {
          showToast("Kh√¥ng th·ªÉ xo√° c√¢y: " + err.message, true);
        }
      };

      // QR modal (t·ª´ list c√¢y)
      window.openQrModal = function (id) {
        const tree = treesCache.find((t) => t._id === id);
        if (!tree) return;
        const modal = document.getElementById("qr-modal-backdrop");
        const img = document.getElementById("qr-modal-img");
        const nameEl = document.getElementById("qr-tree-name");
        const locationEl = document.getElementById("qr-tree-location");
        const ownerEl = document.getElementById("qr-tree-owner");

        img.src = tree.qrCode || "";
        nameEl.textContent = tree.name || "‚Äî";
        locationEl.textContent = tree.location || "‚Äî";

        const ownerName =
          (tree.owner && (tree.owner.farmName || tree.owner.username)) ||
          (currentUser && currentUser.farmName) ||
          (currentUser && currentUser.username) ||
          "‚Äî";
        ownerEl.textContent = ownerName;

        modal.classList.add("show");
      };

      document
        .getElementById("qr-modal-close")
        .addEventListener("click", () => {
          document
            .getElementById("qr-modal-backdrop")
            .classList.remove("show");
        });
      document
        .getElementById("qr-modal-backdrop")
        .addEventListener("click", (e) => {
          if (e.target.id === "qr-modal-backdrop") {
            document
              .getElementById("qr-modal-backdrop")
              .classList.remove("show");
          }
        });

      // === ADMIN ===
      async function loadAdminUsers() {
        if (!currentUser || currentUser.role !== "admin") return;
        try {
          const users = await apiFetch(`${API_BASE}/admin/users`, {
            method: "GET",
          });
          renderAdminUsers(users || []);
        } catch (err) {
          showToast("Kh√¥ng th·ªÉ t·∫£i t√†i kho·∫£n: " + err.message, true);
        }
      }

      function renderAdminUsers(users) {
        const body = document.getElementById("admin-user-table-body");
        if (!users.length) {
          body.innerHTML =
            '<tr><td colspan="4" class="empty-text">Ch∆∞a c√≥ t√†i kho·∫£n n√†o.</td></tr>';
          document.getElementById("admin-stat-owners").textContent = "0";
          document.getElementById("admin-stat-staff").textContent = "0";
          return;
        }
        let owners = 0;
        let staff = 0;
        body.innerHTML = users
          .map((u) => {
            if (u.role === "owner") owners++;
            if (u.role === "staff") staff++;
            return `
        <tr>
          <td>${u.username}</td>
          <td>
            <span class="badge-role ${u.role}">${u.role}</span>
          </td>
          <td>${u.farmName || ""}</td>
          <td>${u.farmOwner ? u.farmOwner.username || "" : ""}</td>
        </tr>
      `;
          })
          .join("");
        document.getElementById("admin-stat-owners").textContent =
          owners.toString();
        document.getElementById("admin-stat-staff").textContent =
          staff.toString();
      }

      async function loadAdminTrees() {
        if (!currentUser || currentUser.role !== "admin") return;
        try {
          const trees = await apiFetch(`${API_BASE}/admin/trees`, {
            method: "GET",
          });
          const body = document.getElementById("admin-tree-table-body");
          if (!trees.length) {
            body.innerHTML =
              '<tr><td colspan="4" class="empty-text">Ch∆∞a c√≥ c√¢y n√†o.</td></tr>';
            document.getElementById("admin-stat-trees").textContent = "0";
            return;
          }
          document.getElementById("admin-stat-trees").textContent =
            trees.length.toString();
          body.innerHTML = trees
            .map((t) => {
              const ownerName =
                (t.owner && (t.owner.farmName || t.owner.username)) || "‚Äî";
              return `
          <tr>
            <td>${t.numericId || ""}</td>
            <td>${t.name || ""}</td>
            <td>${t.currentHealth || ""}</td>
            <td>${ownerName}</td>
          </tr>
        `;
            })
            .join("");
        } catch (err) {
          showToast("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¢y cho admin: " + err.message, true);
        }
      }

      document
        .getElementById("admin-create-user-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentUser || currentUser.role !== "admin") {
            showToast("Ch·ªâ admin m·ªõi t·∫°o t√†i kho·∫£n", true);
            return;
          }
          const username = document
            .getElementById("admin-username")
            .value.trim();
          const password = document
            .getElementById("admin-password")
            .value.trim();
          const role = document.getElementById("admin-role").value;
          const farmName = document
            .getElementById("admin-farm-name")
            .value.trim();

          if (!username || !password) {
            showToast("Vui l√≤ng ƒëi·ªÅn t√†i kho·∫£n v√† m·∫≠t kh·∫©u", true);
            return;
          }

          try {
            const payload = { username, password, role };
            if (role === "owner" && farmName) {
              payload.farmName = farmName;
            }
            await apiFetch(`${API_BASE}/admin/users`, {
              method: "POST",
              body: JSON.stringify(payload),
            });
            showToast("T·∫°o t√†i kho·∫£n th√†nh c√¥ng");
            e.target.reset();
            loadAdminUsers();
          } catch (err) {
            showToast("Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n: " + err.message, true);
          }
        });

      // === QR PUBLIC: L·∫§Y ?tree=xxx ===
      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      async function showPublicTreeFromQr(numericId) {
        const card = document.getElementById("qr-tree-preview");
        const idEl = document.getElementById("qr-tree-preview-id");
        const nameEl = document.getElementById("qr-tree-preview-name");
        const metaEl = document.getElementById("qr-tree-preview-meta");
        const healthEl = document.getElementById("qr-tree-preview-health");
        const notesEl = document.getElementById("qr-tree-preview-notes");

        try {
          const data = await apiFetch(`${API_BASE}/public/tree/${numericId}`, {
            method: "GET",
          });

          card.style.display = "block";
          idEl.textContent = `#${data.numericId}`;
          nameEl.textContent = data.name || "‚Äî";

          const species = data.species || "Ch∆∞a r√µ gi·ªëng";
          const location = data.location || "Ch∆∞a nh·∫≠p v·ªã tr√≠";
          const ownerName =
            (data.owner && (data.owner.farmName || data.owner.username)) ||
            "Ch∆∞a x√°c ƒë·ªãnh ch·ªß v∆∞·ªùn";
          metaEl.textContent = `${species} ¬∑ ${location} ¬∑ ${ownerName}`;

          healthEl.textContent = data.currentHealth || "Kh√¥ng r√µ";
          healthEl.classList.remove("bad", "warn");
          if (data.currentHealth === "Nguy hi·ªÉm" || data.currentHealth === "Y·∫øu") {
            healthEl.classList.add("bad");
          } else if (data.currentHealth === "B√¨nh th∆∞·ªùng") {
            healthEl.classList.add("warn");
          }

          notesEl.textContent =
            data.notes && data.notes.trim()
              ? `Ghi ch√∫: ${data.notes}`
              : "Ch∆∞a c√≥ ghi ch√∫ chƒÉm s√≥c.";
        } catch (err) {
          card.style.display = "block";
          nameEl.textContent = "Kh√¥ng t√¨m th·∫•y c√¢y";
          metaEl.textContent =
            "M√£ QR h·ª£p l·ªá nh∆∞ng h·ªá th·ªëng kh√¥ng t√¨m th·∫•y c√¢y t∆∞∆°ng ·ª©ng.";
          healthEl.textContent = "";
          notesEl.textContent = err.message || "ƒê√£ x·∫£y ra l·ªói.";
        }
      }

      // === INIT ===
      document.addEventListener("DOMContentLoaded", () => {
        const savedToken = localStorage.getItem("authToken");
        const savedUser = localStorage.getItem("currentUser");
        const treeFromQr = getQueryParam("tree");

        if (savedToken && savedUser) {
          authToken = savedToken;
          currentUser = JSON.parse(savedUser);
          applyThemeForUser(currentUser);
          updateUIAfterLogin();
        } else {
          applyThemeForUser(null);
          updateUIForLoggedOut();
          if (treeFromQr) {
            showPublicTreeFromQr(treeFromQr);
          }
        }
      });
    </script>
  </body>
</html>
