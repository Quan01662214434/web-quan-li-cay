<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh Huy·ªÅn Farm - Qu·∫£n l√Ω c√¢y</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <header class="header">
      <div class="logo">
        <img src="logo.svg" alt="Thanh Huy·ªÅn Farm" />
        <h1>Thanh Huy·ªÅn Farm</h1>
      </div>
      <button id="menuBtn" class="menu-btn">‚ò∞</button>
    </header>

    <nav id="sidebar" class="sidebar">
      <ul>
        <li><a id="menuDashboard">üå≥ Qu·∫£n l√Ω c√¢y</a></li>
        <li><a id="menuStaff">üë∑ Nh√¢n vi√™n</a></li>
        <li><a id="menuLogs">üßæ L·ªãch s·ª≠</a></li>
        <li><a id="menuLogout">üö™ ƒêƒÉng xu·∫•t</a></li>
      </ul>
    </nav>

    <!-- LOGIN -->
    <section id="loginSection" class="center">
      <div class="login-card">
        <h2>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>
        <input id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" />
        <input id="password" type="password" placeholder="M·∫≠t kh·∫©u" />
        <button id="loginBtn" class="btn-primary full-width">ƒêƒÉng nh·∫≠p</button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <div class="top-bar">
        <input
          id="searchTree"
          type="text"
          placeholder="üîç T√¨m c√¢y theo t√™n, gi·ªëng, v·ªã tr√≠, m√£ VietGAP..."
        />
        <button id="addTreeBtn" class="btn-primary small">+ C√¢y</button>
      </div>
      <div id="treeList" class="tree-list"></div>
    </section>

    <!-- STAFF -->
    <section id="staffSection" class="hidden">
      <h2>Danh s√°ch nh√¢n vi√™n</h2>
      <div id="staffList"></div>
      <div class="add-staff">
        <input id="newStaffUser" placeholder="T√™n nh√¢n vi√™n" />
        <input
          id="newStaffPass"
          type="password"
          placeholder="M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh"
        />
        <button id="addStaffBtn" class="btn-primary small">Th√™m</button>
      </div>
    </section>

    <!-- LOGS -->
    <section id="logSection" class="hidden">
      <h2>L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h2>
      <div id="logList"></div>
    </section>

    <!-- MODAL TREE -->
    <div id="treeModal" class="modal hidden">
      <div class="modal-content">
        <h3 id="modalTitle">Th√™m c√¢y</h3>
        <input id="treeName" placeholder="T√™n c√¢y" />
        <input id="treeSpecies" placeholder="Gi·ªëng c√¢y" />
        <input id="treeLocation" placeholder="V·ªã tr√≠" />
        <input id="treePlantDate" type="date" />
        <input id="treeVietGapCode" placeholder="M√£ VietGAP" />
        <select id="treeHealth">
          <option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
          <option value="S√¢u b·ªánh">S√¢u b·ªánh</option>
          <option value="Thi·∫øu dinh d∆∞·ª°ng">Thi·∫øu dinh d∆∞·ª°ng</option>
          <option value="Kh√°c">Kh√°c</option>
        </select>
        <textarea id="treeNotes" placeholder="Ghi ch√∫"></textarea>
        <input id="treeArea" placeholder="Khu v·ª±c (VD: A1, B2...)" />

        <button id="saveTreeBtn" class="btn-primary full-width">L∆∞u</button>
        <button id="cancelTreeBtn" class="btn-secondary full-width">
          H·ªßy
        </button>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:4000";
      const token = () => localStorage.getItem("token");

      const loginSection = document.getElementById("loginSection");
      const dashboard = document.getElementById("dashboard");
      const staffSection = document.getElementById("staffSection");
      const logSection = document.getElementById("logSection");
      const sidebar = document.getElementById("sidebar");
      const menuBtn = document.getElementById("menuBtn");

      menuBtn.onclick = () => sidebar.classList.toggle("show");

      const hideAll = () => {
        [dashboard, staffSection, logSection].forEach((s) =>
          s.classList.add("hidden")
        );
      };

      // ===== LOGIN =====
      document.getElementById("loginBtn").onclick = async () => {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        if (!username || !password) return alert("Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || "Sai th√¥ng tin ƒëƒÉng nh·∫≠p");
        localStorage.setItem("token", data.token);
        localStorage.setItem("role", data.role);
        loginSection.classList.add("hidden");
        dashboard.classList.remove("hidden");
        loadTrees();
      };

      document.getElementById("menuLogout").onclick = () => {
        localStorage.clear();
        location.reload();
      };

      // ===== C√ÇY =====
      async function loadTrees() {
        const res = await fetch(`${API_BASE}/api/trees`, {
          headers: { Authorization: `Bearer ${token()}` },
        });
        const data = await res.json();
        const search = document
          .getElementById("searchTree")
          .value.toLowerCase();
        const filtered = data.filter((t) => {
          const val = search;
          return (
            t.name?.toLowerCase().includes(val) ||
            t.species?.toLowerCase().includes(val) ||
            t.location?.toLowerCase().includes(val) ||
            t.vietGapCode?.toLowerCase().includes(val) ||
            t.notes?.toLowerCase().includes(val)
          );
        });
        document.getElementById("treeList").innerHTML = filtered
          .map(
            (t) => `
          <div class="tree-card">
            <div>
              <b>${t.name}</b> (${t.species})<br/>
              üìç ${t.location || "-"} | M√£ VietGAP: ${t.vietGapCode || "-"}
            </div>
            <div class="card-actions">
              <button onclick="editTree('${t._id}')">‚úèÔ∏è</button>
              <button onclick="deleteTree('${t._id}')">üóëÔ∏è</button>
              <a href="public/public.html?treeId=${t._id}" target="_blank">
                <img src="${t.qrCode}" class="qr-img" />
              </a>
            </div>
          </div>`
          )
          .join("");
      }

      document.getElementById("searchTree").oninput = loadTrees;

      // ===== TH√äM/S·ª¨A =====
      const modal = document.getElementById("treeModal");
      const cancelTreeBtn = document.getElementById("cancelTreeBtn");
      cancelTreeBtn.onclick = () => modal.classList.add("hidden");
      document.getElementById("addTreeBtn").onclick = () => {
        editing = null;
        modal.classList.remove("hidden");
        document.getElementById("modalTitle").innerText = "Th√™m c√¢y";
      };

      let editing = null;
      async function editTree(id) {
        const res = await fetch(`${API_BASE}/api/trees`, {
          headers: { Authorization: `Bearer ${token()}` },
        });
        const trees = await res.json();
        const t = trees.find((x) => x._id === id);
        editing = t;
        document.getElementById("modalTitle").innerText = "S·ª≠a c√¢y";
        treeName.value = t.name;
        treeSpecies.value = t.species;
        treeLocation.value = t.location;
        treePlantDate.value = t.plantDate?.split("T")[0];
        treeVietGapCode.value = t.vietGapCode;
        treeHealth.value = t.currentHealth;
        treeNotes.value = t.notes;
        treeArea.value = t.area;
        modal.classList.remove("hidden");
      }

      document.getElementById("saveTreeBtn").onclick = async () => {
        const body = {
          name: treeName.value,
          species: treeSpecies.value,
          location: treeLocation.value,
          plantDate: treePlantDate.value,
          vietGapCode: treeVietGapCode.value,
          currentHealth: treeHealth.value,
          notes: treeNotes.value,
          area: treeArea.value,
        };
        const url = editing
          ? `${API_BASE}/api/trees/${editing._id}`
          : `${API_BASE}/api/trees`;
        const method = editing ? "PUT" : "POST";
        await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token()}`,
          },
          body: JSON.stringify(body),
        });
        modal.classList.add("hidden");
        loadTrees();
      };

      async function deleteTree(id) {
        if (!confirm("X√≥a c√¢y n√†y?")) return;
        await fetch(`${API_BASE}/api/trees/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token()}` },
        });
        loadTrees();
      }

      // ===== NH√ÇN VI√äN =====
      async function loadStaff() {
        const res = await fetch(`${API_BASE}/api/staff`, {
          headers: { Authorization: `Bearer ${token()}` },
        });
        if (!res.ok)
          return (staffList.innerHTML =
            "<p>Ch·ªâ ch·ªß v∆∞·ªùn c√≥ th·ªÉ xem danh s√°ch nh√¢n vi√™n</p>");
        const data = await res.json();
        staffList.innerHTML = data
          .map(
            (s) => `
          <div class="staff-card">
            üë∑ ${s.username}
            <button onclick="deleteStaff('${s.username}')">X√≥a</button>
          </div>`
          )
          .join("");
      }

      document.getElementById("addStaffBtn").onclick = async () => {
        const u = newStaffUser.value.trim();
        const p = newStaffPass.value.trim();
        if (!u || !p) return alert("Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
        await fetch(`${API_BASE}/api/staff`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token()}`,
          },
          body: JSON.stringify({ username: u, password: p }),
        });
        loadStaff();
      };

      async function deleteStaff(u) {
        await fetch(`${API_BASE}/api/staff/${u}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token()}` },
        });
        loadStaff();
      }

      // ===== LOGS =====
      async function loadLogs() {
        const res = await fetch(`${API_BASE}/api/logs`, {
          headers: { Authorization: `Bearer ${token()}` },
        });
        if (!res.ok)
          return (logList.innerHTML =
            "<p>Ch·ªâ ch·ªß v∆∞·ªùn c√≥ th·ªÉ xem l·ªãch s·ª≠ ho·∫°t ƒë·ªông</p>");
        const data = await res.json();
        logList.innerHTML = data
          .map(
            (l) => `
          <div class="log-item">
            ${new Date(l.time).toLocaleString("vi-VN")} - 
            <b>${l.user}</b>: ${l.action}
          </div>`
          )
          .join("");
      }

      // ===== MENU =====
      menuDashboard.onclick = () => {
        hideAll();
        dashboard.classList.remove("hidden");
        loadTrees();
      };
      menuStaff.onclick = () => {
        hideAll();
        staffSection.classList.remove("hidden");
        loadStaff();
      };
      menuLogs.onclick = () => {
        hideAll();
        logSection.classList.remove("hidden");
        loadLogs();
      };

      // ===== AUTO LOGIN =====
      if (localStorage.getItem("token")) {
        loginSection.classList.add("hidden");
        dashboard.classList.remove("hidden");
        loadTrees();
      }
    </script>
  </body>
</html>
