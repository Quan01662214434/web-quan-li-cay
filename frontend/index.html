<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quản lý vườn · thefram.site</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="shell">
    <header>
      <div class="title">
        <div class="logo-wrapper">
          <span class="logo" id="farm-logo-letter">F</span>
          <img id="farm-logo-img" style="display:none;" />
        </div>
        <div>
          <div id="farm-title-text">Quản lý cây trong vườn</div>
          <div class="subtitle">
            <span id="farm-name-display">Chưa chọn vườn</span> · thefram.site
          </div>
        </div>
      </div>
      <div class="pill" id="user-display">Chưa đăng nhập</div>
    </header>

    <main>
      <!-- THÔNG BÁO CÂY CẦN CHĂM SÓC -->
      <section class="card alert-card">
        <div class="card-header">
          <div>
            <div class="card-title">Thông báo cây cần chăm sóc</div>
            <div class="card-desc">
              Cây ở trạng thái <b>Yếu</b> hoặc <b>Nguy hiểm</b> sẽ xuất hiện tại đây.
            </div>
          </div>
          <div>
            <span class="small-badge danger" id="alert-count">0 cây</span>
          </div>
        </div>

        <div id="alert-empty" class="muted" style="font-size:13px;">
          ✅ Hiện tại tất cả cây đều đang trong tình trạng ổn.
        </div>
        <ul id="alert-list" class="alert-list"></ul>
      </section>

      <!-- THỐNG KÊ NHANH -->
      <section class="stats-row">
        <div class="stat-card">
          <div class="stat-label">Tổng số cây</div>
          <div class="stat-value" id="total-trees">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Cây đang yếu / nguy hiểm</div>
          <div class="stat-value" id="bad-trees">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Lần cập nhật gần nhất</div>
          <div class="stat-value" id="last-updated">—</div>
        </div>
      </section>

      <!-- FORM TẠO CÂY -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Thêm cây mới vào vườn</div>
            <div class="card-desc">Chủ vườn có thể thêm cây, nhân viên chỉ cập nhật tình trạng.</div>
          </div>
        </div>

        <form id="create-tree-form">
          <div class="field-row">
            <div>
              <label>Tên cây</label>
              <input id="tree-name" placeholder="VD: Sầu riêng A01" />
            </div>
            <div>
              <label>Giống</label>
              <input id="tree-species" placeholder="VD: Ri6, Thái..." />
            </div>
            <div>
              <label>Vị trí trong vườn</label>
              <input id="tree-location" placeholder="VD: Lô A1 - Hàng 3" />
            </div>
            <div>
              <label>Ngày trồng</label>
              <input id="tree-plant-date" placeholder="VD: 2024-05-12" />
            </div>
          </div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <span class="muted" style="font-size:12px;">
              Khi tạo cây mới, hệ thống sẽ tự sinh mã QR kèm ID số.
            </span>
            <button type="submit" class="btn btn-primary" id="create-tree-btn">Tạo cây</button>
          </div>
        </form>
      </section>

      <!-- DANH SÁCH CÂY -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Danh sách cây trong vườn</div>
            <div class="card-desc">Cập nhật tình trạng, ghi chú và xem mã QR của từng cây.</div>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Mã</th>
                <th>Tên</th>
                <th>Giống</th>
                <th>Vị trí</th>
                <th>Ngày trồng</th>
                <th>Tình trạng</th>
                <th>Ghi chú</th>
                <th>QR + thông tin</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="tree-tbody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = "https://api.thefram.site";

    let allTrees = [];
    let alertTrees = [];

    function showToast(msg, type = "success") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast" + (type === "error" ? " error" : "");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2200);
    }

    // Áp dụng giao diện theo user / vườn
    (function applyFarmTheme() {
      try {
        const raw = localStorage.getItem("user");
        if (!raw) return;
        const user = JSON.parse(raw);

        if (user.farmPrimaryColor) {
          document.documentElement.style.setProperty("--accent", user.farmPrimaryColor);
        }

        const img = document.getElementById("farm-logo-img");
        const letter = document.getElementById("farm-logo-letter");
        if (user.farmLogo && img && letter) {
          img.src = user.farmLogo;
          img.style.display = "block";
          letter.style.display = "none";
        }

        const farmNameEl = document.getElementById("farm-name-display");
        const farmTitleEl = document.getElementById("farm-title-text");
        const userDisplay = document.getElementById("user-display");

        if (farmNameEl && user.farmName) {
          farmNameEl.textContent = user.farmName;
        }
        if (farmTitleEl && user.role) {
          farmTitleEl.textContent =
            user.role === "owner"
              ? "Bảng điều khiển chủ vườn"
              : user.role === "staff"
              ? "Bảng công việc nhân viên vườn"
              : "Quản lý cây trong vườn";
        }
        if (userDisplay && user.username) {
          userDisplay.textContent = `${user.username} (${user.role})`;
        }

        // Nếu là staff => ẩn nút tạo cây
        if (user.role === "staff") {
          const form = document.getElementById("create-tree-form");
          const btn = document.getElementById("create-tree-btn");
          if (btn) btn.disabled = true;
          if (form) form.querySelectorAll("input").forEach(i => i.disabled = true);
        }
      } catch (e) {
        console.warn("Không áp dụng được theme vườn:", e);
      }
    })();

    function setLastUpdated() {
      const el = document.getElementById("last-updated");
      el.textContent = new Date().toLocaleString("vi-VN");
    }

    function updateSummary(trees) {
      const total = trees.length;
      const bad = trees.filter(
        (t) => t.currentHealth === "Yếu" || t.currentHealth === "Nguy hiểm"
      ).length;

      document.getElementById("total-trees").textContent = total;
      document.getElementById("bad-trees").textContent = bad;
    }

    function renderAlerts(trees) {
      const alertCountEl = document.getElementById("alert-count");
      const alertListEl = document.getElementById("alert-list");
      const alertEmptyEl = document.getElementById("alert-empty");

      if (!trees.length) {
        alertCountEl.textContent = "0 cây";
        alertEmptyEl.style.display = "block";
        alertListEl.style.display = "none";
        alertListEl.innerHTML = "";
        return;
      }

      alertCountEl.textContent = `${trees.length} cây`;
      alertEmptyEl.style.display = "none";
      alertListEl.style.display = "block";
      alertListEl.innerHTML = "";

      trees.forEach((t) => {
        const li = document.createElement("li");
        li.className = "alert-item";
        const statusClass =
          t.currentHealth === "Nguy hiểm" ? "danger" : "weak";

        li.innerHTML = `
          <div class="alert-main">
            <div class="alert-title">${t.name || "Cây không tên"}</div>
            <div class="alert-meta">
              ID #${t.numericId ?? "—"} · Giống: ${t.species || "—"} · Vị trí: ${
          t.location || "—"
        }
            </div>
          </div>
          <div class="alert-status ${statusClass}">
            ${t.currentHealth || "Chưa rõ"}
          </div>
        `;
        alertListEl.appendChild(li);
      });
    }

    function renderTreeTable(trees) {
      const tbody = document.getElementById("tree-tbody");
      tbody.innerHTML = "";

      if (!trees.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align:center; font-size:13px; color:#9ca3af;">
              Chưa có cây nào trong vườn.
            </td>
          </tr>
        `;
        return;
      }

      const rawUser = localStorage.getItem("user");
      let userRole = null;
      if (rawUser) {
        try {
          userRole = JSON.parse(rawUser).role;
        } catch (e) {}
      }

      trees.forEach((tree) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>#${tree.numericId ?? "—"}</td>
          <td>${tree.name || "—"}</td>
          <td>${tree.species || "—"}</td>
          <td>${tree.location || "—"}</td>
          <td>${tree.plantDate || "—"}</td>
          <td>
            <select class="health-select" data-id="${tree._id}">
              <option value="Tốt" ${tree.currentHealth === "Tốt" ? "selected" : ""}>Tốt</option>
              <option value="Bình thường" ${
                tree.currentHealth === "Bình thường" ? "selected" : ""
              }>Bình thường</option>
              <option value="Yếu" ${tree.currentHealth === "Yếu" ? "selected" : ""}>Yếu</option>
              <option value="Nguy hiểm" ${
                tree.currentHealth === "Nguy hiểm" ? "selected" : ""
              }>Nguy hiểm</option>
            </select>
          </td>
          <td>
            <textarea class="note-input" data-id="${tree._id}" rows="2"
              placeholder="Ghi chú chăm sóc...">${tree.notes || ""}</textarea>
          </td>
          <td>
            ${
              tree.qrCode
                ? `
                <div class="qr-cell">
                  <img src="${tree.qrCode}" class="qr-thumb" alt="QR" title="Nhấp để mở lớn" />
                  <div class="qr-meta">
                    <div class="qr-meta-name">${tree.name || "Cây không tên"}</div>
                    <div class="muted">Giống: ${tree.species || "—"}</div>
                    <div class="muted">Vị trí: ${tree.location || "—"}</div>
                  </div>
                </div>
                `
                : `<span class="qr-thumb-empty">Chưa có QR</span>`
            }
          </td>
          <td>
            <button class="btn-table save-btn" data-id="${tree._id}">Lưu</button>
            <button class="btn-table danger-btn delete-btn" data-id="${tree._id}">Xoá</button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      // Nếu là staff, ẩn nút xoá
      if (userRole === "staff") {
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.style.display = "none";
        });
      }

      // Gán sự kiện Lưu
      document.querySelectorAll(".save-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");
          const healthSelect = document.querySelector(
            `.health-select[data-id="${id}"]`
          );
          const noteInput = document.querySelector(
            `.note-input[data-id="${id}"]`
          );

          const body = {
            currentHealth: healthSelect.value,
            notes: noteInput.value,
          };

          try {
            const token = localStorage.getItem("token") || "";
            const res = await fetch(`${API_BASE}/api/trees/${id}/health`, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error("Không thể cập nhật cây");
            showToast("Đã lưu tình trạng / ghi chú");
            loadTrees();
          } catch (err) {
            console.error(err);
            showToast("Lỗi khi lưu cây", "error");
          }
        });
      });

      // Gán sự kiện Xoá
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");
          if (!confirm("Bạn chắc chắn muốn xoá cây này?")) return;

          try {
            const token = localStorage.getItem("token") || "";
            const res = await fetch(`${API_BASE}/api/trees/${id}`, {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + token,
              },
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Không thể xoá cây");
            showToast(data.message || "Đã xoá cây");
            loadTrees();
          } catch (err) {
            console.error(err);
            showToast("Lỗi khi xoá cây", "error");
          }
        });
      });
    }

    async function loadTrees() {
      try {
        const token = localStorage.getItem("token");
        if (!token) {
          showToast("Chưa có token đăng nhập, vui lòng login từ hệ thống.", "error");
          return;
        }
        const res = await fetch(`${API_BASE}/api/trees`, {
          headers: {
            Authorization: "Bearer " + token,
          },
        });
        if (!res.ok) throw new Error("Không thể tải danh sách cây");
        const data = await res.json();
        allTrees = data;

        alertTrees = data.filter(
          (t) => t.currentHealth === "Yếu" || t.currentHealth === "Nguy hiểm"
        );

        updateSummary(data);
        renderAlerts(alertTrees);
        renderTreeTable(data);
        setLastUpdated();
      } catch (err) {
        console.error(err);
        showToast("Không thể tải danh sách cây", "error");
      }
    }

    // Tạo cây mới
    document.getElementById("create-tree-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("tree-name").value.trim();
      const species = document.getElementById("tree-species").value.trim();
      const location = document.getElementById("tree-location").value.trim();
      const plantDate = document.getElementById("tree-plant-date").value.trim();

      if (!name) {
        showToast("Tên cây là bắt buộc", "error");
        return;
      }

      try {
        const token = localStorage.getItem("token");
        if (!token) {
          showToast("Chưa có token đăng nhập", "error");
          return;
        }

        const res = await fetch(`${API_BASE}/api/trees`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ name, species, location, plantDate }),
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || "Không thể tạo cây mới");
        }

        showToast("Đã thêm cây mới!");
        e.target.reset();
        loadTrees();
      } catch (err) {
        console.error(err);
        showToast(err.message, "error");
      }
    });

    // Lần đầu load
    window.addEventListener("load", () => {
      loadTrees();
    });
  </script>
</body>
</html>
