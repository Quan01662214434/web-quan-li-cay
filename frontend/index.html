<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Thanh Huy·ªÅn Farm ‚Äì Qu·∫£n l√Ω v∆∞·ªùn s·∫ßu ri√™ng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- HEADER -->
    <header class="app-header">
      <div class="header-left">
        <img
          src="images/logo-thanh-huyen.png"
          alt="Thanh Huy·ªÅn Farm"
          class="logo"
        />
        <div class="header-title">
          <div class="brand-name">Thanh Huy·ªÅn Farm</div>
          <div class="brand-subtitle">Qu·∫£n l√Ω v∆∞·ªùn s·∫ßu ri√™ng h·ªØu c∆°</div>
        </div>
      </div>

      <!-- MENU 3 G·∫†CH (MOBILE) -->
      <button id="hamburger-btn" class="hamburger" type="button">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <!-- NAV DOANH NGHI·ªÜP -->
      <nav id="main-nav" class="main-nav">
        <button
          class="nav-link active"
          type="button"
          data-scroll-target="dashboard"
        >
          C√¢y & QR
        </button>
        <button
          class="nav-link"
          type="button"
          data-scroll-target="staff-section"
        >
          Nh√¢n vi√™n
        </button>
        <button
          class="nav-link"
          type="button"
          data-scroll-target="activity-section"
        >
          L·ªãch s·ª≠
        </button>
      </nav>

      <div class="header-right">
        <span id="user-info" class="user-info"></span>
        <button id="logout-btn" class="btn-secondary hidden">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <!-- TRANG CH·ªú + LOGIN -->
      <section id="login-section" class="section section-landing">
        <div class="landing-grid">
          <div class="landing-text">
            <h1>H·ªá th·ªëng qu·∫£n l√Ω v∆∞·ªùn s·∫ßu ri√™ng üå±</h1>
            <p>
              Theo d√µi t·ª´ng c√¢y, t√¨nh tr·∫°ng, b·ªánh, nƒÉng su·∫•t v√† l·ªãch s·ª≠ l√†m vi·ªác
              c·ªßa nh√¢n vi√™n ‚Äì t·ªëi ∆∞u cho ƒëi·ªán tho·∫°i, d√†nh ri√™ng cho Thanh Huy·ªÅn
              Farm.
            </p>

            <ul class="landing-bullets">
              <li>M·ªói c√¢y 1 m√£ QR ‚Äì qu√©t l√† th·∫•y th√¥ng tin c·∫ßn thi·∫øt</li>
              <li>Nh√¢n vi√™n & ch·ªß v∆∞·ªùn l√†m vi·ªác chung tr√™n 1 n·ªÅn t·∫£ng</li>
              <li>L∆∞u v·∫øt m·ªçi thao t√°c ‚Äì xem ai l√†m g√¨, l√∫c n√†o</li>
            </ul>
          </div>

          <div class="card login-card">
            <h2>ƒêƒÉng nh·∫≠p h·ªá th·ªëng üåø</h2>
            <form id="login-form" class="form-grid">
              <div class="form-row">
                <label for="username">T√†i kho·∫£n</label>
                <input
                  id="username"
                  type="text"
                  placeholder="VD: thanhhuyen"
                  required
                />
              </div>
              <div class="form-row">
                <label for="password">M·∫≠t kh·∫©u</label>
                <input
                  id="password"
                  type="password"
                  placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                  required
                />
              </div>
              <button type="submit" class="btn-primary full-width">
                ƒêƒÉng nh·∫≠p
              </button>
            </form>
          </div>
        </div>

        <p class="landing-footer">
          Thanh Huy·ªÅn Farm | V∆∞·ªùn s·∫ßu ri√™ng h·ªØu c∆° üåø
        </p>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard" class="section hidden">
        <!-- TH·∫∫ VIETGAP V∆Ø·ªúN (d√πng m√£ t·ª´ c√¢y) -->
        <div id="farm-vietgap-wrapper" class="farm-vietgap-card hidden">
          <div class="farm-vietgap-left">
            <div class="vietgap-logo-circle">
              <span class="vg-text">VG</span>
            </div>
          </div>
          <div class="farm-vietgap-info">
            <div class="farm-vietgap-title">V∆∞·ªùn ƒë·∫°t chu·∫©n VietGAP</div>
            <div class="farm-vietgap-detail">
              M√£ s·ªë VietGAP (t·ª´ c√¢y): <span id="farm-vietgap-code">‚Äî</span>
            </div>
            <div class="farm-vietgap-note">
              (L·∫•y theo m√£ VietGAP ƒë√£ nh·∫≠p tr√™n c√¢y trong v∆∞·ªùn)
            </div>
          </div>
          <div class="farm-vietgap-status">‚úÖ</div>
        </div>

        <div class="dashboard-grid">
          <!-- T·∫†O C√ÇY M·ªöI -->
          <section class="card">
            <h2>Th√™m c√¢y m·ªõi</h2>
            <form id="create-tree-form" class="form-grid">
              <div class="form-row">
                <label for="tree-name">T√™n c√¢y *</label>
                <input
                  id="tree-name"
                  type="text"
                  placeholder="VD: S·∫ßu ri√™ng A01"
                  required
                />
              </div>

              <div class="form-row">
                <label for="tree-species">Gi·ªëng</label>
                <input
                  id="tree-species"
                  type="text"
                  placeholder="VD: Ri6, Dona..."
                />
              </div>

              <div class="form-row two-col">
                <div>
                  <label for="tree-area">Khu v·ª±c</label>
                  <select id="tree-area"></select>
                </div>
                <div class="inline-control">
                  <button
                    type="button"
                    id="add-area-btn"
                    class="btn-link small"
                  >
                    + Khu m·ªõi
                  </button>
                </div>
              </div>

              <div class="form-row">
                <label for="tree-location">V·ªã tr√≠ trong v∆∞·ªùn</label>
                <input
                  id="tree-location"
                  type="text"
                  placeholder="VD: H√†ng A2 - C√¢y 15"
                />
              </div>

              <div class="form-row">
                <label for="tree-date">Ng√†y tr·ªìng</label>
                <input id="tree-date" type="date" />
              </div>

              <div class="form-row">
                <label for="tree-vietgap">M√£ s·ªë VietGAP (n·∫øu c√≥)</label>
                <input
                  id="tree-vietgap"
                  type="text"
                  placeholder="VD: VG-TH-001"
                />
              </div>

              <div class="form-row">
                <label for="tree-image">H√¨nh ·∫£nh (URL ‚Äì t√πy ch·ªçn)</label>
                <input
                  id="tree-image"
                  type="url"
                  placeholder="https://..."
                />
              </div>

              <button type="submit" class="btn-primary full-width">
                T·∫°o c√¢y & sinh QR
              </button>
            </form>
          </section>

          <!-- DANH S√ÅCH C√ÇY -->
          <section class="card">
            <div class="card-header">
              <h2>Danh s√°ch c√¢y trong v∆∞·ªùn</h2>
              <button
                id="display-config-btn"
                class="btn-secondary small hidden"
              >
                C·∫•u h√¨nh hi·ªÉn th·ªã QR
              </button>
            </div>

            <!-- TOOLBAR: FILTER + SEARCH -->
            <div class="tree-toolbar">
              <div class="tree-tabs">
                <button
                  class="btn-secondary small tab active"
                  type="button"
                  data-tree-filter="all"
                >
                  T·∫•t c·∫£
                </button>
                <button
                  class="btn-secondary small tab"
                  type="button"
                  data-tree-filter="need-care"
                >
                  C·∫ßn chƒÉm s√≥c
                </button>
                <button
                  class="btn-secondary small tab"
                  type="button"
                  data-tree-filter="sick"
                >
                  B·ªánh n·∫∑ng
                </button>
              </div>

              <div class="tree-search">
                <input
                  id="tree-search-input"
                  type="search"
                  placeholder="üîç T√¨m t√™n, m√£, VietGAP, khu, v·ªã tr√≠..."
                />
                <span class="search-icon">üîç</span>
              </div>
            </div>

            <div id="tree-list" class="tree-list"></div>
          </section>

          <!-- NH√ÇN VI√äN -->
          <section id="staff-section" class="card hidden">
            <h2>Nh√¢n vi√™n v∆∞·ªùn</h2>
            <form id="staff-form" class="form-grid form-inline">
              <div class="form-row">
                <label for="staff-username">T√†i kho·∫£n nh√¢n vi√™n</label>
                <input
                  id="staff-username"
                  type="text"
                  placeholder="VD: nhanvien01"
                  required
                />
              </div>
              <div class="form-row">
                <label for="staff-password">M·∫≠t kh·∫©u</label>
                <input
                  id="staff-password"
                  type="password"
                  placeholder="M·∫≠t kh·∫©u"
                  required
                />
              </div>
              <button type="submit" class="btn-primary">
                T·∫°o nh√¢n vi√™n
              </button>
            </form>

            <div id="staff-list" class="staff-list"></div>
          </section>

          <!-- L·ªäCH S·ª¨ HO·∫†T ƒê·ªòNG -->
          <section id="activity-section" class="card hidden">
            <h2>L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h2>
            <div id="activity-list" class="activity-list"></div>
          </section>
        </div>
      </section>
    </main>

    <!-- MODAL QR -->
    <div id="qr-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('qr-modal')"></div>
      <div class="modal-content modal-qr">
        <h2>M√£ QR c·ªßa c√¢y</h2>
        <img id="qr-image" alt="QR Code" />
        <button class="btn-secondary" onclick="closeModal('qr-modal')">
          ƒê√≥ng
        </button>
      </div>
    </div>

    <!-- MODAL NƒÇNG SU·∫§T -->
    <div id="yield-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('yield-modal')"></div>
      <div class="modal-content">
        <h2>NƒÉng su·∫•t theo nƒÉm</h2>
        <canvas id="yield-chart" height="200"></canvas>

        <form id="yield-form" class="form-grid">
          <div class="form-row two-col">
            <div>
              <label for="yield-year">NƒÉm</label>
              <input
                id="yield-year"
                type="number"
                min="2000"
                max="2100"
                value="2024"
                required
              />
            </div>
            <div>
              <label for="yield-quantity">S·∫£n l∆∞·ª£ng (kg)</label>
              <input
                id="yield-quantity"
                type="number"
                min="0"
                step="1"
                placeholder="VD: 2000"
                required
              />
            </div>
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModal('yield-modal')"
            >
              ƒê√≥ng
            </button>
            <button type="submit" class="btn-primary">L∆∞u nƒÉng su·∫•t</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL B·ªÜNH -->
    <div id="disease-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('disease-modal')"></div>
      <div class="modal-content">
        <h2>B·ªánh & v·∫•n ƒë·ªÅ c·ªßa c√¢y</h2>
        <div id="disease-list" class="disease-list"></div>

        <div class="form-row inline">
          <input
            id="new-disease-name"
            type="text"
            placeholder="Nh·∫≠p t√™n b·ªánh m·ªõi..."
          />
          <button id="add-disease-btn" class="btn-secondary small" type="button">
            + Th√™m b·ªánh
          </button>
        </div>

        <div class="modal-actions">
          <button
            class="btn-secondary"
            type="button"
            onclick="closeModal('disease-modal')"
          >
            ƒê√≥ng
          </button>
          <button id="save-disease-btn" class="btn-primary" type="button">
            L∆∞u
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL T√åNH TR·∫†NG -->
    <div id="status-modal" class="modal hidden">
      <div class="modal-backdrop" onclick="closeModal('status-modal')"></div>
      <div class="modal-content">
        <h2>T√¨nh tr·∫°ng & ghi ch√∫</h2>

        <div class="form-row">
          <label for="status-select">T√¨nh tr·∫°ng</label>
          <div class="status-row">
            <select id="status-select"></select>
            <button
              id="add-status-btn"
              type="button"
              class="btn-secondary small"
            >
              +
            </button>
          </div>
        </div>

        <div class="form-row">
          <label for="status-notes">Ghi ch√∫</label>
          <textarea
            id="status-notes"
            rows="3"
            placeholder="VD: C·∫ßn b√≥n b·ªï sung kali, t·ªâa c√†nh..."
          ></textarea>
        </div>

        <div class="modal-actions">
          <button
            class="btn-secondary"
            type="button"
            onclick="closeModal('status-modal')"
          >
            ƒê√≥ng
          </button>
          <button id="save-status-btn" class="btn-primary" type="button">
            L∆∞u
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL C·∫§U H√åNH HI·ªÇN TH·ªä QR -->
    <div id="display-config-modal" class="modal hidden">
      <div
        class="modal-backdrop"
        onclick="closeModal('display-config-modal')"
      ></div>
      <div class="modal-content">
        <h2>Th√¥ng tin hi·ªÉn th·ªã cho kh√°ch khi qu√©t QR</h2>
        <p class="text-muted">
          T√≠ch ch·ªçn nh·ªØng m·ª•c anh mu·ªën kh√°ch h√†ng nh√¨n th·∫•y tr√™n trang th√¥ng
          tin c√¢y.
        </p>

        <div class="display-config-grid">
          <label>
            <input id="cfg-name" type="checkbox" checked />
            T√™n c√¢y
          </label>
          <label>
            <input id="cfg-species" type="checkbox" checked />
            Gi·ªëng
          </label>
          <label>
            <input id="cfg-area" type="checkbox" checked />
            Khu v·ª±c
          </label>
          <label>
            <input id="cfg-location" type="checkbox" checked />
            V·ªã tr√≠
          </label>
          <label>
            <input id="cfg-plantDate" type="checkbox" checked />
            Ng√†y tr·ªìng
          </label>

          <!-- ‚úÖ CHECKBOX HI·ªÇN TH·ªä VIETGAP TRONG QR -->
          <label>
            <input id="cfg-vietgap" type="checkbox" checked />
            M√£ s·ªë VietGAP
          </label>

          <label>
            <input id="cfg-image" type="checkbox" checked />
            H√¨nh ·∫£nh
          </label>
          <label>
            <input id="cfg-health" type="checkbox" checked />
            T√¨nh tr·∫°ng hi·ªán t·∫°i
          </label>
          <label>
            <input id="cfg-notes" type="checkbox" checked />
            Ghi ch√∫
          </label>
          <label>
            <input id="cfg-diseases" type="checkbox" checked />
            Danh s√°ch b·ªánh
          </label>
          <label>
            <input id="cfg-yield" type="checkbox" checked />
            NƒÉng su·∫•t theo nƒÉm
          </label>
          <label>
            <input id="cfg-ownerName" type="checkbox" checked />
            T√™n v∆∞·ªùn / ch·ªß v∆∞·ªùn
          </label>
        </div>

        <div class="modal-actions">
          <button
            class="btn-secondary"
            type="button"
            onclick="closeModal('display-config-modal')"
          >
            ƒê√≥ng
          </button>
          <button
            id="save-display-config-btn"
            class="btn-primary"
            type="button"
          >
            L∆∞u c·∫•u h√¨nh
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL CH·ªàNH TH√îNG TIN C√ÇY -->
    <div id="edit-tree-modal" class="modal hidden">
      <div
        class="modal-backdrop"
        onclick="closeModal('edit-tree-modal')"
      ></div>
      <div class="modal-content">
        <h2>Ch·ªânh th√¥ng tin c√¢y</h2>

        <form id="edit-tree-form" class="form-grid">
          <div class="form-row">
            <label for="edit-tree-location">V·ªã tr√≠ trong v∆∞·ªùn</label>
            <input
              id="edit-tree-location"
              type="text"
              placeholder="VD: H√†ng A2 - C√¢y 15"
            />
          </div>

          <div class="form-row">
            <label for="edit-tree-date">Ng√†y tr·ªìng</label>
            <input id="edit-tree-date" type="date" />
          </div>

          <div class="form-row">
            <label for="edit-tree-vietgap">M√£ s·ªë VietGAP</label>
            <input
              id="edit-tree-vietgap"
              type="text"
              placeholder="VD: VG-TH-001"
            />
          </div>

          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModal('edit-tree-modal')"
            >
              Hu·ª∑
            </button>
            <button type="submit" class="btn-primary">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- SCRIPT CH√çNH -->
    <script>
      // ‚úÖ API_BASE T·ª∞ ƒê·ªòNG: localhost th√¨ d√πng server local, c√≤n l·∫°i d√πng domain
      const API_BASE =
        window.location.hostname === "localhost"
          ? "http://localhost:4000"
          : "https://api.thefram.site";

      let token = localStorage.getItem("th_token") || null;
      let currentUser = null;
      try {
        currentUser = JSON.parse(localStorage.getItem("th_user") || "null");
      } catch {
        currentUser = null;
      }

      let lastTrees = [];
      let currentYieldTreeId = null;
      let chartInstance = null;

      let diseaseMaster = [];
      let currentDiseaseTreeId = null;

      let statusMaster = [];
      let currentStatusTreeId = null;
      let currentStatusNotes = "";

      let displayConfig = null;
      let currentEditTreeId = null;

      let treeSearchTerm = "";
      let treeStatusFilter = "all";

      async function setupAfterLogin() {
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("logout-btn").classList.remove("hidden");
        document
          .getElementById("display-config-btn")
          .classList.remove("hidden");

        document.getElementById(
          "user-info"
        ).innerText = `Xin ch√†o ${currentUser.username} ‚Äì Vai tr√≤: ${
          currentUser.role
        } ‚Äì V∆∞·ªùn: ${currentUser.farmName || "Thanh Huy·ªÅn Farm"}`;

        await loadDisplayConfig();
        await loadTrees();

        if (currentUser.role === "owner") {
          document.getElementById("staff-section").classList.remove("hidden");
          document.getElementById("activity-section").classList.remove("hidden");
          loadStaff();
          loadActivity();
        } else {
          document.getElementById("staff-section").classList.add("hidden");
          document.getElementById("activity-section").classList.add("hidden");
        }
      }

      // LOGIN
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();
          try {
            const res = await fetch(`${API_BASE}/auth/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
              return;
            }

            // ‚úÖ H·ªñ TR·ª¢ HAI KI·ªÇU TR·∫¢ V·ªÄ:
            // 1) { token, user: { username, role, farmName } }
            // 2) { token, role }  => t·ª± build currentUser
            token = data.token;
            currentUser =
              data.user ||
              ({
                username,
                role: data.role || "owner",
                farmName: data.farmName || "Thanh Huy·ªÅn Farm",
              });

            localStorage.setItem("th_token", token);
            localStorage.setItem("th_user", JSON.stringify(currentUser));
            setupAfterLogin();
          } catch (err) {
            console.error(err);
            alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server.");
          }
        });

      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("th_token");
        localStorage.removeItem("th_user");
        location.reload();
      });

      // KHU V·ª∞C
      function loadAreas() {
        const select = document.getElementById("tree-area");
        if (!select) return;
        let areas = [];
        try {
          areas = JSON.parse(localStorage.getItem("farmAreas") || "[]");
        } catch {
          areas = [];
        }
        if (!areas.length) {
          areas = ["Khu A", "Khu B", "Khu C"];
          localStorage.setItem("farmAreas", JSON.stringify(areas));
        }
        select.innerHTML = "";
        areas.forEach((a) => {
          const opt = document.createElement("option");
          opt.value = a;
          opt.textContent = a;
          select.appendChild(opt);
        });
      }

      function addNewArea() {
        let areas = [];
        try {
          areas = JSON.parse(localStorage.getItem("farmAreas") || "[]");
        } catch {
          areas = [];
        }
        const name = prompt("Nh·∫≠p t√™n khu v·ª±c m·ªõi (VD: Khu B·ªù Su·ªëi):");
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        if (!areas.includes(trimmed)) {
          areas.push(trimmed);
          localStorage.setItem("farmAreas", JSON.stringify(areas));
        }
        loadAreas();
        const select = document.getElementById("tree-area");
        if (select) select.value = trimmed;
      }

      // T·∫†O C√ÇY
      document
        .getElementById("create-tree-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!token) {
            alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
            return;
          }
          const name = document.getElementById("tree-name").value.trim();
          const species = document.getElementById("tree-species").value.trim();
          const area = document.getElementById("tree-area").value;
          const location = document.getElementById("tree-location").value.trim();
          const plantDate = document.getElementById("tree-date").value;
          const imageURL = document.getElementById("tree-image").value.trim();
          const vietGapCode = document
            .getElementById("tree-vietgap")
            .value.trim();
          try {
            const res = await fetch(`${API_BASE}/api/trees`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                name,
                species,
                area,
                location,
                plantDate,
                imageURL,
                vietGapCode,
              }),
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Kh√¥ng th·ªÉ t·∫°o c√¢y");
              return;
            }
            alert("‚úÖ ƒê√£ t·∫°o c√¢y & QR");
            e.target.reset();
            loadTrees();
          } catch (err) {
            console.error(err);
            alert("L·ªói khi t·∫°o c√¢y");
          }
        });

      // VIETGAP CARD
      function updateFarmVietGapBadge() {
        const wrapper = document.getElementById("farm-vietgap-wrapper");
        const codeSpan = document.getElementById("farm-vietgap-code");
        if (!wrapper || !codeSpan) return;
        const firstWithVg = lastTrees.find(
          (t) => t.vietGapCode && t.vietGapCode.trim() !== ""
        );
        if (firstWithVg) {
          codeSpan.textContent = firstWithVg.vietGapCode;
          wrapper.classList.remove("hidden");
        } else {
          wrapper.classList.add("hidden");
        }
      }

      function renderTreeList() {
        const container = document.getElementById("tree-list");
        if (!container) return;
        container.innerHTML = "";
        if (!lastTrees.length) {
          container.innerHTML = "<p>Ch∆∞a c√≥ c√¢y n√†o. H√£y th√™m c√¢y m·ªõi.</p>";
          updateFarmVietGapBadge();
          return;
        }
        const term = (treeSearchTerm || "").trim().toLowerCase();
        const filtered = lastTrees.filter((t) => {
          if (treeStatusFilter === "need-care") {
            if ((t.currentHealth || "").trim() !== "C·∫ßn chƒÉm s√≥c") return false;
          }
          if (treeStatusFilter === "sick") {
            if ((t.currentHealth || "").trim() !== "B·ªánh n·∫∑ng") return false;
          }
          if (!term) return true;
          const combined = `
            ${t.numericId || ""}
            ${t.name || ""}
            ${t.species || ""}
            ${t.area || ""}
            ${t.location || ""}
            ${t.vietGapCode || ""}
          `
            .toLowerCase()
            .replace(/\s+/g, " ");
          return combined.includes(term);
        });
        if (!filtered.length) {
          container.innerHTML =
            "<p>Kh√¥ng t√¨m th·∫•y c√¢y n√†o kh·ªõp v·ªõi b·ªô l·ªçc hi·ªán t·∫°i.</p>";
          updateFarmVietGapBadge();
          return;
        }
        filtered.forEach((t) => {
          const card = document.createElement("div");
          card.className = "tree-card";
          const diseasesText = (t.diseases || []).join(", ");
          const vietgapHtml = t.vietGapCode
            ? `<div class="tree-vietgap">VietGAP: <b>${t.vietGapCode}</b></div>`
            : "";
          card.innerHTML = `
            <div class="tree-main">
              <div class="tree-title">#${t.numericId} ‚Äì ${t.name}</div>
              <div class="tree-sub">
                ${t.species || "Ch∆∞a r√µ gi·ªëng"} ‚Ä¢ Khu: ${
            t.area || "Ch∆∞a r√µ"
          } ‚Ä¢ V·ªã tr√≠: ${t.location || "‚Äî"}
              </div>
              <div class="tree-health">T√¨nh tr·∫°ng: <b>${
                t.currentHealth || "Ch∆∞a c·∫≠p nh·∫≠t"
              }</b></div>
              ${vietgapHtml}
              ${
                diseasesText
                  ? `<div class="tree-disease">B·ªánh: ${diseasesText}</div>`
                  : ""
              }
            </div>
            <div class="tree-actions">
              <button class="btn-secondary small" onclick="openQrModal('${
                t.qrCode
              }')">QR</button>
              <button class="btn-secondary small" onclick="openYield('${
                t._id
              }')">NƒÉng su·∫•t</button>
              <button class="btn-secondary small" onclick="openStatusModal('${
                t._id
              }','${(t.currentHealth || "")
            .replace(/'/g, "\\'")
            .replace(/"/g, "&quot;")}','${(t.notes || "")
            .replace(/'/g, "\\'")
            .replace(/"/g, "&quot;")}')">T√¨nh tr·∫°ng</button>
              <button class="btn-secondary small" onclick="openDiseaseModal('${
                t._id
              }')">B·ªánh</button>
              <button class="btn-secondary small" onclick="openEditTree('${
                t._id
              }')">S·ª≠a</button>
              <button class="btn-danger small" onclick="deleteTree('${
                t._id
              }')">Xo√°</button>
            </div>
          `;
          container.appendChild(card);
        });
        updateFarmVietGapBadge();
      }

      async function loadTrees() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/trees`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const trees = await res.json();
          if (!res.ok) {
            alert(trees.error || "Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¢y");
            return;
          }
          lastTrees = trees;
          renderTreeList();
        } catch (err) {
          console.error(err);
          alert("L·ªói khi t·∫£i danh s√°ch c√¢y");
        }
      }

      function openQrModal(dataUrl) {
        document.getElementById("qr-image").src = dataUrl;
        document.getElementById("qr-modal").classList.remove("hidden");
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      // B·ªÜNH
      function loadDiseaseMaster() {
        try {
          diseaseMaster = JSON.parse(
            localStorage.getItem("diseaseMaster") || "[]"
          );
        } catch {
          diseaseMaster = [];
        }
        if (!diseaseMaster.length) {
          diseaseMaster = [
            "Th·ªëi r·ªÖ",
            "S√¢u ƒë·ª•c th√¢n",
            "N·∫•m Phytophthora",
            "Th√°n th∆∞",
          ];
          localStorage.setItem("diseaseMaster", JSON.stringify(diseaseMaster));
        }
      }

      function renderDiseaseListForTree(tree) {
        const container = document.getElementById("disease-list");
        container.innerHTML = "";
        const current = tree.diseases || [];
        diseaseMaster.forEach((name) => {
          const wrap = document.createElement("div");
          wrap.className = "disease-item";
          const id = `dis-${name.replace(/\s+/g, "-")}`;
          wrap.innerHTML = `
            <input type="checkbox" id="${id}" value="${name}" ${
            current.includes(name) ? "checked" : ""
          } />
            <label for="${id}">${name}</label>
          `;
          container.appendChild(wrap);
        });
      }

      function openDiseaseModal(treeId) {
        currentDiseaseTreeId = treeId;
        loadDiseaseMaster();
        const tree = lastTrees.find((t) => t._id === treeId);
        if (!tree) {
          alert("Kh√¥ng t√¨m th·∫•y c√¢y ƒë·ªÉ ch·ªânh b·ªánh");
          return;
        }
        renderDiseaseListForTree(tree);
        document.getElementById("disease-modal").classList.remove("hidden");
      }

      function addNewDisease() {
        loadDiseaseMaster();
        const input = document.getElementById("new-disease-name");
        const name = (input.value || "").trim();
        if (!name) return;
        if (!diseaseMaster.includes(name)) {
          diseaseMaster.push(name);
          localStorage.setItem("diseaseMaster", JSON.stringify(diseaseMaster));
        }
        input.value = "";
        if (currentDiseaseTreeId) {
          const tree = lastTrees.find((t) => t._id === currentDiseaseTreeId);
          if (tree) renderDiseaseListForTree(tree);
        }
      }

      async function saveDiseaseForTree() {
        if (!currentDiseaseTreeId) return;
        if (!token) {
          alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
          return;
        }
        const checkboxes = document.querySelectorAll(
          "#disease-list input[type='checkbox']:checked"
        );
        const diseases = Array.from(checkboxes).map((c) => c.value);
        try {
          const res = await fetch(
            `${API_BASE}/api/trees/${currentDiseaseTreeId}/diseases`,
            {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ diseases }),
            }
          );
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b·ªánh");
            return;
          }
          alert("‚úÖ ƒê√£ l∆∞u danh s√°ch b·ªánh cho c√¢y");
          closeModal("disease-modal");
          loadTrees();
        } catch (err) {
          console.error(err);
          alert("L·ªói khi l∆∞u b·ªánh");
        }
      }

      // T√åNH TR·∫†NG
      function loadStatusMaster() {
        try {
          statusMaster = JSON.parse(
            localStorage.getItem("statusMaster") || "[]"
          );
        } catch {
          statusMaster = [];
        }
        if (!statusMaster.length) {
          statusMaster = ["B√¨nh th∆∞·ªùng", "C·∫ßn chƒÉm s√≥c", "B·ªánh n·∫∑ng"];
          localStorage.setItem("statusMaster", JSON.stringify(statusMaster));
        }
      }

      function renderStatusOptions(selected) {
        const sel = document.getElementById("status-select");
        if (!sel) return;
        sel.innerHTML = "";
        statusMaster.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          if (s === selected) opt.selected = true;
          sel.appendChild(opt);
        });
      }

      function openStatusModal(treeId, currentHealth, notes) {
        currentStatusTreeId = treeId;
        currentStatusNotes = notes || "";
        loadStatusMaster();
        renderStatusOptions(currentHealth || "B√¨nh th∆∞·ªùng");
        document.getElementById("status-notes").value =
          currentStatusNotes || "";
        document.getElementById("status-modal").classList.remove("hidden");
      }

      function addNewStatus() {
        loadStatusMaster();
        const name = prompt(
          "Nh·∫≠p t√™n t√¨nh tr·∫°ng m·ªõi (VD: S·∫Øp thu ho·∫°ch, C√¢y ch·∫øt...):"
        );
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        if (!statusMaster.includes(trimmed)) {
          statusMaster.push(trimmed);
          localStorage.setItem("statusMaster", JSON.stringify(statusMaster));
        }
        renderStatusOptions(trimmed);
      }

      async function saveStatusForTree() {
        if (!currentStatusTreeId) return;
        if (!token) {
          alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
          return;
        }
        const status = document.getElementById("status-select").value;
        const notes = document.getElementById("status-notes").value;
        try {
          const res = await fetch(
            `${API_BASE}/api/trees/${currentStatusTreeId}/health`,
            {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                currentHealth: status,
                notes,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t t√¨nh tr·∫°ng");
            return;
          }
          alert("‚úÖ ƒê√£ l∆∞u t√¨nh tr·∫°ng c√¢y");
          closeModal("status-modal");
          loadTrees();
        } catch (err) {
          console.error(err);
          alert("L·ªói khi l∆∞u t√¨nh tr·∫°ng");
        }
      }

      // NƒÇNG SU·∫§T
      async function openYield(id) {
        currentYieldTreeId = id;
        document.getElementById("yield-modal").classList.remove("hidden");
        if (!token) {
          alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
          return;
        }
        try {
          const res = await fetch(`${API_BASE}/api/trees`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const trees = await res.json();
          const tree = trees.find((t) => t._id === id);
          const ctx = document.getElementById("yield-chart").getContext("2d");
          if (chartInstance) chartInstance.destroy();
          const labels = (tree.yieldHistory || []).map((y) => y.year);
          const data = (tree.yieldHistory || []).map((y) => y.quantity);
          chartInstance = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "NƒÉng su·∫•t (kg)",
                  data,
                  backgroundColor: "#3fa34d",
                },
              ],
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true } },
            },
          });
        } catch (err) {
          console.error(err);
          alert("L·ªói khi t·∫£i nƒÉng su·∫•t");
        }
      }

      document
        .getElementById("yield-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentYieldTreeId) return;
          if (!token) {
            alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
            return;
          }
          const year = document.getElementById("yield-year").value;
          const quantity = document.getElementById("yield-quantity").value;
          try {
            const res = await fetch(
              `${API_BASE}/api/trees/${currentYieldTreeId}/yield`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ year, quantity }),
              }
            );
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Kh√¥ng th·ªÉ l∆∞u nƒÉng su·∫•t");
              return;
            }
            alert("‚úÖ ƒê√£ l∆∞u nƒÉng su·∫•t");
            closeModal("yield-modal");
            e.target.reset();
            loadTrees();
          } catch (err) {
            console.error(err);
            alert("L·ªói khi l∆∞u nƒÉng su·∫•t");
          }
        });

      // C·∫§U H√åNH HI·ªÇN TH·ªä QR
      const DISPLAY_FIELDS = [
        { key: "showName", checkboxId: "cfg-name" },
        { key: "showSpecies", checkboxId: "cfg-species" },
        { key: "showArea", checkboxId: "cfg-area" },
        { key: "showLocation", checkboxId: "cfg-location" },
        { key: "showPlantDate", checkboxId: "cfg-plantDate" },
        { key: "showVietGap", checkboxId: "cfg-vietgap" }, // VietGAP
        { key: "showImage", checkboxId: "cfg-image" },
        { key: "showCurrentHealth", checkboxId: "cfg-health" },
        { key: "showNotes", checkboxId: "cfg-notes" },
        { key: "showDiseases", checkboxId: "cfg-diseases" },
        { key: "showYield", checkboxId: "cfg-yield" },
        { key: "showOwnerName", checkboxId: "cfg-ownerName" },
      ];

      async function loadDisplayConfig() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/display-config`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const cfg = await res.json();
          if (!res.ok) {
            console.error(cfg);
            return;
          }
          displayConfig = cfg;
        } catch (err) {
          console.error("L·ªói load display config:", err);
        }
      }

      function applyDisplayConfigToModal() {
        if (!displayConfig) return;
        DISPLAY_FIELDS.forEach(({ key, checkboxId }) => {
          const cb = document.getElementById(checkboxId);
          if (!cb) return;
          cb.checked = displayConfig[key] !== false;
        });
      }

      function openDisplayConfigModal() {
        if (!displayConfig) displayConfig = {};
        applyDisplayConfigToModal();
        document
          .getElementById("display-config-modal")
          .classList.remove("hidden");
      }

      async function saveDisplayConfig() {
        if (!token) {
          alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
          return;
        }
        const payload = {};
        DISPLAY_FIELDS.forEach(({ key, checkboxId }) => {
          const cb = document.getElementById(checkboxId);
          if (!cb) return;
          payload[key] = cb.checked;
        });
        try {
          const res = await fetch(`${API_BASE}/api/display-config`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || "Kh√¥ng th·ªÉ l∆∞u c·∫•u h√¨nh");
            return;
          }
          displayConfig = data;
          alert("‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh hi·ªÉn th·ªã QR");
          closeModal("display-config-modal");
        } catch (err) {
          console.error(err);
          alert("L·ªói khi l∆∞u c·∫•u h√¨nh");
        }
      }

      // NH√ÇN VI√äN
      async function loadStaff() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/staff`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          const list = document.getElementById("staff-list");
          if (!res.ok) {
            list.innerHTML = "<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch nh√¢n vi√™n.</p>";
            return;
          }
          if (!data.length) {
            list.innerHTML =
              "<p>Ch∆∞a c√≥ nh√¢n vi√™n. H√£y t·∫°o m·ªõi b√™n tr√™n.</p>";
            return;
          }
          list.innerHTML = "";
          data.forEach((u) => {
            const row = document.createElement("div");
            row.className = "staff-row";
            row.innerHTML = `
              <span>${u.username}</span>
              <button class="btn-secondary small" onclick="deleteStaff('${
                u._id
              }')">
                Xo√°
              </button>
            `;
            list.appendChild(row);
          });
        } catch (err) {
          console.error(err);
          document.getElementById("staff-list").innerHTML =
            "<p>L·ªói khi t·∫£i nh√¢n vi√™n.</p>";
        }
      }

      async function createStaff(e) {
        e.preventDefault();
        if (!token) {
          alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
          return;
        }
        const username = document
          .getElementById("staff-username")
          .value.trim();
        const password = document
          .getElementById("staff-password")
          .value.trim();
        if (!username || !password) return;
        try {
          const res = await fetch(`${API_BASE}/api/staff`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || "Kh√¥ng th·ªÉ t·∫°o nh√¢n vi√™n");
            return;
          }
          alert("‚úÖ ƒê√£ t·∫°o nh√¢n vi√™n");
          document.getElementById("staff-form").reset();
          loadStaff();
        } catch (err) {
          console.error(err);
          alert("L·ªói khi t·∫°o nh√¢n vi√™n");
        }
      }

      async function deleteStaff(id) {
        if (!token) {
          alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
          return;
        }
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° nh√¢n vi√™n n√†y?")) return;
        try {
          const res = await fetch(`${API_BASE}/api/staff/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || "Kh√¥ng th·ªÉ xo√° nh√¢n vi√™n");
            return;
          }
          alert("‚úÖ ƒê√£ xo√° nh√¢n vi√™n");
          loadStaff();
        } catch (err) {
          console.error(err);
          alert("L·ªói khi xo√° nh√¢n vi√™n");
        }
      }

      // L·ªäCH S·ª¨
      async function loadActivity() {
        if (!token) return;
        try {
          const res = await fetch(`${API_BASE}/api/activity`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          const list = document.getElementById("activity-list");
          if (!res.ok) {
            list.innerHTML = "<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ ho·∫°t ƒë·ªông.</p>";
            return;
          }
          if (!data.length) {
            list.innerHTML = "<p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>";
            return;
          }
          list.innerHTML = "";
          data.forEach((log) => {
            const div = document.createElement("div");
            div.className = "activity-item";
            const time = new Date(log.at);
            const timeText = time.toLocaleString("vi-VN");
            div.innerHTML = `
              <div><b>${log.user}</b> (${log.role}) ‚Äì ${log.action}</div>
              ${
                log.tree
                  ? `<div class="activity-meta">C√¢y: ${log.tree}</div>`
                  : ""
              }
              <div class="activity-meta">${timeText}</div>
            `;
            list.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          document.getElementById("activity-list").innerHTML =
            "<p>L·ªói khi t·∫£i l·ªãch s·ª≠.</p>";
        }
      }

      // S·ª¨A C√ÇY
      function openEditTree(treeId) {
        const tree = lastTrees.find((t) => t._id === treeId);
        if (!tree) {
          alert("Kh√¥ng t√¨m th·∫•y c√¢y.");
          return;
        }
        currentEditTreeId = treeId;
        document.getElementById("edit-tree-location").value =
          tree.location || "";
        document.getElementById("edit-tree-date").value = tree.plantDate
          ? tree.plantDate.substring(0, 10)
          : "";
        document.getElementById("edit-tree-vietgap").value =
          tree.vietGapCode || "";
        document.getElementById("edit-tree-modal").classList.remove("hidden");
      }

      document
        .getElementById("edit-tree-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentEditTreeId) return;
          if (!token) {
            alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
            return;
          }
          const location = document
            .getElementById("edit-tree-location")
            .value.trim();
          const plantDate = document.getElementById("edit-tree-date").value;
          const vietGapCode = document
            .getElementById("edit-tree-vietgap")
            .value.trim();
          try {
            const res = await fetch(
              `${API_BASE}/api/trees/${currentEditTreeId}`,
              {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ location, plantDate, vietGapCode }),
              }
            );
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√¢y");
              return;
            }
            alert("‚úÖ ƒê√£ l∆∞u th√¥ng tin c√¢y");
            closeModal("edit-tree-modal");
            loadTrees();
          } catch (err) {
            console.error(err);
            alert("L·ªói khi l∆∞u th√¥ng tin c√¢y");
          }
        });

      // XO√Å C√ÇY
      async function deleteTree(treeId) {
        if (!token) {
          alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt, h√£y ƒëƒÉng nh·∫≠p l·∫°i.");
          return;
        }
        if (!confirm("Xo√° c√¢y n√†y? Thao t√°c kh√¥ng th·ªÉ ho√†n t√°c.")) return;
        try {
          const res = await fetch(`${API_BASE}/api/trees/${treeId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || "Kh√¥ng th·ªÉ xo√° c√¢y");
            return;
          }
          alert("‚úÖ ƒê√£ xo√° c√¢y");
          loadTrees();
        } catch (err) {
          console.error(err);
          alert("L·ªói khi xo√° c√¢y");
        }
      }

      // DOM READY
      document.addEventListener("DOMContentLoaded", () => {
        loadAreas();
        loadDiseaseMaster();
        loadStatusMaster();

        // MENU 3 G·∫†CH
        const hamburger = document.getElementById("hamburger-btn");
        const mainNav = document.getElementById("main-nav");
        const navLinks = document.querySelectorAll(".nav-link");
        if (hamburger && mainNav) {
          hamburger.addEventListener("click", () => {
            hamburger.classList.toggle("open");
            mainNav.classList.toggle("open");
          });
        }
        navLinks.forEach((btn) => {
          btn.addEventListener("click", () => {
            const targetId = btn.getAttribute("data-scroll-target");
            if (targetId) {
              const section = document.getElementById(targetId);
              if (section) {
                section.scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                });
              }
            }
            navLinks.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            if (mainNav && hamburger) {
              mainNav.classList.remove("open");
              hamburger.classList.remove("open");
            }
          });
        });

        // KHU V·ª∞C
        const addAreaBtn = document.getElementById("add-area-btn");
        if (addAreaBtn) addAreaBtn.addEventListener("click", addNewArea);

        // B·ªÜNH
        const addDisBtn = document.getElementById("add-disease-btn");
        const saveDisBtn = document.getElementById("save-disease-btn");
        if (addDisBtn) addDisBtn.addEventListener("click", addNewDisease);
        if (saveDisBtn)
          saveDisBtn.addEventListener("click", saveDiseaseForTree);

        // T√åNH TR·∫†NG
        const addStatusBtn = document.getElementById("add-status-btn");
        const saveStatusBtn = document.getElementById("save-status-btn");
        if (addStatusBtn) addStatusBtn.addEventListener("click", addNewStatus);
        if (saveStatusBtn)
          saveStatusBtn.addEventListener("click", saveStatusForTree);

        // C·∫§U H√åNH HI·ªÇN TH·ªä
        const displayBtn = document.getElementById("display-config-btn");
        const saveDisplayBtn = document.getElementById(
          "save-display-config-btn"
        );
        if (displayBtn)
          displayBtn.addEventListener("click", openDisplayConfigModal);
        if (saveDisplayBtn)
          saveDisplayBtn.addEventListener("click", saveDisplayConfig);

        // NH√ÇN VI√äN
        const staffForm = document.getElementById("staff-form");
        if (staffForm) staffForm.addEventListener("submit", createStaff);

        // SEARCH & FILTER C√ÇY
        const searchInput = document.getElementById("tree-search-input");
        if (searchInput) {
          searchInput.addEventListener("input", () => {
            treeSearchTerm = searchInput.value || "";
            renderTreeList();
          });
        }
        const filterButtons = document.querySelectorAll("[data-tree-filter]");
        filterButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const value = btn.getAttribute("data-tree-filter") || "all";
            treeStatusFilter = value;
            filterButtons.forEach((b) =>
              b.classList.toggle("active", b === btn)
            );
            renderTreeList();
          });
        });

        // T·ª∞ ƒêƒÇNG NH·∫¨P N·∫æU C√ì TOKEN
        if (token && currentUser) {
          setupAfterLogin();
        }
      });

      // G·∫ÆN GLOBAL CHO HTML
      window.openQrModal = openQrModal;
      window.closeModal = closeModal;
      window.openYield = openYield;
      window.openDiseaseModal = openDiseaseModal;
      window.openStatusModal = openStatusModal;
      window.deleteStaff = deleteStaff;
      window.deleteTree = deleteTree;
      window.openEditTree = openEditTree;
    </script>
  </body>
</html>
