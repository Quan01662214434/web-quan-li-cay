<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh Huyá»n Farm â€“ Quáº£n lÃ½ vÆ°á»n VietGAP</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <!-- HEADER -->
    <header class="app-header">
      <div class="header-left">
        <img src="logo.svg" class="logo" />
        <div class="header-title">
          <span class="brand-name">Thanh Huyá»n Farm</span>
          <span class="brand-subtitle">VÆ°á»n sáº§u riÃªng VietGAP</span>
        </div>
      </div>
      <button id="menuBtn" class="hamburger">
        <span></span><span></span><span></span>
      </button>
    </header>

    <!-- MENU SIDEBAR -->
    <nav id="sideMenu" class="sidebar">
      <ul>
        <li><a href="#" id="menuDashboard">ğŸ¡ Trang chÃ­nh</a></li>
        <li><a href="#" id="menuAddTree">ğŸŒ³ ThÃªm cÃ¢y</a></li>
        <li><a href="#" id="menuChart">ğŸ“Š NÄƒng suáº¥t</a></li>
        <li><a href="#" id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</a></li>
      </ul>
    </nav>

    <!-- LOGIN -->
    <section id="loginSection">
      <div class="login-card card">
        <h2>ÄÄƒng nháº­p</h2>
        <input id="username" placeholder="TÃªn Ä‘Äƒng nháº­p" />
        <input id="password" type="password" placeholder="Máº­t kháº©u" />
        <button id="loginBtn" class="btn-primary full-width">ÄÄƒng nháº­p</button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboardSection" class="hidden section">
      <div class="farm-vietgap-card">
        <div class="vietgap-logo-circle"><span class="vg-text">VG</span></div>
        <div class="farm-vietgap-info">
          <div class="farm-vietgap-title">VÆ°á»n Ä‘áº¡t chuáº©n VietGAP</div>
          <div class="farm-vietgap-detail">MÃ£ sá»‘: <b id="farmVietgap">TH-VG-001</b></div>
        </div>
      </div>

      <div class="top-bar">
        <input type="text" id="searchTree" placeholder="ğŸ” TÃ¬m cÃ¢y theo tÃªn, giá»‘ng, vá»‹ trÃ­, VietGAP, ghi chÃº..." />
        <button id="refreshBtn" class="btn-primary small">LÃ m má»›i</button>
      </div>

      <div id="treeList" class="tree-list"></div>
    </section>

    <!-- BIá»‚U Äá»’ -->
    <section id="chartSection" class="hidden section">
      <canvas id="yieldChart"></canvas>
    </section>

    <!-- POPUP FORM -->
    <div id="treeModal" class="modal hidden">
      <div class="modal-content">
        <h3 id="modalTitle">ThÃªm cÃ¢y má»›i</h3>
        <input id="treeName" placeholder="TÃªn cÃ¢y" />
        <input id="treeSpecies" placeholder="Giá»‘ng cÃ¢y" />
        <input id="treeLocation" placeholder="Vá»‹ trÃ­" />
        <input id="treePlantDate" type="date" />
        <input id="treeVietGapCode" placeholder="MÃ£ VietGAP" />
        <input id="treeHealth" placeholder="TÃ¬nh tráº¡ng" />
        <textarea id="treeNotes" placeholder="Ghi chÃº"></textarea>

        <button id="saveTreeBtn" class="btn-primary full-width">LÆ°u</button>
        <button id="cancelTreeBtn" class="btn-secondary full-width">Há»§y</button>
      </div>
    </div>

    <script>
      const API_BASE = "https://api.thefram.site";
      const menuBtn = document.getElementById("menuBtn");
      const sideMenu = document.getElementById("sideMenu");
      const treeModal = document.getElementById("treeModal");
      const modalTitle = document.getElementById("modalTitle");
      const saveTreeBtn = document.getElementById("saveTreeBtn");
      const cancelTreeBtn = document.getElementById("cancelTreeBtn");

      let editingTree = null;

      menuBtn.onclick = () => {
        sideMenu.classList.toggle("show");
        menuBtn.classList.toggle("open");
      };

      function showSection(id) {
        document.querySelectorAll("section").forEach((s) => s.classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
      }

      /* LOGIN */
      async function login() {
        const u = username.value.trim();
        const p = password.value.trim();
        if (!u || !p) return alert("Nháº­p Ä‘á»§ thÃ´ng tin!");
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: u, password: p }),
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || "Lá»—i Ä‘Äƒng nháº­p");
        localStorage.setItem("token", data.token);
        showDashboard();
      }

      loginBtn.onclick = login;
      logoutBtn.onclick = () => {
        localStorage.clear();
        showSection("loginSection");
      };

      menuDashboard.onclick = () => showDashboard();
      menuChart.onclick = () => showChart();
      menuAddTree.onclick = () => openModal();

      /* LOAD DANH SÃCH CÃ‚Y */
      async function loadTrees() {
        const token = localStorage.getItem("token");
        const res = await fetch(`${API_BASE}/api/trees`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const container = document.getElementById("treeList");
        if (!res.ok) return (container.innerHTML = "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch cÃ¢y");

        const searchVal = searchTree.value.toLowerCase();
        const filtered = data.filter((t) => {
          const val = searchVal.toLowerCase();
          return (
            t.name?.toLowerCase().includes(val) ||
            t.species?.toLowerCase().includes(val) ||
            t.location?.toLowerCase().includes(val) ||
            t.vietGapCode?.toLowerCase().includes(val) ||
            t.notes?.toLowerCase().includes(val)
          );
        });

        container.innerHTML = filtered
          .map(
            (t) => `
          <div class="tree-card">
            <div>
              <b>${t.name}</b> (${t.species})<br/>
              ğŸ“ ${t.location || "-"}<br/>
              ğŸ§¾ VietGAP: ${t.vietGapCode || "-"}
            </div>
            <div class="card-actions">
              <button class="btn-edit" onclick="editTree('${t._id}')">âœï¸</button>
              <button class="btn-delete" onclick="deleteTree('${t._id}')">ğŸ—‘ï¸</button>
              <img src="${t.qrCode}" class="qr-img" />
            </div>
          </div>`
          )
          .join("");
      }

      /* THÃŠM / Sá»¬A CÃ‚Y */
      function openModal(tree = null) {
        editingTree = tree;
        modalTitle.innerText = tree ? "Sá»­a thÃ´ng tin cÃ¢y" : "ThÃªm cÃ¢y má»›i";
        treeModal.classList.remove("hidden");
        if (tree) {
          treeName.value = tree.name;
          treeSpecies.value = tree.species;
          treeLocation.value = tree.location;
          treePlantDate.value = tree.plantDate?.split("T")[0];
          treeVietGapCode.value = tree.vietGapCode;
          treeHealth.value = tree.currentHealth;
          treeNotes.value = tree.notes;
        } else {
          treeName.value =
            treeSpecies.value =
            treeLocation.value =
            treeVietGapCode.value =
            treeHealth.value =
            treeNotes.value =
              "";
          treePlantDate.value = "";
        }
      }

      cancelTreeBtn.onclick = () => treeModal.classList.add("hidden");

      saveTreeBtn.onclick = async () => {
        const body = {
          name: treeName.value,
          species: treeSpecies.value,
          location: treeLocation.value,
          plantDate: treePlantDate.value,
          vietGapCode: treeVietGapCode.value,
          currentHealth: treeHealth.value,
          notes: treeNotes.value,
        };

        const token = localStorage.getItem("token");
        const method = editingTree ? "PUT" : "POST";
        const url = editingTree
          ? `${API_BASE}/api/trees/${editingTree._id}`
          : `${API_BASE}/api/trees`;

        const res = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) return alert("LÆ°u tháº¥t báº¡i");
        alert("ÄÃ£ lÆ°u!");
        treeModal.classList.add("hidden");
        loadTrees();
      };

      async function editTree(id) {
        const token = localStorage.getItem("token");
        const res = await fetch(`${API_BASE}/api/trees`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const trees = await res.json();
        const tree = trees.find((t) => t._id === id);
        if (tree) openModal(tree);
      }

      async function deleteTree(id) {
        if (!confirm("XÃ³a cÃ¢y nÃ y?")) return;
        const token = localStorage.getItem("token");
        await fetch(`${API_BASE}/api/trees/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });
        loadTrees();
      }

      /* BIá»‚U Äá»’ NÄ‚NG SUáº¤T */
      async function showChart() {
        showSection("chartSection");
        const ctx = document.getElementById("yieldChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["2021", "2022", "2023", "2024"],
            datasets: [
              {
                label: "NÄƒng suáº¥t (kg)",
                data: [12000, 15000, 18000, 20000],
                backgroundColor: "#2e7d32",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
            },
          },
        });
      }

      function showDashboard() {
        showSection("dashboardSection");
        loadTrees();
      }

      refreshBtn.onclick = loadTrees;
      searchTree.oninput = loadTrees;
      if (localStorage.getItem("token")) showDashboard();
    </script>
  </body>
</html>
