<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>V∆∞·ªùn s·∫ßu ri√™ng Thanh Huy·ªÅn</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    />
    <link rel="stylesheet" href="./style.css" />
    <!-- Chart.js cho bi·ªÉu ƒë·ªì nƒÉng su·∫•t -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <!-- BACKGROUND V∆Ø·ªúN S·∫¶U RI√äNG ƒê√É ƒê·∫∂T TRONG CSS -->

      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-logo">
          <!-- Logo ki·ªÉu ch·ªØ + l√° -->
          <div class="logo-mark">
            <div class="logo-leaf"></div>
            <div class="logo-durian"></div>
          </div>
          <div class="sidebar-logo-text">
            <div class="sidebar-title">THANH HUY·ªÄN FARM</div>
            <div class="sidebar-subtitle">
              V∆∞·ªùn s·∫ßu ri√™ng ‚Äì L√¢m ƒê·ªìng
            </div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-label">ƒêi·ªÅu h∆∞·ªõng</div>
            <button
              class="nav-item nav-item-active"
              id="nav-public"
              type="button"
            >
              <span>Trang gi·ªõi thi·ªáu</span>
            </button>
            <button class="nav-item" id="nav-farm" type="button">
              <span>B·∫£ng ƒëi·ªÅu khi·ªÉn v∆∞·ªùn</span>
            </button>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="sidebar-footer-text">
            <div class="sf-title">Thanh Huy·ªÅn Smart Farm</div>
            <div class="sf-sub">Qu·∫£n l√Ω s·∫ßu ri√™ng b·∫±ng m√£ QR</div>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <div class="main-area">
        <!-- TOPBAR -->
        <header class="topbar">
          <div>
            <div class="topbar-title">V∆∞·ªùn s·∫ßu ri√™ng Thanh Huy·ªÅn</div>
            <div class="topbar-subtitle" id="topbar-subtitle">
              Qu·∫£n l√Ω c√¢y, nh√¢n vi√™n v√† nƒÉng su·∫•t theo nƒÉm.
            </div>
          </div>
          <div class="topbar-right">
            <button class="btn-ghost small" id="logout-btn" style="display: none">
              ƒêƒÉng xu·∫•t
            </button>
            <div class="user-chip" id="user-chip" style="display: none">
              ƒêang ƒëƒÉng nh·∫≠p: <span id="user-chip-name"></span>
            </div>
          </div>
        </header>

        <!-- CONTENT -->
        <main class="main-content">
          <!-- VIEW: PUBLIC (ch∆∞a ƒëƒÉng nh·∫≠p / kh√°ch qu√©t QR) -->
          <section id="public-view" class="view">
            <div class="card hero-public">
              <div class="hero-public-main">
                <div>
                  <div class="hero-kicker">V∆Ø·ªúN S·∫¶U RI√äNG</div>
                  <h1 class="hero-heading">
                    Thanh Huy·ªÅn Farm ‚Äì Qu·∫£n l√Ω t·ª´ng c√¢y s·∫ßu ri√™ng b·∫±ng m√£ QR
                  </h1>
                  <p class="hero-text">
                    Theo d√µi s·ª©c kh·ªèe t·ª´ng c√¢y, ghi nh·∫≠n b·ªánh, qu·∫£n l√Ω nƒÉng su·∫•t
                    v√† ph√¢n c√¥ng nh√¢n vi√™n chƒÉm s√≥c ‚Äì t·∫•t c·∫£ trong m·ªôt trang duy
                    nh·∫•t.
                  </p>
                  <ul class="hero-bullets">
                    <li>M·ªói c√¢y m·ªôt m√£ QR c·ªë ƒë·ªãnh, qu√©t l√† xem th√¥ng tin m·ªõi nh·∫•t.</li>
                    <li>Nh√¢n vi√™n c·∫≠p nh·∫≠t, ch·ªß v∆∞·ªùn xem l·ªãch s·ª≠ ai ƒë√£ thay ƒë·ªïi.</li>
                    <li>NƒÉng su·∫•t ƒë∆∞·ª£c l∆∞u theo t·ª´ng nƒÉm cho t·ª´ng c√¢y.</li>
                  </ul>
                </div>
              </div>
              <div class="hero-public-side">
                <div class="card login-card">
                  <div class="card-header">
                    <div>
                      <div class="card-title">ƒêƒÉng nh·∫≠p qu·∫£n l√Ω v∆∞·ªùn</div>
                      <div class="card-desc">
                        Ch·ªß v∆∞·ªùn v√† nh√¢n vi√™n ƒëƒÉng nh·∫≠p ƒë·ªÉ l√†m vi·ªác.
                      </div>
                    </div>
                  </div>
                  <form id="login-form">
                    <label for="login-username">T√†i kho·∫£n</label>
                    <input
                      id="login-username"
                      placeholder="V√≠ d·ª•: thanh_huyen, nhanvien01..."
                      autocomplete="username"
                    />
                    <label for="login-password">M·∫≠t kh·∫©u</label>
                    <input
                      id="login-password"
                      type="password"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      autocomplete="current-password"
                    />
                    <div class="form-footer">
                      <button type="submit" class="btn">ƒêƒÉng nh·∫≠p</button>
                      <div class="muted small">
                        T√†i kho·∫£n nh√¢n vi√™n do ch·ªß v∆∞·ªùn c·∫•p.
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- C√ÇY T·ª™ QR (KHI V√ÄO ?tree=xxx) -->
            <div id="qr-tree-preview" class="card" style="display: none">
              <div class="card-header">
                <div>
                  <div class="card-title">Th√¥ng tin c√¢y t·ª´ m√£ QR</div>
                  <div class="card-desc">
                    D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ h·ªá th·ªëng qu·∫£n l√Ω v∆∞·ªùn Thanh
                    Huy·ªÅn.
                  </div>
                </div>
              </div>
              <div class="qr-tree-details">
                <div class="qr-tree-main">
                  <div class="qr-tree-id" id="qr-tree-preview-id">#‚Äî</div>
                  <div>
                    <div class="qr-tree-name" id="qr-tree-preview-name">
                      T√™n c√¢y
                    </div>
                    <div class="qr-tree-meta" id="qr-tree-preview-meta">
                      Gi·ªëng ¬∑ V·ªã tr√≠ ¬∑ Ch·ªß v∆∞·ªùn
                    </div>
                  </div>
                </div>
                <div class="qr-tree-health" id="qr-tree-preview-health">
                  T√¨nh tr·∫°ng
                </div>
                <div class="qr-tree-notes" id="qr-tree-preview-notes"></div>
                <div class="qr-tree-extra">
                  <div
                    class="qr-tree-diseases"
                    id="qr-tree-diseases"
                  ></div>
                  <div class="qr-tree-yield" id="qr-tree-yield"></div>
                </div>
              </div>
            </div>

            <!-- Tin t·ª©c v∆∞·ªùn -->
            <div class="card public-news-card">
              <div class="card-header">
                <div>
                  <div class="card-title">Nh·∫≠t k√Ω v∆∞·ªùn Thanh Huy·ªÅn</div>
                  <div class="card-desc">
                    M·ªôt v√†i ghi ch√∫ xoay quanh canh t√°c s·∫ßu ri√™ng c·ªßa v∆∞·ªùn.
                  </div>
                </div>
              </div>
              <div class="public-news-grid">
                <article class="news-item">
                  <div class="news-label">CHƒÇM S√ìC</div>
                  <h3 class="news-title">
                    Qu·∫£n l√Ω s√¢u b·ªánh tr√™n s·∫ßu ri√™ng m√πa m∆∞a
                  </h3>
                  <p class="news-text">
                    Ghi ch√©p t·ª´ng l·∫ßn phun thu·ªëc, b√≥n ph√¢n theo t·ª´ng c√¢y gi√∫p
                    ki·ªÉm so√°t l∆∞·ª£ng s·ª≠ d·ª•ng v√† t·ªëi ∆∞u chi ph√≠.
                  </p>
                </article>

                <article class="news-item">
                  <div class="news-label">NH√ÇN S·ª∞</div>
                  <h3 class="news-title">
                    Ph√¢n c√¥ng nh√¢n vi√™n theo khu, theo l√¥ c√¢y
                  </h3>
                  <p class="news-text">
                    Nh√¢n vi√™n ƒëƒÉng nh·∫≠p, xem c√¢y c·∫ßn chƒÉm s√≥c v√† c·∫≠p nh·∫≠t t√¨nh
                    tr·∫°ng sau khi l√†m vi·ªác.
                  </p>
                </article>

                <article class="news-item">
                  <div class="news-label">NƒÇNG SU·∫§T</div>
                  <h3 class="news-title">
                    Theo d√µi nƒÉng su·∫•t t·ª´ng nƒÉm cho t·ª´ng c√¢y
                  </h3>
                  <p class="news-text">
                    Ghi nh·∫≠n nƒÉng su·∫•t theo nƒÉm gi√∫p ƒë√°nh gi√° hi·ªáu qu·∫£ t·ª´ng c√¢y
                    v√† c·∫£ v∆∞·ªùn.
                  </p>
                </article>
              </div>
            </div>
          </section>

          <!-- VIEW: V∆Ø·ªúN (ch·ªß v∆∞·ªùn / nh√¢n vi√™n) -->
          <section id="farm-view" class="view" style="display: none">
            <!-- Hero v∆∞·ªùn -->
            <div class="card">
              <div class="hero-card">
                <div class="hero-main">
                  <div class="hero-logo">üåø</div>
                  <div>
                    <div class="hero-title" id="farm-hero-name">
                      V∆∞·ªùn s·∫ßu ri√™ng Thanh Huy·ªÅn
                    </div>
                    <div class="hero-desc" id="farm-hero-desc">
                      Th√¥ng tin t·ªïng quan c√¢y, nh√¢n vi√™n v√† nƒÉng su·∫•t.
                    </div>
                  </div>
                </div>
                <div class="hero-stats">
                  <div class="hero-stat">
                    <div class="hero-stat-label">T·ªïng s·ªë c√¢y</div>
                    <div class="hero-stat-value" id="stat-total-trees">0</div>
                  </div>
                  <div class="hero-stat">
                    <div class="hero-stat-label">C√¢y c·∫ßn ch√∫ √Ω</div>
                    <div
                      class="hero-stat-value danger"
                      id="stat-bad-trees"
                    >
                      0
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Qu·∫£n l√Ω nh√¢n vi√™n (ch·ªâ ch·ªß v∆∞·ªùn) -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Nh√¢n vi√™n v∆∞·ªùn Thanh Huy·ªÅn</div>
                  <div class="card-desc">
                    Ch·ªß v∆∞·ªùn t·∫°o t√†i kho·∫£n cho nh√¢n vi√™n, x√≥a khi nh√¢n vi√™n ngh·ªâ
                    vi·ªác.
                  </div>
                </div>
              </div>
              <div id="owner-staff-panel">
                <form id="create-staff-form">
                  <div class="field-row">
                    <div>
                      <label for="staff-username">T√†i kho·∫£n nh√¢n vi√™n</label>
                      <input
                        id="staff-username"
                        placeholder="VD: nhanvien01"
                      />
                    </div>
                    <div>
                      <label for="staff-password">M·∫≠t kh·∫©u</label>
                      <input
                        id="staff-password"
                        type="password"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      />
                    </div>
                  </div>
                  <div class="form-footer">
                    <button type="submit" class="btn">
                      Th√™m nh√¢n vi√™n
                    </button>
                    <div class="muted small">
                      Nh√¢n vi√™n ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n n√†y ƒë·ªÉ c·∫≠p nh·∫≠t c√¢y.
                    </div>
                  </div>
                </form>
                <div class="table-wrapper" style="margin-top: 10px">
                  <table>
                    <thead>
                      <tr>
                        <th>T√†i kho·∫£n</th>
                        <th>Tham gia</th>
                        <th>Thao t√°c</th>
                      </tr>
                    </thead>
                    <tbody id="staff-table-body">
                      <tr>
                        <td colspan="3" class="empty-text">
                          ƒêang t·∫£i danh s√°ch nh√¢n vi√™n...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div
                id="staff-readonly-note"
                class="muted small"
                style="display: none; margin-top: 6px"
              >
                B·∫°n ƒëang ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n nh√¢n vi√™n, kh√¥ng c√≥ quy·ªÅn qu·∫£n
                l√Ω nh√¢n vi√™n.
              </div>
            </div>

            <!-- Form t·∫°o c√¢y (ch·ªâ ch·ªß v∆∞·ªùn) -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">T·∫°o c√¢y s·∫ßu ri√™ng m·ªõi</div>
                  <div class="card-desc">
                    Nh·∫≠p th√¥ng tin c√¢y. H·ªá th·ªëng s·∫Ω t·ª± t·∫°o m√£ QR c·ªë ƒë·ªãnh cho
                    c√¢y n√†y.
                  </div>
                </div>
              </div>
              <form id="create-tree-form">
                <div class="field-row">
                  <div>
                    <label for="tree-name">T√™n c√¢y *</label>
                    <input
                      id="tree-name"
                      placeholder="VD: SR-01, SR-02..."
                    />
                  </div>
                  <div>
                    <label for="tree-species">Gi·ªëng</label>
                    <input
                      id="tree-species"
                      placeholder="VD: Ri6, Monthong..."
                    />
                  </div>
                </div>
                <div class="field-row">
                  <div>
                    <label for="tree-location">V·ªã tr√≠</label>
                    <input
                      id="tree-location"
                      placeholder="VD: L√¥ A3, H√†ng B..."
                    />
                  </div>
                  <div>
                    <label for="tree-plant-date">Ng√†y tr·ªìng</label>
                    <input
                      id="tree-plant-date"
                      type="date"
                      placeholder="YYYY-MM-DD"
                    />
                  </div>
                </div>
                <div class="form-footer">
                  <button type="submit" id="create-tree-btn" class="btn">
                    T·∫°o c√¢y & QR
                  </button>
                  <div class="muted small">
                    Nh√¢n vi√™n ch·ªâ xem v√† c·∫≠p nh·∫≠t t√¨nh tr·∫°ng / b·ªánh / nƒÉng su·∫•t,
                    kh√¥ng t·∫°o c√¢y.
                  </div>
                </div>
              </form>
            </div>

            <!-- Danh s√°ch c√¢y -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Danh s√°ch c√¢y trong v∆∞·ªùn</div>
                  <div class="card-desc">
                    C·∫≠p nh·∫≠t s·ª©c kh·ªèe, b·ªánh, nƒÉng su·∫•t, xem m√£ QR v√† l·ªãch s·ª≠ ho·∫°t
                    ƒë·ªông t·ª´ng c√¢y.
                  </div>
                </div>
              </div>
              <div class="filter-row">
                <button
                  type="button"
                  class="pill-filter active"
                  data-health="all"
                >
                  T·∫•t c·∫£
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="T·ªët"
                >
                  T·ªët
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="B√¨nh th∆∞·ªùng"
                >
                  B√¨nh th∆∞·ªùng
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="Y·∫øu"
                >
                  Y·∫øu
                </button>
                <button
                  type="button"
                  class="pill-filter"
                  data-health="Nguy hi·ªÉm"
                >
                  Nguy hi·ªÉm
                </button>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>C√¢y</th>
                      <th>Gi·ªëng</th>
                      <th>V·ªã tr√≠</th>
                      <th>T√¨nh tr·∫°ng</th>
                      <th>B·ªánh</th>
                      <th>QR</th>
                      <th>C·∫≠p nh·∫≠t</th>
                      <th>Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody id="tree-table-body">
                    <tr>
                      <td colspan="9" class="empty-text">
                        Ch∆∞a c√≥ d·ªØ li·ªáu.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- QR MODAL -->
    <div id="qr-modal-backdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">M√£ QR c√¢y</div>
            <div class="modal-subtitle">
              Qu√©t b·∫±ng ƒëi·ªán tho·∫°i ƒë·ªÉ m·ªü nhanh th√¥ng tin c√¢y.
            </div>
          </div>
          <button id="qr-modal-close" class="btn-ghost small" type="button">
            ƒê√≥ng
          </button>
        </div>
        <div class="modal-body">
          <img id="qr-modal-img" class="qr-modal-img" src="" alt="QR Code" />

          <div class="qr-info">
            <div class="qr-info-line">
              <span class="qr-label">T√™n c√¢y:</span>
              <span id="qr-tree-name" class="qr-value"></span>
            </div>
            <div class="qr-info-line">
              <span class="qr-label">V·ªã tr√≠:</span>
              <span id="qr-tree-location" class="qr-value"></span>
            </div>
            <div class="qr-info-line">
              <span class="qr-label">Ch·ªß v∆∞·ªùn:</span>
              <span id="qr-tree-owner" class="qr-value"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DISEASE MODAL -->
    <div id="disease-modal-backdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">C·∫≠p nh·∫≠t b·ªánh cho c√¢y</div>
            <div class="modal-subtitle">
              Ch·ªçn c√°c b·ªánh hi·ªán t·∫°i ho·∫∑c th√™m b·ªánh m·ªõi v√†o danh s√°ch.
            </div>
          </div>
          <button
            id="disease-modal-close"
            class="btn-ghost small"
            type="button"
          >
            ƒê√≥ng
          </button>
        </div>
        <div class="modal-body">
          <div class="field-row">
            <div>
              <label for="disease-select">B·ªánh ƒëang c√≥</label>
              <select id="disease-select" multiple></select>
              <div class="muted small">
                Gi·ªØ Ctrl (ho·∫∑c b·∫•m nhi·ªÅu l·∫ßn) ƒë·ªÉ ch·ªçn nhi·ªÅu b·ªánh.
              </div>
            </div>
            <div>
              <label for="new-disease-input">Th√™m b·ªánh m·ªõi</label>
              <input
                id="new-disease-input"
                placeholder="VD: S√¢u ƒë·ª•c th√¢n"
              />
              <button
                id="add-disease-btn"
                class="btn-ghost small"
                type="button"
                style="margin-top: 4px"
              >
                Th√™m v√†o danh s√°ch
              </button>
            </div>
          </div>
          <div class="form-footer" style="margin-top: 10px">
            <button id="save-disease-btn" class="btn" type="button">
              L∆∞u danh s√°ch b·ªánh
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- YIELD MODAL -->
    <div id="yield-modal-backdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">NƒÉng su·∫•t theo nƒÉm</div>
            <div class="modal-subtitle">
              Th√™m s·ªë kg thu ho·∫°ch theo t·ª´ng nƒÉm cho c√¢y n√†y.
            </div>
          </div>
          <button id="yield-modal-close" class="btn-ghost small" type="button">
            ƒê√≥ng
          </button>
        </div>
        <div class="modal-body">
          <div class="field-row">
            <div>
              <label for="yield-year-input">NƒÉm</label>
              <input
                id="yield-year-input"
                type="number"
                placeholder="VD: 2021"
              />
            </div>
            <div>
              <label for="yield-qty-input">S·∫£n l∆∞·ª£ng (kg)</label>
              <input
                id="yield-qty-input"
                type="number"
                placeholder="VD: 20000"
              />
            </div>
          </div>
          <div class="form-footer" style="margin-top: 8px">
            <button id="add-yield-btn" class="btn" type="button">
              L∆∞u nƒÉng su·∫•t
            </button>
            <div class="muted small">
              N·∫øu ƒë√£ c√≥ nƒÉm ƒë√≥, s·ªë kg s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫°i.
            </div>
          </div>

          <div style="margin-top: 12px">
            <canvas id="yield-chart" height="180"></canvas>
          </div>

          <div class="yield-list" id="yield-list"></div>
        </div>
      </div>
    </div>

    <!-- LOGS MODAL -->
    <div id="logs-modal-backdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">L·ªãch s·ª≠ ho·∫°t ƒë·ªông c√¢y</div>
            <div class="modal-subtitle">
              Xem ai ƒë√£ thay ƒë·ªïi g√¨ v√† v√†o l√∫c n√†o.
            </div>
          </div>
          <button id="logs-modal-close" class="btn-ghost small" type="button">
            ƒê√≥ng
          </button>
        </div>
        <div class="modal-body">
          <div
            id="logs-list"
            style="max-height: 260px; overflow: auto; font-size: 12px"
          ></div>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <script>
      // ==== CONFIG API ====
      // N·∫øu frontend & backend c√πng server: ƒë·ªÉ tr·ªëng "" l√† t·ª± g·ªçi c√πng domain
      const API_BASE = "";
      // N·∫øu backend t√°ch ri√™ng (Render), s·ª≠a th√†nh:
      // const API_BASE = "https://ten-backend.onrender.com";

      let currentUser = null;
      let authToken = null;
      let treesCache = [];
      let staffCache = [];
      let diseaseMasterList = [
        "S√¢u ƒë·ª•c th√¢n",
        "Th·ªëi r·ªÖ",
        "N·ª©t th√¢n x√¨ m·ªß",
        "V√†ng l√°",
      ];

      let currentTreeForDisease = null;
      let currentTreeForYield = null;
      let currentYieldChart = null;

      // === THEME ===
      function hexToRgba(hex, alpha) {
        try {
          let c = hex.replace("#", "");
          if (c.length === 3) {
            c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2];
          }
          const r = parseInt(c.slice(0, 2), 16);
          const g = parseInt(c.slice(2, 4), 16);
          const b = parseInt(c.slice(4, 6), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        } catch (e) {
          return "rgba(22, 163, 74, 0.18)";
        }
      }

      function applyThemeForUser(user) {
        const root = document.documentElement;
        const color =
          (user && user.farmPrimaryColor && user.farmPrimaryColor.trim()) ||
          "#16a34a";
        root.style.setProperty("--accent", color);
        root.style.setProperty("--accent-soft", hexToRgba(color, 0.14));
      }

      // === TOAST ===
      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.toggle("error", isError);
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 2600);
      }

      // === VIEW SWITCH ===
      function showView(viewId) {
        const views = ["public-view", "farm-view"];
        views.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = id === viewId ? "block" : "none";
        });

        document.querySelectorAll(".nav-item").forEach((btn) => {
          btn.classList.remove("nav-item-active");
        });
        if (viewId === "public-view") {
          document.getElementById("nav-public").classList.add("nav-item-active");
        } else if (viewId === "farm-view") {
          document.getElementById("nav-farm").classList.add("nav-item-active");
        }
      }

      function updateTopbarInfo() {
        const chip = document.getElementById("user-chip");
        const chipName = document.getElementById("user-chip-name");
        const logoutBtn = document.getElementById("logout-btn");
        const subtitle = document.getElementById("topbar-subtitle");

        if (!currentUser) {
          chip.style.display = "none";
          logoutBtn.style.display = "none";
          subtitle.textContent =
            "Qu·∫£n l√Ω c√¢y, nh√¢n vi√™n v√† nƒÉng su·∫•t theo nƒÉm.";
          return;
        }

        chip.style.display = "inline-flex";
        logoutBtn.style.display = "inline-flex";
        chipName.textContent = `${currentUser.username} (${currentUser.role})`;

        if (currentUser.role === "owner") {
          subtitle.textContent =
            currentUser.farmName || "Trang qu·∫£n l√Ω v∆∞·ªùn Thanh Huy·ªÅn";
        } else {
          subtitle.textContent = "Trang l√†m vi·ªác c·ªßa nh√¢n vi√™n v∆∞·ªùn Thanh Huy·ªÅn";
        }
      }

      function updateUIForLoggedOut() {
        currentUser = null;
        authToken = null;
        applyThemeForUser(null);
        updateTopbarInfo();
        showView("public-view");
      }

      function updateUIAfterLogin() {
        if (!currentUser) return;
        applyThemeForUser(currentUser);
        updateTopbarInfo();
        showView("farm-view");
        loadTrees();
        if (currentUser.role === "owner") {
          loadStaff();
          document.getElementById("owner-staff-panel").style.display = "block";
          document.getElementById("staff-readonly-note").style.display = "none";
          document.getElementById("create-tree-form").style.display = "block";
        } else {
          document.getElementById("owner-staff-panel").style.display = "none";
          document.getElementById("staff-readonly-note").style.display =
            "block";
          document.getElementById("create-tree-form").style.display = "none";
        }
      }

      // === API WRAPPER ===
      async function apiFetch(path, options = {}) {
        const url = API_BASE ? `${API_BASE}${path}` : path;
        const headers = options.headers || {};
        if (authToken) {
          headers["Authorization"] = `Bearer ${authToken}`;
        }
        if (!headers["Content-Type"] && options.body) {
          headers["Content-Type"] = "application/json";
        }
        const res = await fetch(url, { ...options, headers });
        let data = null;
        try {
          data = await res.json();
        } catch (e) {}
        if (!res.ok) {
          const msg = (data && data.error) || "L·ªói k·∫øt n·ªëi server";
          throw new Error(msg);
        }
        return data;
      }

      // === LOGIN / LOGOUT ===
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("login-username").value.trim();
          const password = document.getElementById("login-password").value.trim();
          if (!username || !password) {
            showToast("Vui l√≤ng nh·∫≠p t√†i kho·∫£n v√† m·∫≠t kh·∫©u", true);
            return;
          }
          try {
            const data = await apiFetch("/auth/login", {
              method: "POST",
              body: JSON.stringify({ username, password }),
            });
            authToken = data.token;
            currentUser = data.user;
            localStorage.setItem("authToken", authToken);
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
            updateUIAfterLogin();
          } catch (err) {
            showToast(err.message, true);
          }
        });

      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("authToken");
        localStorage.removeItem("currentUser");
        showToast("ƒê√£ ƒëƒÉng xu·∫•t");
        updateUIForLoggedOut();
      });

      // === NAV BUTTONS ===
      document.getElementById("nav-public").addEventListener("click", () => {
        if (!currentUser) {
          showView("public-view");
        } else {
          showView("farm-view");
        }
      });

      document.getElementById("nav-farm").addEventListener("click", () => {
        if (!currentUser) {
          showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ v√†o v∆∞·ªùn", true);
          return;
        }
        showView("farm-view");
        loadTrees();
        if (currentUser.role === "owner") loadStaff();
      });

      // === STAFF (owner) ===
      async function loadStaff() {
        try {
          const staff = await apiFetch("/owner/staff", {
            method: "GET",
          });
          staffCache = staff || [];
          renderStaff();
        } catch (err) {
          staffCache = [];
          renderStaff();
        }
      }

      function renderStaff() {
        const body = document.getElementById("staff-table-body");
        if (!staffCache.length) {
          body.innerHTML =
            '<tr><td colspan="3" class="empty-text">Ch∆∞a c√≥ nh√¢n vi√™n n√†o.</td></tr>';
          return;
        }
        body.innerHTML = staffCache
          .map((s) => {
            const created =
              (s.createdAt && s.createdAt.slice(0, 10)) || "‚Äî";
            return `
          <tr>
            <td>${s.username}</td>
            <td>${created}</td>
            <td>
              <button class="btn-table danger-btn" type="button" onclick="deleteStaff('${s._id}')">
                X√≥a
              </button>
            </td>
          </tr>
        `;
          })
          .join("");
      }

      document
        .getElementById("create-staff-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentUser || currentUser.role !== "owner") {
            showToast("Ch·ªâ ch·ªß v∆∞·ªùn m·ªõi t·∫°o nh√¢n vi√™n", true);
            return;
          }
          const username = document
            .getElementById("staff-username")
            .value.trim();
          const password = document
            .getElementById("staff-password")
            .value.trim();
          if (!username || !password) {
            showToast("Vui l√≤ng nh·∫≠p t√†i kho·∫£n v√† m·∫≠t kh·∫©u nh√¢n vi√™n", true);
            return;
          }
          try {
            await apiFetch("/owner/staff", {
              method: "POST",
              body: JSON.stringify({ username, password }),
            });
            showToast("ƒê√£ t·∫°o nh√¢n vi√™n");
            e.target.reset();
            loadStaff();
          } catch (err) {
            showToast("Kh√¥ng th·ªÉ t·∫°o nh√¢n vi√™n: " + err.message, true);
          }
        });

      window.deleteStaff = async function (id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n n√†y?")) return;
        try {
          await apiFetch(`/api/staff/${id}`, { method: "DELETE" });
          staffCache = staffCache.filter((s) => s._id !== id);
          renderStaff();
          showToast("ƒê√£ x√≥a nh√¢n vi√™n");
        } catch (err) {
          showToast("Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n: " + err.message, true);
        }
      };

      // === TREES (owner / staff) ===
      async function loadTrees() {
        try {
          const trees = await apiFetch("/api/trees", {
            method: "GET",
          });
          treesCache = trees || [];
          renderTrees();
        } catch (err) {
          showToast("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¢y: " + err.message, true);
        }
      }

      function renderTrees(filterHealth = "all") {
        const body = document.getElementById("tree-table-body");
        if (!treesCache || treesCache.length === 0) {
          body.innerHTML =
            '<tr><td colspan="9" class="empty-text">Ch∆∞a c√≥ c√¢y n√†o trong v∆∞·ªùn.</td></tr>';
          document.getElementById("stat-total-trees").textContent = "0";
          document.getElementById("stat-bad-trees").textContent = "0";
          return;
        }

        let filtered = treesCache;
        if (filterHealth !== "all") {
          filtered = treesCache.filter((t) => t.currentHealth === filterHealth);
        }

        if (!filtered.length) {
          body.innerHTML =
            '<tr><td colspan="9" class="empty-text">Kh√¥ng c√≥ c√¢y n√†o kh·ªõp b·ªô l·ªçc.</td></tr>';
        } else {
          body.innerHTML = filtered
            .map((tree) => {
              const id = tree.numericId || "";
              const name = tree.name || "";
              const species = tree.species || "";
              const location = tree.location || "";
              const health = tree.currentHealth || "";
              const diseases = (tree.diseases || []).join(", ");
              const updated =
                (tree.updatedAt && tree.updatedAt.slice(0, 10)) || "";
              const isOwner =
                currentUser &&
                currentUser.role === "owner" &&
                tree.owner &&
                tree.owner._id === currentUser.id;

              return `
          <tr>
            <td>${id}</td>
            <td>${name}</td>
            <td>${species}</td>
            <td>${location}</td>
            <td>${health}</td>
            <td>${diseases || "‚Äî"}</td>
            <td>
              ${
                tree.qrCode
                  ? `<button class="btn-table" type="button" onclick="openQrModal('${tree._id}')">QR</button>`
                  : '<span class="qr-thumb-empty">Ch∆∞a c√≥</span>'
              }
            </td>
            <td>${updated}</td>
            <td>
              <button class="btn-table" type="button" onclick="updateTreePrompt('${tree._id}')">
                T√¨nh tr·∫°ng
              </button>
              <button class="btn-table" type="button" onclick="openDiseaseModal('${tree._id}')">
                B·ªánh
              </button>
              <button class="btn-table" type="button" onclick="openYieldModal('${tree._id}')">
                NƒÉng su·∫•t
              </button>
              <button class="btn-table" type="button" onclick="openLogsModal('${tree._id}')">
                L·ªãch s·ª≠
              </button>
              ${
                isOwner
                  ? `
              <button class="btn-table danger-btn" type="button" onclick="deleteTree('${tree._id}')">
                X√≥a
              </button>
              `
                  : ""
              }
            </td>
          </tr>
        `;
            })
            .join("");
        }

        document.getElementById("stat-total-trees").textContent =
          treesCache.length.toString();
        const badCount = treesCache.filter((t) =>
          ["Y·∫øu", "Nguy hi·ªÉm"].includes(t.currentHealth)
        ).length;
        document.getElementById("stat-bad-trees").textContent =
          badCount.toString();

        const heroNameEl = document.getElementById("farm-hero-name");
        const heroDescEl = document.getElementById("farm-hero-desc");
        if (currentUser && currentUser.role === "owner") {
          heroNameEl.textContent =
            currentUser.farmName || "V∆∞·ªùn s·∫ßu ri√™ng Thanh Huy·ªÅn";
          heroDescEl.textContent = `Ch·ªß v∆∞·ªùn: ${currentUser.username}`;
        } else if (currentUser && currentUser.role === "staff") {
          heroNameEl.textContent =
            currentUser.farmName || "V∆∞·ªùn s·∫ßu ri√™ng Thanh Huy·ªÅn";
          heroDescEl.textContent = `Nh√¢n vi√™n: ${currentUser.username}`;
        }
      }

      document.querySelectorAll(".pill-filter").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".pill-filter")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const h = btn.getAttribute("data-health");
          renderTrees(h || "all");
        });
      });

      // t·∫°o c√¢y
      document
        .getElementById("create-tree-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentUser || currentUser.role !== "owner") {
            showToast("Ch·ªâ ch·ªß v∆∞·ªùn m·ªõi ƒë∆∞·ª£c t·∫°o c√¢y m·ªõi", true);
            return;
          }
          const name = document.getElementById("tree-name").value.trim();
          const species = document.getElementById("tree-species").value.trim();
          const location = document.getElementById("tree-location").value.trim();
          const plantDate = document
            .getElementById("tree-plant-date")
            .value.trim();

          if (!name) {
            showToast("Vui l√≤ng nh·∫≠p t√™n c√¢y", true);
            return;
          }

          try {
            const newTree = await apiFetch("/api/trees", {
              method: "POST",
              body: JSON.stringify({
                name,
                species,
                location,
                plantDate,
              }),
            });
            showToast("T·∫°o c√¢y th√†nh c√¥ng");
            treesCache.unshift(newTree);
            renderTrees(
              document.querySelector(".pill-filter.active").dataset.health ||
                "all"
            );
            e.target.reset();
          } catch (err) {
            showToast("Kh√¥ng th·ªÉ t·∫°o c√¢y: " + err.message, true);
          }
        });

      // update tree health
      window.updateTreePrompt = async function (id) {
        const tree = treesCache.find((t) => t._id === id);
        if (!tree) return;
        const health = prompt(
          "Nh·∫≠p t√¨nh tr·∫°ng (T·ªët / B√¨nh th∆∞·ªùng / Y·∫øu / Nguy hi·ªÉm):",
          tree.currentHealth || "B√¨nh th∆∞·ªùng"
        );
        if (!health) return;
        const notes = prompt("Ghi ch√∫ chƒÉm s√≥c:", tree.notes || "");
        try {
          const updated = await apiFetch(`/api/trees/${id}/health`, {
            method: "PATCH",
            body: JSON.stringify({ currentHealth: health, notes }),
          });
          showToast("ƒê√£ c·∫≠p nh·∫≠t c√¢y");
          const idx = treesCache.findIndex((t) => t._id === id);
          if (idx >= 0) treesCache[idx] = updated.tree;
          renderTrees(
            document.querySelector(".pill-filter.active").dataset.health ||
              "all"
          );
        } catch (err) {
          showToast("L·ªói c·∫≠p nh·∫≠t c√¢y: " + err.message, true);
        }
      };

      // delete tree
      window.deleteTree = async function (id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° c√¢y n√†y?")) return;
        try {
          await apiFetch(`/api/trees/${id}`, { method: "DELETE" });
          treesCache = treesCache.filter((t) => t._id !== id);
          renderTrees(
            document.querySelector(".pill-filter.active").dataset.health ||
              "all"
          );
          showToast("ƒê√£ xo√° c√¢y");
        } catch (err) {
          showToast("Kh√¥ng th·ªÉ xo√° c√¢y: " + err.message, true);
        }
      };

      // QR modal
      window.openQrModal = function (id) {
        const tree = treesCache.find((t) => t._id === id);
        if (!tree) return;
        const modal = document.getElementById("qr-modal-backdrop");
        const img = document.getElementById("qr-modal-img");
        const nameEl = document.getElementById("qr-tree-name");
        const locationEl = document.getElementById("qr-tree-location");
        const ownerEl = document.getElementById("qr-tree-owner");

        img.src = tree.qrCode || "";
        nameEl.textContent = tree.name || "‚Äî";
        locationEl.textContent = tree.location || "‚Äî";

        const ownerName =
          (tree.owner && (tree.owner.farmName || tree.owner.username)) ||
          (currentUser && currentUser.farmName) ||
          (currentUser && currentUser.username) ||
          "‚Äî";
        ownerEl.textContent = ownerName;

        modal.classList.add("show");
      };

      document
        .getElementById("qr-modal-close")
        .addEventListener("click", () => {
          document
            .getElementById("qr-modal-backdrop")
            .classList.remove("show");
        });
      document
        .getElementById("qr-modal-backdrop")
        .addEventListener("click", (e) => {
          if (e.target.id === "qr-modal-backdrop") {
            document
              .getElementById("qr-modal-backdrop")
              .classList.remove("show");
          }
        });

      // === DISEASE MODAL ===
      function fillDiseaseSelect(selectedDiseases) {
        const select = document.getElementById("disease-select");
        select.innerHTML = "";
        diseaseMasterList.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          if (selectedDiseases.includes(d)) opt.selected = true;
          select.appendChild(opt);
        });
      }

      window.openDiseaseModal = function (treeId) {
        const tree = treesCache.find((t) => t._id === treeId);
        if (!tree) return;
        currentTreeForDisease = tree;
        (tree.diseases || []).forEach((d) => {
          if (d && !diseaseMasterList.includes(d)) {
            diseaseMasterList.push(d);
          }
        });
        fillDiseaseSelect(tree.diseases || []);
        document.getElementById("new-disease-input").value = "";
        document
          .getElementById("disease-modal-backdrop")
          .classList.add("show");
      };

      document
        .getElementById("disease-modal-close")
        .addEventListener("click", () => {
          document
            .getElementById("disease-modal-backdrop")
            .classList.remove("show");
        });
      document
        .getElementById("disease-modal-backdrop")
        .addEventListener("click", (e) => {
          if (e.target.id === "disease-modal-backdrop") {
            document
              .getElementById("disease-modal-backdrop")
              .classList.remove("show");
          }
        });

      document
        .getElementById("add-disease-btn")
        .addEventListener("click", () => {
          const input = document
            .getElementById("new-disease-input")
            .value.trim();
          if (!input) return;
          if (!diseaseMasterList.includes(input)) {
            diseaseMasterList.push(input);
          }
          fillDiseaseSelect(
            currentTreeForDisease ? currentTreeForDisease.diseases || [] : []
          );
          document.getElementById("new-disease-input").value = "";
        });

      document
        .getElementById("save-disease-btn")
        .addEventListener("click", async () => {
          if (!currentTreeForDisease) return;
          const select = document.getElementById("disease-select");
          const values = Array.from(select.selectedOptions).map(
            (o) => o.value
          );
          try {
            const updated = await apiFetch(
              `/api/trees/${currentTreeForDisease._id}/diseases`,
              {
                method: "PATCH",
                body: JSON.stringify({ diseases: values }),
              }
            );
            showToast("ƒê√£ c·∫≠p nh·∫≠t b·ªánh cho c√¢y");
            const idx = treesCache.findIndex(
              (t) => t._id === currentTreeForDisease._id
            );
            if (idx >= 0) treesCache[idx] = updated.tree;
            renderTrees(
              document.querySelector(".pill-filter.active").dataset.health ||
                "all"
            );
            document
              .getElementById("disease-modal-backdrop")
              .classList.remove("show");
          } catch (err) {
            showToast("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b·ªánh: " + err.message, true);
          }
        });

      // === YIELD MODAL (nƒÉng su·∫•t, bi·ªÉu ƒë·ªì) ===
      function renderYieldForTree(tree) {
        const listEl = document.getElementById("yield-list");
        const canvas = document.getElementById("yield-chart");
        const ctx = canvas.getContext("2d");

        const history = (tree.yieldHistory || []).slice().sort((a, b) => {
          return a.year - b.year;
        });

        if (!history.length) {
          listEl.innerHTML =
            '<div class="muted small">Ch∆∞a c√≥ d·ªØ li·ªáu nƒÉng su·∫•t. Th√™m ·ªü b√™n tr√™n.</div>';
        } else {
          listEl.innerHTML =
            "<div class='muted small'>D·ªØ li·ªáu hi·ªán t·∫°i:</div>" +
            "<ul class='yield-ul'>" +
            history
              .map(
                (h) => `<li>${h.year}: <strong>${h.quantity} kg</strong></li>`
              )
              .join("") +
            "</ul>";
        }

        const labels = history.map((h) => h.year);
        const data = history.map((h) => h.quantity);

        if (currentYieldChart) {
          currentYieldChart.destroy();
        }

        currentYieldChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "NƒÉng su·∫•t (kg)",
                data,
                backgroundColor: "rgba(22, 163, 74, 0.7)",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      window.openYieldModal = function (treeId) {
        const tree = treesCache.find((t) => t._id === treeId);
        if (!tree) return;
        currentTreeForYield = tree;
        document.getElementById("yield-year-input").value = "";
        document.getElementById("yield-qty-input").value = "";
        renderYieldForTree(tree);
        document
          .getElementById("yield-modal-backdrop")
          .classList.add("show");
      };

      document
        .getElementById("yield-modal-close")
        .addEventListener("click", () => {
          document
            .getElementById("yield-modal-backdrop")
            .classList.remove("show");
        });
      document
        .getElementById("yield-modal-backdrop")
        .addEventListener("click", (e) => {
          if (e.target.id === "yield-modal-backdrop") {
            document
              .getElementById("yield-modal-backdrop")
              .classList.remove("show");
          }
        });

      document
        .getElementById("add-yield-btn")
        .addEventListener("click", async () => {
          if (!currentTreeForYield) return;
          const year = document
            .getElementById("yield-year-input")
            .value.trim();
          const quantity = document
            .getElementById("yield-qty-input")
            .value.trim();
          if (!year || !quantity) {
            showToast("Vui l√≤ng nh·∫≠p nƒÉm v√† s·ªë kg", true);
            return;
          }
          try {
            const updated = await apiFetch(
              `/api/trees/${currentTreeForYield._id}/yield`,
              {
                method: "POST",
                body: JSON.stringify({ year, quantity }),
              }
            );
            showToast("ƒê√£ l∆∞u nƒÉng su·∫•t");
            const idx = treesCache.findIndex(
              (t) => t._id === currentTreeForYield._id
            );
            if (idx >= 0) treesCache[idx] = updated.tree;
            currentTreeForYield = updated.tree;
            renderYieldForTree(updated.tree);
            renderTrees(
              document.querySelector(".pill-filter.active").dataset.health ||
                "all"
            );
          } catch (err) {
            showToast("Kh√¥ng th·ªÉ l∆∞u nƒÉng su·∫•t: " + err.message, true);
          }
        });

      // === LOGS MODAL ===
      window.openLogsModal = async function (treeId) {
        const backdrop = document.getElementById("logs-modal-backdrop");
        const listEl = document.getElementById("logs-list");
        listEl.innerHTML = "ƒêang t·∫£i l·ªãch s·ª≠...";
        backdrop.classList.add("show");
        try {
          const logs = await apiFetch(`/api/trees/${treeId}/logs`, {
            method: "GET",
          });
          if (!logs.length) {
            listEl.innerHTML =
              "<div class='muted small'>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi l·∫°i.</div>";
           
