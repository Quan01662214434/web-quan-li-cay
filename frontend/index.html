<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n l√Ω c√¢y trong v∆∞·ªùn - thefram.site</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div class="app-shell">
    <header>
      <div>
        <div class="title">
          <span class="logo">F</span>
          <div>
            <div>Qu·∫£n l√Ω c√¢y trong v∆∞·ªùn</div>
            <div class="subtitle">thefram.site ¬∑ Qu·∫£n l√Ω s·∫ßu ri√™ng, b∆∞·ªüi, m√≠t b·∫±ng m√£ QR</div>
          </div>
        </div>
      </div>
      <div class="pill">API: api.thefram.site</div>
    </header>

    <main>
      <!-- H√ÄNG TH·ªêNG K√ä -->
      <section class="stats-row">
        <div class="card stat-card">
          <div class="stat-label">T·ªïng s·ªë c√¢y</div>
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-sub">T·∫•t c·∫£ gi·ªëng trong v∆∞·ªùn</div>
        </div>
        <div class="card stat-card stat-good">
          <div class="stat-label">C√¢y kho·∫ª</div>
          <div class="stat-value" id="stat-good">0</div>
          <div class="stat-sub">T√¨nh tr·∫°ng "T·ªët"</div>
        </div>
        <div class="card stat-card stat-warn">
          <div class="stat-label">C·∫ßn theo d√µi</div>
          <div class="stat-value" id="stat-mid">0</div>
          <div class="stat-sub">B√¨nh th∆∞·ªùng / Y·∫øu</div>
        </div>
        <div class="card stat-card stat-danger">
          <div class="stat-label">Nguy hi·ªÉm</div>
          <div class="stat-value" id="stat-bad">0</div>
          <div class="stat-sub">C·∫ßn x·ª≠ l√Ω s·ªõm</div>
        </div>
      </section>

      <!-- H√ÄNG BI·ªÇU ƒê·ªí -->
      <section class="charts-row">
        <div class="card chart-card">
          <div class="card-header">
            <div>
              <div class="card-title">T√¨nh tr·∫°ng s·ª©c kh·ªèe v∆∞·ªùn c√¢y</div>
              <div class="card-desc">Ph√¢n b·ªë c√¢y theo t√¨nh tr·∫°ng hi·ªán t·∫°i.</div>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="healthChart"></canvas>
          </div>
        </div>

        <div class="card chart-card">
          <div class="card-header">
            <div>
              <div class="card-title">Ph√¢n b·ªë theo gi·ªëng c√¢y</div>
              <div class="card-desc">S·∫ßu ri√™ng, b∆∞·ªüi, m√≠t, xo√†i...</div>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="speciesChart"></canvas>
          </div>
        </div>
      </section>

      <!-- LAYOUT FORM + DANH S√ÅCH -->
      <div class="layout-grid">
        <!-- FORM T·∫†O C√ÇY -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Th√™m c√¢y m·ªõi</div>
              <div class="card-desc">ƒêi·ªÅn th√¥ng tin c∆° b·∫£n, h·ªá th·ªëng t·ª± t·∫°o ID & m√£ QR.</div>
            </div>
            <div class="card-actions">
              <span class="small-badge">ID s·ªë t·ª± ƒë·ªông</span>
            </div>
          </div>

          <form id="create-form">
            <div class="field-row">
              <div>
                <label>T√™n c√¢y *</label>
                <input id="name" type="text" required placeholder="V√≠ d·ª•: S·∫ßu ri√™ng A01" />
              </div>
              <div>
                <label>Gi·ªëng c√¢y</label>
                <input id="species" type="text" placeholder="Ri6, Monthong, B∆∞·ªüi da xanh..." />
              </div>
            </div>

            <div class="field-row-3" style="margin-top:10px;">
              <div>
                <label>V·ªã tr√≠ trong v∆∞·ªùn</label>
                <input id="location" type="text" placeholder="L√¥ A1 - H√†ng 3 - C√¢y 5" />
              </div>
              <div>
                <label>Ng√†y tr·ªìng</label>
                <input id="plantDate" type="date" />
              </div>
              <div>
                <label>T√¨nh tr·∫°ng ban ƒë·∫ßu</label>
                <select id="currentHealth">
                  <option value="T·ªët">T·ªët</option>
                  <option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
                  <option value="Y·∫øu">Y·∫øu</option>
                  <option value="Nguy hi·ªÉm">Nguy hi·ªÉm</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label>Ghi ch√∫</label>
              <textarea id="notes" placeholder="Ghi ch√∫: tu·ªïi c√¢y, gi·ªëng, l·∫ßn b√≥n ph√¢n g·∫ßn nh·∫•t..."></textarea>
            </div>

            <div class="status-bar">
              <div style="display:flex; align-items:center;">
                <span class="status-dot"></span>
                <span id="status-text" class="muted">S·∫µn s√†ng t·∫°o c√¢y m·ªõi.</span>
              </div>
              <button type="submit" class="primary" id="create-btn">‚ûï T·∫°o c√¢y</button>
            </div>
          </form>
        </section>

        <!-- DANH S√ÅCH C√ÇY -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Danh s√°ch c√¢y</div>
              <div class="card-desc">C·∫≠p nh·∫≠t s·ª©c kh·ªèe, ghi ch√∫ & m√£ QR cho t·ª´ng c√¢y.</div>
            </div>
            <div class="card-actions">
              <span id="tree-count" class="small-badge">ƒêang t·∫£i...</span>
            </div>
          </div>

          <div class="toolbar">
            <div>
              <input id="search-input" type="text" placeholder="T√¨m theo t√™n, gi·ªëng, v·ªã tr√≠..." />
            </div>
            <div class="muted" id="last-updated-text"></div>
          </div>

          <div style="max-height: 420px; overflow:auto; border-radius: 10px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Th√¥ng tin c√¢y</th>
                  <th>T√¨nh tr·∫°ng hi·ªán t·∫°i</th>
                  <th>QR</th>
                  <th style="width:220px;">C·∫≠p nh·∫≠t s·ª©c kh·ªèe</th>
                </tr>
              </thead>
              <tbody id="tree-table-body"></tbody>
            </table>

            <div id="empty-state" class="empty-state" style="display:none;">
              <span>üå±</span>
              Ch∆∞a c√≥ c√¢y n√†o. H√£y b·∫Øt ƒë·∫ßu b·∫±ng vi·ªác th√™m c√¢y m·ªõi ·ªü khung b√™n tr√°i.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ================= C·∫§U H√åNH API =================
    const API_BASE = "https://api.thefram.site";

    const createForm = document.getElementById("create-form");
    const createBtn = document.getElementById("create-btn");
    const statusText = document.getElementById("status-text");
    const treeTableBody = document.getElementById("tree-table-body");
    const treeCount = document.getElementById("tree-count");
    const emptyState = document.getElementById("empty-state");
    const toast = document.getElementById("toast");
    const searchInput = document.getElementById("search-input");
    const lastUpdatedText = document.getElementById("last-updated-text");

    // Stats elements
    const statTotal = document.getElementById("stat-total");
    const statGood  = document.getElementById("stat-good");
    const statMid   = document.getElementById("stat-mid");
    const statBad   = document.getElementById("stat-bad");

    let allTrees = [];
    let healthChart = null;
    let speciesChart = null;

    function showToast(message, type = "success") {
      toast.textContent = message;
      toast.className = "toast " + type;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2600);
    }

    function healthBadgeClass(health) {
      if (health === "T·ªët") return "badge good";
      if (health === "B√¨nh th∆∞·ªùng") return "badge medium";
      return "badge bad";
    }

    function formatDate(dateStr) {
      if (!dateStr) return "‚Äî";
      const d = new Date(dateStr);
      return Number.isNaN(d.getTime()) ? dateStr : d.toLocaleDateString("vi-VN");
    }

    function setLastUpdated() {
      lastUpdatedText.textContent = "C·∫≠p nh·∫≠t: " + new Date().toLocaleTimeString("vi-VN");
    }

    async function loadTrees() {
      try {
        treeCount.textContent = "ƒêang t·∫£i...";
        const res = await fetch(\`\${API_BASE}/api/trees\`);
        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¢y");
        const data = await res.json();
        allTrees = data;
        updateSummary(data);
        updateCharts(data);
        renderTreeTable(data);
        setLastUpdated();
      } catch (err) {
        console.error(err);
        treeCount.textContent = "L·ªói t·∫£i d·ªØ li·ªáu";
        showToast("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¢y", "error");
      }
    }

    function updateSummary(trees) {
      const total = trees.length;
      const good = trees.filter(t => t.currentHealth === "T·ªët").length;
      const normal = trees.filter(t => t.currentHealth === "B√¨nh th∆∞·ªùng").length;
      const weak = trees.filter(t => t.currentHealth === "Y·∫øu").length;
      const danger = trees.filter(t => t.currentHealth === "Nguy hi·ªÉm").length;

      statTotal.textContent = total;
      statGood.textContent  = good;
      statMid.textContent   = normal + weak;
      statBad.textContent   = danger;
    }

    function updateCharts(trees) {
      // ---- Chart 1: Health distribution ----
      const labelsHealth = ["T·ªët", "B√¨nh th∆∞·ªùng", "Y·∫øu", "Nguy hi·ªÉm"];
      const countsHealth = labelsHealth.map(label =>
        trees.filter(t => (t.currentHealth || "") === label).length
      );

      const healthCtx = document.getElementById("healthChart").getContext("2d");
      if (!healthChart) {
        healthChart = new Chart(healthCtx, {
          type: "doughnut",
          data: {
            labels: labelsHealth,
            datasets: [{
              data: countsHealth,
            }]
          },
          options: {
            plugins: {
              legend: {
                labels: { color: "#e5e7eb", font: { size: 11 } }
              }
            }
          }
        });
      } else {
        healthChart.data.datasets[0].data = countsHealth;
        healthChart.update();
      }

      // ---- Chart 2: Species distribution ----
      const speciesMap = {};
      trees.forEach(t => {
        const key = (t.species && t.species.trim()) || "Ch∆∞a nh·∫≠p gi·ªëng";
        speciesMap[key] = (speciesMap[key] || 0) + 1;
      });

      const labelsSpecies = Object.keys(speciesMap);
      const countsSpecies = Object.values(speciesMap);

      const speciesCtx = document.getElementById("speciesChart").getContext("2d");
      if (!speciesChart) {
        speciesChart = new Chart(speciesCtx, {
          type: "bar",
          data: {
            labels: labelsSpecies,
            datasets: [{
              data: countsSpecies,
            }]
          },
          options: {
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: {
                ticks: { color: "#e5e7eb", font: { size: 11 } },
                grid: { display: false }
              },
              y: {
                ticks: { color: "#9ca3af", font: { size: 11 }, precision: 0 },
                grid: { color: "#1f2937" }
              }
            }
          }
        });
      } else {
        speciesChart.data.labels = labelsSpecies;
        speciesChart.data.datasets[0].data = countsSpecies;
        speciesChart.update();
      }
    }

    function renderTreeTable(trees) {
      treeTableBody.innerHTML = "";
      if (!trees.length) {
        emptyState.style.display = "block";
        treeCount.textContent = "0 c√¢y";
        return;
      }

      emptyState.style.display = "none";
      treeCount.textContent = \`\${trees.length} c√¢y\`;

      for (const tree of trees) {
        const tr = document.createElement("tr");
        tr.dataset.id = tree._id;
        tr.innerHTML = \`
          <td>#\${tree.numericId ?? "‚Äî"}</td>
          <td>
            <div style="font-weight:500;">\${tree.name}</div>
            <div class="muted">Gi·ªëng: \${tree.species || "‚Äî"}</div>
            <div class="muted">V·ªã tr√≠: \${tree.location || "‚Äî"}</div>
            <div class="muted">Ng√†y tr·ªìng: \${formatDate(tree.plantDate)}</div>
          </td>
          <td>
            <span class="\${healthBadgeClass(tree.currentHealth)}">\${tree.currentHealth || "Ch∆∞a r√µ"}</span>
            <div class="muted" style="margin-top:4px; max-width:160px;">
              \${tree.notes ? tree.notes : "<i>Ch∆∞a c√≥ ghi ch√∫</i>"}
            </div>
          </td>
          <td>
            \${tree.qrCode
              ? \`<img src="\${tree.qrCode}" class="qr-thumb" alt="QR" title="Nh·∫•p ƒë·ªÉ m·ªü l·ªõn" />\`
              : \`<span class="qr-thumb-empty">Ch∆∞a c√≥ QR</span>\`}
          </td>
          <td>
            <div style="margin-bottom:6px;">
              <select class="health-select">
                <option value="T·ªët" \${tree.currentHealth === "T·ªët" ? "selected" : ""}>T·ªët</option>
                <option value="B√¨nh th∆∞·ªùng" \${tree.currentHealth === "B√¨nh th∆∞·ªùng" ? "selected" : ""}>B√¨nh th∆∞·ªùng</option>
                <option value="Y·∫øu" \${tree.currentHealth === "Y·∫øu" ? "selected" : ""}>Y·∫øu</option>
                <option value="Nguy hi·ªÉm" \${tree.currentHealth === "Nguy hi·ªÉm" ? "selected" : ""}>Nguy hi·ªÉm</option>
              </select>
            </div>
            <div style="margin-bottom:6px;">
              <textarea class="notes-input" placeholder="Ghi ch√∫ th√™m cho ƒë·ª£t ki·ªÉm tra n√†y...">\${tree.notes || ""}</textarea>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="primary sm save-btn" type="button">üíæ L∆∞u</button>
              <button class="danger sm delete-btn" type="button">üóë Xo√°</button>
            </div>
          </td>
        \`;
        treeTableBody.appendChild(tr);
      }
    }

    // L·ªçc theo t·ª´ kho√°
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.trim().toLowerCase();
      if (!q) return renderTreeTable(allTrees);
      const filtered = allTrees.filter(t =>
        [t.name, t.species, t.location].some(v => (v || "").toLowerCase().includes(q))
      );
      renderTreeTable(filtered);
    });

    // X·ª≠ l√Ω click trong b·∫£ng (save / delete / xem QR)
    treeTableBody.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      if (!tr) return;
      const id = tr.dataset.id;

      if (e.target.classList.contains("qr-thumb")) {
        const src = e.target.getAttribute("src");
        const win = window.open();
        win.document.write(\`<img src="\${src}" style="max-width:100%;"/>\`);
        return;
      }

      if (e.target.classList.contains("save-btn")) {
        const select = tr.querySelector(".health-select");
        const notesInput = tr.querySelector(".notes-input");
        const currentHealth = select.value;
        const notes = notesInput.value.trim();

        try {
          e.target.disabled = true;
          e.target.textContent = "ƒêang l∆∞u...";
          const res = await fetch(\`\${API_BASE}/api/trees/\${id}/health\`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ currentHealth, notes }),
          });
          if (!res.ok) throw new Error("L∆∞u th·∫•t b·∫°i");
          showToast("ƒê√£ c·∫≠p nh·∫≠t s·ª©c kh·ªèe c√¢y", "success");
          await loadTrees();
        } catch {
          showToast("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√¢y", "error");
        } finally {
          e.target.disabled = false;
          e.target.textContent = "üíæ L∆∞u";
        }
        return;
      }

      if (e.target.classList.contains("delete-btn")) {
        const tree = allTrees.find(t => t._id === id);
        if (!confirm(\`B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° c√¢y "\${tree ? tree.name : ""}"?\`)) return;
        try {
          e.target.disabled = true;
          e.target.textContent = "ƒêang xo√°...";
          const res = await fetch(\`\${API_BASE}/api/trees/\${id}\`, { method: "DELETE" });
          if (!res.ok) throw new Error("Xo√° th·∫•t b·∫°i");
          showToast("ƒê√£ xo√° c√¢y kh·ªèi h·ªá th·ªëng", "success");
          await loadTrees();
        } catch {
          showToast("Kh√¥ng th·ªÉ xo√° c√¢y", "error");
        } finally {
          e.target.disabled = false;
          e.target.textContent = "üóë Xo√°";
        }
      }
    });

    // T·∫°o c√¢y m·ªõi
    createForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const species = document.getElementById("species").value.trim();
      const location = document.getElementById("location").value.trim();
      const plantDate = document.getElementById("plantDate").value;
      const currentHealth = document.getElementById("currentHealth").value;
      const notes = document.getElementById("notes").value.trim();
      if (!name) return showToast("Vui l√≤ng nh·∫≠p t√™n c√¢y", "error");

      try {
        createBtn.disabled = true;
        statusText.textContent = "ƒêang t·∫°o c√¢y...";
        const res = await fetch(\`\${API_BASE}/api/trees\`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, species, location, plantDate, currentHealth, notes }),
        });
        if (!res.ok) throw new Error("T·∫°o c√¢y th·∫•t b·∫°i");
        const created = await res.json();
        showToast("ƒê√£ t·∫°o c√¢y m·ªõi #" + created.numericId, "success");
        createForm.reset();
        document.getElementById("currentHealth").value = "T·ªët";
        statusText.textContent = "ƒê√£ t·∫°o c√¢y, b·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c th√™m c√¢y kh√°c.";
        await loadTrees();
      } catch {
        showToast("Kh√¥ng th·ªÉ t·∫°o c√¢y m·ªõi", "error");
        statusText.textContent = "C√≥ l·ªói khi t·∫°o c√¢y, vui l√≤ng th·ª≠ l·∫°i.";
      } finally {
        createBtn.disabled = false;
      }
    });

    // Kh·ªüi ƒë·ªông
    loadTrees();
  </script>
</body>
</html>
