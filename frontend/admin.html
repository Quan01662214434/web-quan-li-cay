<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Portal - thefram.site</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2907/2907253.png" />
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --accent: #22c55e;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #020617 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 40px 16px;
    }

    .card {
      width: 100%;
      max-width: 900px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px 28px 30px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
    }

    h1 {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      color: var(--text);
      font-size: 13px;
      padding: 8px 10px;
      margin-bottom: 10px;
      outline: none;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25);
    }

    .btn {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.2);
      color: #fecaca;
      border: 1px solid rgba(239, 68, 68, 0.6);
    }

    .status {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      min-height: 16px;
    }

    .section {
      margin-bottom: 24px;
      border-top: 1px solid #1f2937;
      padding-top: 18px;
    }

    .preview {
      width: 100px;
      height: 100px;
      border: 1px dashed #4b5563;
      border-radius: 12px;
      background: #0f172a;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      background: #020617;
      border: 1px solid rgba(34, 197, 94, 0.7);
      border-radius: 999px;
      color: #bbf7d0;
      font-size: 14px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
    }

    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { border-color: rgba(239, 68, 68, 0.7); color: #fecaca; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Admin Portal</h1>
    <div class="subtitle">Tạo tài khoản chủ vườn và nhân viên · thefram.site</div>

    <!-- FORM LOGIN ADMIN -->
    <div class="section">
      <h3>Đăng nhập admin</h3>
      <label>Tài khoản admin</label>
      <input id="admin-username" placeholder="admin" />
      <label>Mật khẩu</label>
      <input id="admin-password" type="password" placeholder="••••••" />
      <button class="btn btn-primary" id="btn-login">Đăng nhập</button>
      <div class="status" id="login-status">Chưa đăng nhập.</div>
    </div>

    <!-- FORM TẠO TÀI KHOẢN -->
    <div class="section">
      <h3>Tạo tài khoản chủ vườn / nhân viên</h3>
      <label>Tên đăng nhập</label>
      <input id="username" placeholder="vd: vuon-long-an" />

      <label>Mật khẩu</label>
      <input id="password" type="password" placeholder="••••••" />

      <label>Vai trò</label>
      <select id="role">
        <option value="owner">Chủ vườn</option>
        <option value="staff">Nhân viên</option>
      </select>

      <label>Tên vườn (chỉ cho chủ vườn)</label>
      <input id="farm-name" placeholder="VD: Vườn sầu riêng Long An" />

      <label>Logo vườn (ảnh vuông)</label>
      <input type="file" id="farm-logo" accept="image/*" />
      <div class="preview" id="logo-preview">Chưa chọn</div>

      <label>Màu chủ đạo</label>
      <input id="farm-color" value="#22c55e" />

      <button class="btn btn-primary" id="btn-create" disabled>Tạo tài khoản</button>
      <div class="status" id="create-status">Vui lòng đăng nhập admin trước.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = "https://api.thefram.site";
    let adminToken = null;
    let logoBase64 = null;

    const showToast = (msg, error = false) => {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = "toast" + (error ? " error" : "");
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 3000);
    };

    // Đăng nhập admin
    document.getElementById("btn-login").addEventListener("click", async () => {
      const username = document.getElementById("admin-username").value.trim();
      const password = document.getElementById("admin-password").value.trim();
      const status = document.getElementById("login-status");
      try {
        status.textContent = "Đang đăng nhập...";
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Lỗi đăng nhập");

        if (data.user.role !== "admin") throw new Error("Không phải tài khoản admin");

        adminToken = data.token;
        document.getElementById("btn-create").disabled = false;
        status.innerHTML = "✅ Đăng nhập thành công!";
        showToast("Đăng nhập admin thành công!");
      } catch (err) {
        status.textContent = "❌ " + err.message;
        showToast(err.message, true);
      }
    });

    // Preview logo
    document.getElementById("farm-logo").addEventListener("change", (e) => {
      const file = e.target.files[0];
      const preview = document.getElementById("logo-preview");
      if (!file) {
        preview.textContent = "Chưa chọn";
        logoBase64 = null;
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        logoBase64 = reader.result;
        preview.innerHTML = `<img src="${logoBase64}" />`;
      };
      reader.readAsDataURL(file);
    });

    // Tạo tài khoản chủ vườn / nhân viên
    document.getElementById("btn-create").addEventListener("click", async () => {
      if (!adminToken) return showToast("Cần đăng nhập admin trước", true);

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const role = document.getElementById("role").value;
      const farmName = document.getElementById("farm-name").value.trim();
      const farmColor = document.getElementById("farm-color").value.trim();
      const status = document.getElementById("create-status");

      if (!username || !password) return showToast("Nhập tài khoản & mật khẩu", true);
      if (role === "owner" && !farmName) return showToast("Chủ vườn phải có tên vườn", true);

      try {
        status.textContent = "Đang tạo tài khoản...";
        const res = await fetch(`${API_BASE}/admin/users`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + adminToken,
          },
          body: JSON.stringify({
            username,
            password,
            role,
            farmName: farmName || null,
            farmLogo: logoBase64,
            farmPrimaryColor: farmColor || "#22c55e",
          }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Lỗi tạo tài khoản");

        status.textContent = `✅ Đã tạo ${data.user.username} (${data.user.role})`;
        showToast("Tạo tài khoản thành công!");
      } catch (err) {
        status.textContent = "❌ " + err.message;
        showToast(err.message, true);
      }
    });
  </script>
</body>
</html>
